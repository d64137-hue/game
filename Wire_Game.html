<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>„Ç§„É©„Ç§„É©Ê£í„Ç≤„Éº„É†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body {
      background: #222;
      color: white;
      text-align: center;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      transition: background-color 0.1s;
    }
    canvas {
      background: #eee;
      display: block;
      margin: 0; 
      border: 1px solid #555;
      touch-action: none;
      transition: box-shadow 0.2s;
    }
    .game-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        max-width: 600px;
        margin: 20px auto;
        background: #333;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .info-area {
        margin-top: 10px;
        font-size: 14px;
        color: #ddd;
    }
    .home-button {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #03A9F4; /* Èùí */
        color: white;
        border: none;
        cursor: pointer;
        font-size: 16px;
        border-radius: 5px;
    }
    /* ‰ª•Ââç„ÅÆ„Éú„Çø„É≥/„É™„É≥„ÇØ„ÅÆ„Çπ„Çø„Ç§„É´„ÅØÂâäÈô§ */
  </style>
</head>
<body>
  <div class="game-container">
    <h1 style="color: #FFEB3B; margin-top: 0;">„Ç§„É©„Ç§„É©Ê£í„Ç≤„Éº„É†</h1>
    <canvas id="gameCanvas" width="500" height="500"></canvas>
    
    <div class="info-area">
        <p>„Çπ„Ç≥„Ç¢: <span id="scoreDisplay">0</span> (ÊúÄÈ´ò„Çπ„Ç≥„Ç¢: <span id="highScoreDisplay">0</span>)</p>
        <p>„Ç≠„Éº: **Áü¢Âç∞** or **WASD** or **IJKL** „ÅßÁßªÂãï („Çø„ÉÉ„ÉÅ„Çπ„ÉØ„Ç§„ÉóÂØæÂøú)</p>
    </div>

    <button id="resetButton" onclick="initGame()">„É™„Éà„É©„Ç§</button>
    <button class="home-button" onclick="location.href='Game_Portal.html'">
        „Éõ„Éº„É†„Å∏Êàª„Çã
    </button>
  </div>

  <script>
    // --- Â§âÊï∞ÂÆöÁæ© ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const highScoreDisplay = document.getElementById('highScoreDisplay');

    const WIDTH = canvas.width;
    const HEIGHT = canvas.height;
    const GRID_SIZE = 50; // „Éû„Çπ„ÅÆ„Çµ„Ç§„Ç∫
    const PLAYER_SIZE = 10;
    const WALL_WIDTH = 2; // Â£Å„ÅÆÂ§™„Åï

    let playerX, playerY;
    let isGameOver = false;
    let score = 0;
    let highScore = localStorage.getItem('wireGameHighScore') || 0;
    let touchStartX, touchStartY;
    let gameLoopId;

    // „Éû„ÉÉ„Éó„Éá„Éº„Çø (1: Â£Å, 0: ÈÄöË∑Ø, 2: „Çπ„Çø„Éº„Éà, 3: „Ç¥„Éº„É´)
    const map = [
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      [1, 2, 0, 0, 0, 0, 0, 0, 0, 1],
      [1, 0, 1, 1, 1, 1, 0, 1, 0, 1],
      [1, 0, 1, 0, 0, 0, 0, 1, 0, 1],
      [1, 0, 1, 0, 1, 1, 1, 1, 0, 1],
      [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
      [1, 1, 1, 1, 1, 0, 1, 1, 1, 1],
      [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
      [1, 0, 1, 1, 1, 1, 1, 1, 0, 3],
      [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
    ];
    
    const MAP_COLS = map[0].length;
    const MAP_ROWS = map.length;

    // --- „Ç≤„Éº„É†ÂàùÊúüÂåñ ---
    function initGame() {
        // „Çπ„Çø„Éº„ÉàÂú∞ÁÇπ„ÇíÊé¢„Åô
        let startPos = findPosition(2);
        playerX = startPos.col * GRID_SIZE + GRID_SIZE / 2;
        playerY = startPos.row * GRID_SIZE + GRID_SIZE / 2;
        
        isGameOver = false;
        score = 0;
        document.body.style.backgroundColor = '#222';
        canvas.style.boxShadow = '0 0 0 rgba(255, 0, 0, 0)';
        
        updateScoreDisplay();

        if (gameLoopId) cancelAnimationFrame(gameLoopId);
        gameLoopId = requestAnimationFrame(gameLoop);
    }

    // --- „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ ---

    function findPosition(type) {
        for (let r = 0; r < MAP_ROWS; r++) {
            for (let c = 0; c < MAP_COLS; c++) {
                if (map[r][c] === type) {
                    return { row: r, col: c };
                }
            }
        }
        return { row: 1, col: 1 }; // Ë¶ã„Å§„Åã„Çâ„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÅÆ„Éá„Éï„Ç©„É´„Éà
    }

    function movePlayer(dx, dy) {
        if (isGameOver) return;
        
        let newX = playerX + dx * PLAYER_SIZE;
        let newY = playerY + dy * PLAYER_SIZE;

        // Â£Å„Å®„ÅÆË°ùÁ™ÅÂà§ÂÆö („Çà„ÇäÁ≤æÂØÜ„Å´)
        if (!isCollidingWithWall(newX, newY)) {
            playerX = newX;
            playerY = newY;
            
            // „Çπ„Ç≥„Ç¢„ÇíÂä†ÁÆó (ÁßªÂãïË∑ùÈõ¢„Å´Âøú„Åò„Å¶)
            score += 1; 

            // „Ç¥„Éº„É´Âà§ÂÆö
            const goalPos = findPosition(3);
            const playerGridX = Math.floor(playerX / GRID_SIZE);
            const playerGridY = Math.floor(playerY / GRID_SIZE);
            
            if (playerGridX === goalPos.col && playerGridY === goalPos.row) {
                gameOver(true); // „Ç≤„Éº„É†„ÇØ„É™„Ç¢
            }
        } else {
            // Â£Å„Å´„Å∂„Å§„Åã„Å£„Åü„ÇâÂç≥„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº
            gameOver(false);
        }
    }

    function isCollidingWithWall(x, y) {
        // „Éó„É¨„Ç§„É§„Éº„ÅÆ‰∏≠ÂøÉÂ∫ßÊ®ô„Çí„Ç∞„É™„ÉÉ„ÉâÂ∫ßÊ®ô„Å´Â§âÊèõ
        const px1 = x - PLAYER_SIZE / 2;
        const py1 = y - PLAYER_SIZE / 2;
        const px2 = x + PLAYER_SIZE / 2;
        const py2 = y + PLAYER_SIZE / 2;

        const checkPoints = [
            { gx: Math.floor(px1 / GRID_SIZE), gy: Math.floor(py1 / GRID_SIZE) }, // Â∑¶‰∏ä
            { gx: Math.floor(px2 / GRID_SIZE), gy: Math.floor(py1 / GRID_SIZE) }, // Âè≥‰∏ä
            { gx: Math.floor(px1 / GRID_SIZE), gy: Math.floor(py2 / GRID_SIZE) }, // Â∑¶‰∏ã
            { gx: Math.floor(px2 / GRID_SIZE), gy: Math.floor(py2 / GRID_SIZE) }  // Âè≥‰∏ã
        ];

        for (const p of checkPoints) {
            if (p.gx < 0 || p.gx >= MAP_COLS || p.gy < 0 || p.gy >= MAP_ROWS) {
                return true; // ÁîªÈù¢Â§ñ„ÅÆÂ£Å
            }
            if (map[p.gy][p.gx] === 1) {
                return true; // Â£Å„Å´Ë°ùÁ™Å
            }
        }
        return false;
    }

    function gameOver(isClear) {
        if (isGameOver) return;
        isGameOver = true;
        
        if (isClear) {
            alert('üéâ GAME CLEAR! „Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ');
        } else {
            alert('GAME OVER! Â£Å„Å´„Å∂„Å§„Åã„Å£„ÅüÔºÅ');
            document.body.style.backgroundColor = '#400';
            canvas.style.boxShadow = '0 0 20px red';
        }
        
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('wireGameHighScore', highScore);
        }

        updateScoreDisplay();
        cancelAnimationFrame(gameLoopId);
    }

    // --- ÊèèÁîªÈñ¢Êï∞ ---

    function drawMap() {
        for (let r = 0; r < MAP_ROWS; r++) {
            for (let c = 0; c < MAP_COLS; c++) {
                const x = c * GRID_SIZE;
                const y = r * GRID_SIZE;

                if (map[r][c] === 1) {
                    ctx.fillStyle = '#666'; // Â£Å
                    ctx.fillRect(x, y, GRID_SIZE, GRID_SIZE);
                } else if (map[r][c] === 2) {
                    ctx.fillStyle = 'lime'; // „Çπ„Çø„Éº„Éà
                    ctx.fillRect(x, y, GRID_SIZE, GRID_SIZE);
                } else if (map[r][c] === 3) {
                    ctx.fillStyle = 'gold'; // „Ç¥„Éº„É´
                    ctx.fillRect(x, y, GRID_SIZE, GRID_SIZE);
                }
            }
        }
    }

    function drawPlayer() {
        ctx.fillStyle = isGameOver ? 'red' : 'blue';
        ctx.fillRect(playerX - PLAYER_SIZE / 2, playerY - PLAYER_SIZE / 2, PLAYER_SIZE, PLAYER_SIZE);
    }

    function draw() {
        // ËÉåÊôØ„Çí„ÇØ„É™„Ç¢
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, WIDTH, HEIGHT);

        drawMap();
        drawPlayer();
    }

    // --- „É´„Éº„Éó„Å®Êõ¥Êñ∞ ---

    function updateScoreDisplay() {
        scoreDisplay.textContent = score;
        highScoreDisplay.textContent = highScore;
    }

    function gameLoop() {
        if (!isGameOver) {
            // „Çπ„Ç≥„Ç¢„ÇíÁ∂ôÁ∂öÁöÑ„Å´Êõ¥Êñ∞ (‰ªäÂõû„ÅØÁßªÂãïÊôÇ„Å´Âä†ÁÆó„Åô„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØÊèèÁîª„ÅÆ„Åø)
            // updateScoreDisplay();
            draw();
            gameLoopId = requestAnimationFrame(gameLoop);
        } else {
            draw(); // „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁä∂ÊÖã„ÇíÂõ∫ÂÆöÊèèÁîª
        }
    }

    // --- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ---

    document.addEventListener('keydown', (e) => {
      if (isGameOver) {
          if (e.key === 'r') initGame(); // 'r'„Åß„É™„Éà„É©„Ç§
          return;
      }
      
      const key = e.key.toLowerCase();
      let dx = 0;
      let dy = 0;
      
      if (key === 'arrowup' || key === 'w' || key === 'i') dy = -1;
      if (key === 'arrowdown' || key === 's' || key === 'k') dy = 1;
      if (key === 'arrowleft' || key === 'a' || key === 'j') dx = -1;
      if (key === 'arrowright' || key === 'd' || key === 'l') dx = 1;


      if (dx === 0 && dy === 0) return;
      
      const movementKeys = ['arrowup', 'arrowdown', 'arrowleft', 'arrowright', 'w', 'a', 's', 'd', 'i', 'j', 'k', 'l'];
      if (movementKeys.includes(key)) {
        e.preventDefault();
      }
      
      movePlayer(dx, dy);
    });

    canvas.addEventListener('touchstart', (e) => {
        if (e.touches.length > 1 || isGameOver) return; 
        e.preventDefault();
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
    });

    canvas.addEventListener('touchend', (e) => {
        if (!e.changedTouches.length || isGameOver) return; 
        
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;

        const dx = touchEndX - touchStartX;
        const dy = touchEndY - touchStartY;
        
        const threshold = 15; 
        
        if (Math.abs(dx) < threshold && Math.abs(dy) < threshold) {
            return;
        }

        let moveDx = 0;
        let moveDy = 0;

        if (Math.abs(dx) > Math.abs(dy)) {
            if (dx > 0) moveDx = 1;
            else moveDx = -1;
        } else {
            if (dy > 0) moveDy = 1;
            else moveDy = -1;
        }
        
        movePlayer(moveDx, moveDy);

    });


    // „Ç≤„Éº„É†ÈñãÂßãÔºÅ
    highScore = parseInt(highScore) || 0;
    initGame();
  </script>
</body>
</html>
