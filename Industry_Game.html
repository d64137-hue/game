<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>シンプル工業シミュレーション — フル改良版</title>
<style>
/* ===== 全体レイアウト ===== */
:root{
  --bg:#121217; --panel:#1e1e28; --muted:#9aa0b4; --accent:#76FF03;
  --card:#171722; --btn:#FFB74D; --danger:#FF7043;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family: "Noto Sans JP", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
body{background:linear-gradient(180deg,#0f0f13, #10101a); color:#E6EEF3; padding:12px;}

/* Container */
#GameArea{max-width:1100px;margin:0 auto;padding:14px;border-radius:12px;background:linear-gradient(180deg,#111118 0%, #161624 100%); box-shadow:0 8px 30px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03);}

/* Header */
.header{display:flex;align-items:center;gap:12px}
h1{margin:0;font-size:20px;color:var(--accent)}
.version{font-size:12px;color:var(--muted);margin-left:6px}

/* Status Panel */
#status-panel{display:flex;flex-wrap:wrap;gap:8px;justify-content:space-between;margin-top:12px;background:var(--panel);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
.status-block{display:flex;gap:10px;align-items:center;font-size:14px}
.status-block strong{color:#fff}
.badge{background:#22222a;padding:4px 8px;border-radius:6px;font-weight:700}
.small{font-size:12px;color:var(--muted)}

/* Tabs */
#tab-container{margin-top:12px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
#tabs{display:flex;background:#13131a;border-bottom:1px solid rgba(255,255,255,0.03)}
.tab-button{flex:1;padding:10px 12px;cursor:pointer;background:transparent;border:none;color:var(--muted);font-weight:600}
.tab-button.active{color:var(--accent);background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent);box-shadow:inset 0 -3px 0 rgba(118,255,3,0.08)}
.tab-content{padding:12px;background:transparent;display:none;color:#dfe7f2}

/* Panels & columns */
.row{display:flex;gap:12px}
.col{flex:1;min-width:200px}
.panel{background:linear-gradient(180deg,#0f1114,#14141a);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}

/* Resource list */
.resource-item{display:grid;grid-template-columns: 1fr auto auto;gap:8px;align-items:center;padding:6px;border-radius:6px}
.resource-name{font-weight:700;color:#FFEB3B}
.resource-meta{font-size:13px;color:var(--muted)}

/* Buttons */
.button{padding:6px 10px;border-radius:6px;border:none;background:var(--btn);color:#1b1b1b;font-weight:700;cursor:pointer}
.button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.button.small{padding:4px 8px;font-size:13px}

/* Build grid */
.build-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.build-card{background:linear-gradient(180deg,#0f1320,#12121a);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:8px;min-height:92px}
.build-title{font-weight:800}
.build-meta{font-size:13px;color:var(--muted)}

/* Research */
.research-grid{display:flex;flex-wrap:wrap;gap:8px}
.research-card{width:220px;padding:8px;border-radius:8px;background:linear-gradient(180deg,#0f1420,#11111a);border:1px solid rgba(255,255,255,0.02)}
.research-card.locked{opacity:0.5}

/* Achievements */
.ach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px}
.ach-card{padding:8px;border-radius:8px;background:#08110a;border:1px solid rgba(118,255,3,0.08);color:#dfffd8}

/* Production table */
.prod-table{width:100%;border-collapse:collapse;margin-top:6px}
.prod-table th,.prod-table td{padding:6px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px;text-align:left}

/* Tooltip */
.tooltip{position:relative}
.tooltip .tip{position:absolute;left:0;top:calc(100% + 6px);background:#0b0b10;color:#fff;padding:8px;border-radius:6px;font-size:13px;display:none;width:260px;z-index:60;box-shadow:0 6px 20px rgba(0,0,0,0.6)}
.tooltip:hover .tip{display:block}

/* Animations */
.anim-run{animation:runningLight 1.2s infinite}
@keyframes runningLight{0%{box-shadow:0 0 0 rgba(118,255,3,0)}50%{box-shadow:0 6px 20px rgba(118,255,3,0.06)}100%{box-shadow:0 0 0 rgba(118,255,3,0)}}

/* Message area */
#message-area{margin-top:12px;padding:10px;border-radius:6px;background:#0a0a0f;color:#fff;min-height:36px;border:1px solid rgba(255,255,255,0.02)}
.msg-good{color:#000;background:#76FF03;padding:6px;border-radius:6px}
.msg-bad{color:#fff;background:#FF7043;padding:6px;border-radius:6px}

/* Responsive */
@media (max-width:880px){
  .row{flex-direction:column}
  .build-grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
}
</style>
</head>
<body>
<div id="GameArea">
  <div class="header">
    <h1>シンプル工業シミュレーション</h1>
    <div class="version">フル改良版</div>
  </div>

  <div id="status-panel">
    <div class="status-block">
      <div>資金: <span id="gold-display" class="badge">1000</span></div>
      <div>投資: <span id="investment-display" class="badge">0</span></div>
      <div id="loan-panel" style="margin-left:10px">借入: <span id="loan-display" class="badge">0</span></div>
    </div>
    <div class="status-block">
      <div>Ticks: <span id="tick-display" class="small">0</span></div>
      <div>在庫上限: <span id="stock-limit-display" class="small">1000</span></div>
      <div>プレステージ: <span id="prestige-currency-display" class="badge">0</span></div>
    </div>
  </div>

  <div id="tab-container">
    <div id="tabs">
      <button class="tab-button active" onclick="switchTab('build')">🛠 建設</button>
      <button class="tab-button" onclick="switchTab('resource')">📦 資源・市場</button>
      <button class="tab-button" onclick="switchTab('research')">🔬 研究</button>
      <button class="tab-button" onclick="switchTab('achievement')">🏆 実績</button>
    </div>

    <div id="tab-build" class="tab-content" style="display:block">
      <div class="row">
        <div class="col panel">
          <h3>建設と生産</h3>
          <div style="margin-bottom:8px">
            購入数:
            <button class="button small" onclick="setBuildingCountMultiplier(1)" id="mb-1">x1</button>
            <button class="button small" onclick="setBuildingCountMultiplier(10)" id="mb-10">x10</button>
            <button class="button small" onclick="setBuildingCountMultiplier(100)" id="mb-100">x100</button>
            <button class="button small" onclick="setBuildingCountMultiplier('max')" id="mb-max">MAX</button>
          </div>
          <div id="build-buttons" class="build-grid"></div>
        </div>

        <div class="col panel">
          <h3>生産状況</h3>
          <div id="buildings-status" style="font-size:13px"></div>
          <h4 style="margin-top:8px">生産レート (毎分)</h4>
          <div id="production-rates" class="small"></div>
          <h4 style="margin-top:8px">建物稼働アニメ</h4>
          <div style="font-size:13px;color:var(--muted)">稼働中の建物は緑の光で点滅します。</div>
        </div>
      </div>

      <div style="margin-top:8px" class="panel">
        <h3>市場投資</h3>
        <div id="investment-panel">
          <div>現在の投資: <span id="investment-status">0</span>G</div>
          <div class="small">投資はランダム変動します（研究で安定化可能）</div>
          <div style="margin-top:6px;display:flex;gap:8px">
            <input type="number" id="invest-amount" value="1000" min="100" style="padding:6px;border-radius:6px;background:#0c0c10;border:1px solid rgba(255,255,255,0.02);color:#fff">
            <button class="button" onclick="investMoney(document.getElementById('invest-amount').value)">投資</button>
            <button class="button ghost" onclick="withdrawInvestment()">回収</button>
          </div>
        </div>
      </div>

    </div>

    <div id="tab-resource" class="tab-content">
      <div class="row">
        <div class="col panel">
          <h3>資源一覧（カテゴリ別）</h3>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <button class="button small" onclick="filterResource('all')">全て</button>
            <button class="button small" onclick="filterResource('raw')">原料</button>
            <button class="button small" onclick="filterResource('intermediate')">加工品</button>
            <button class="button small" onclick="filterResource('advanced')">上位加工</button>
          </div>
          <div id="resource-list"></div>
          <div id="total-stock-info" class="small" style="margin-top:8px"></div>
        </div>

        <div class="col panel">
          <h3>販売 / 購入 履歴</h3>
          <div id="trade-log" style="max-height:260px;overflow:auto;font-size:13px;color:var(--muted)"></div>
          <div style="margin-top:8px">
            <button class="button small" onclick="sellAllResources()">全売却</button>
            <button class="button small" onclick="autoSellAll()">自動売却ON/OFF</button>
          </div>
        </div>
      </div>
    </div>

    <div id="tab-research" class="tab-content">
      <div class="panel">
        <h3>研究</h3>
        <div>研究ポイント: <span id="research-points">0</span></div>
        <div id="ig-research-tree" class="research-grid" style="margin-top:8px"></div>
      </div>
      <div class="panel" style="margin-top:8px">
        <h4>説明</h4>
        <div>研究は生産効率や市場安定、ローン緩和などゲーム内の多くの効果を与えます。研究は資金で行います。</div>
      </div>
    </div>

    <div id="tab-achievement" class="tab-content">
      <div class="panel">
        <h3>実績</h3>
        <div>実績数: <span id="achieved-count">0</span> / <span id="total-achievements">0</span></div>
        <div id="achievement-panel-container" class="ach-grid" style="margin-top:8px"></div>
      </div>
      <div class="panel" style="margin-top:8px">
        <h3>プレステージ (転生)</h3>
        <div>獲得可能通貨: <span id="prestige-gain-display">0</span> ⭐</div>
        <div style="margin-top:6px">
          <button class="button" id="prestige-button" onclick="prestigeReset()">プレステージ実行</button>
        </div>
      </div>
    </div>

  </div>

  <div id="message-area">ゲーム開始！ 改良版を楽しんでください。</div>
</div>

<script>
/* ======================
   定数・初期パラメータ
   ====================== */
const TICK_RATE_MS = 200; // 1 tick = 200ms (5 tick = 1s)
const TICKS_PER_MINUTE = Math.round(60000 / TICK_RATE_MS);
const BASE_STOCK_LIMIT = 1000;
const LOAN_BASE_RATE = 0.0005; // 基本利率/tick
const LOAN_MAX_RATE = 0.02; // 上限
const INVEST_BASE_VOLATILITY = 0.01; // 投資の標準変動 (±1%)
const SELL_PRICE_RATIO = 0.8; // 売却は購入価格の80%

/* ===== 資源データ（カテゴリ） ===== */
const RESOURCE_META = {
  ore: {name:'鉄鉱石', unit:'個', category:'raw', basePrice:5},
  copper_ore: {name:'銅鉱石', unit:'個', category:'raw', basePrice:8},
  coal_ore: {name:'石炭', unit:'個', category:'raw', basePrice:6},
  alum_ore: {name:'アルミ鉱石', unit:'個', category:'raw', basePrice:10},
  silicon_ore: {name:'シリコン鉱石', unit:'個', category:'raw', basePrice:12},
  titan_ore: {name:'チタン鉱石', unit:'個', category:'raw', basePrice:18},
  iron: {name:'鉄', unit:'個', category:'intermediate', basePrice:22},
  copper_wire: {name:'銅線', unit:'m', category:'intermediate', basePrice:40},
  alum: {name:'アルミ', unit:'塊', category:'intermediate', basePrice:35},
  steel_copper: {name:'鉄鋼銅', unit:'塊', category:'advanced', basePrice:80},
  wafer: {name:'ウェハ', unit:'枚', category:'advanced', basePrice:120},
  alloy: {name:'合金', unit:'塊', category:'advanced', basePrice:160}
};

/* ===== 建物仕様（出力・入力） ===== */
const BUILDING_SPECS = {
  Mine: {cost:100, displayName:'鉄採掘所', output:{iron:'ore',amount:1}, time:100, input:null},
  CopperMine: {cost:150, displayName:'銅採掘所', output:{copper_ore:'copper_ore',amount:1}, time:110, input:null},
  CoalMine: {cost:140, displayName:'石炭採掘所', output:{coal_ore:'coal_ore',amount:1}, time:80, input:null},
  Smelter: {cost:250, displayName:'鉄製錬所', output:{iron:'iron',amount:1}, time:150, input:[{r:'ore',a:2},{r:'coal_ore',a:1}]},
  WireMill: {cost:400, displayName:'電線工場', output:{copper_wire:'copper_wire',amount:1}, time:200, input:[{r:'copper_ore',a:2},{r:'coal_ore',a:1}]},
  SteelMill: {cost:600, displayName:'製鋼所', output:{steel_copper:'steel_copper',amount:1}, time:300, input:[{r:'ore',a:1},{r:'copper_ore',a:1},{r:'coal_ore',a:2}]},
  AluminumSmelter: {cost:350, displayName:'アルミ製錬所', output:{alum:'alum',amount:1}, time:180, input:[{r:'alum_ore',a:2},{r:'coal_ore',a:1}]},
  WaferFab: {cost:800, displayName:'ウェハ工場', output:{wafer:'wafer',amount:1}, time:250, input:[{r:'silicon_ore',a:1},{r:'coal_ore',a:2},{r:'alum',a:1}]},
  AlloyForge: {cost:1200, displayName:'合金鍛造所', output:{alloy:'alloy',amount:1}, time:400, input:[{r:'titan_ore',a:1},{r:'iron',a:1},{r:'steel_copper',a:1}]},
  AdvancedSmelter: {cost:900, displayName:'上級製錬所', output:{steel_copper:'steel_copper',amount:1}, time:250, input:[{r:'ore',a:1},{r:'copper_wire',a:1}]},
  AutoTransporter: {cost:1500, displayName:'自動搬送機', output:null, time:20, input:null},
  Warehouse: {cost:2000,displayName:'倉庫',output:null,time:0,input:null},
  TradePost: {cost:5000,displayName:'自動取引所',output:null,time:80,input:null},
  ContractOffice: {cost:3000,displayName:'契約オフィス',output:null,time:200,input:null}
};

/* ===== 初期ゲーム状態 ===== */
let stats = {
  gold: 1000,
  investment: 0,
  loan: 0,
  prestige_currency: 0,
  tick: 0,
  buildingCountMultiplier: 1,
  resources: {},
  buildings: {},
  upgrades: { productionEfficiency:0, warehouseCapacity:0, marketStability:0, productionSpeed:0, autoTransportEfficiency:0, contractEfficiency:0, investmentStability:0, loanInterestReduction:0, advancedAutomation:0 },
  achievements: {},
  market: { priceAdjustment: {}, marketFluctuation: 1.0 },
  autoSellEnabled: false,
  questLog: []
};

/* 初期化：資源と建物配列を作る */
for(const r in RESOURCE_META) stats.resources[r] = 0;
for(const b in BUILDING_SPECS) stats.buildings[b] = [];

/* ===== GLOBAL UPGRADES 定義（追加分含む） ===== */
const GLOBAL_UPGRADES = {
  productionEfficiency: {displayName:'生産技術向上', maxLevel:10, baseCost:1000, costMultiplier:1.5, effect: lvl => `生産効率 +${lvl*5}%`, getCost: lvl => Math.ceil(1000 * Math.pow(1.5, lvl)) },
  warehouseCapacity: {displayName:'倉庫容量拡張', maxLevel:10, baseCost:1500, costMultiplier:1.7, effect:lvl=>`倉庫+${lvl*50}%`, getCost: lvl => Math.ceil(1500 * Math.pow(1.7, lvl)) },
  marketStability: {displayName:'市場安定化', maxLevel:5, baseCost:1500, costMultiplier:1.8, effect:lvl=>`売却ペナルティ -${lvl*10}%`, getCost:lvl=>Math.ceil(1500*Math.pow(1.8,lvl)) },
  productionSpeed: {displayName:'生産速度改善', maxLevel:5, baseCost:1200, costMultiplier:1.7, effect:lvl=>`生産時間 -${lvl*5}%`, getCost:lvl=>Math.ceil(1200*Math.pow(1.7,lvl)) },
  autoTransportEfficiency: {displayName:'自動搬送強化', maxLevel:5, baseCost:800, costMultiplier:1.6, effect:lvl=>`自動搬送売却量 +${lvl}`, getCost:lvl=>Math.ceil(800*Math.pow(1.6,lvl)) },
  contractEfficiency: {displayName:'契約強化', maxLevel:5, baseCost:2000, costMultiplier:1.8, effect:lvl=>`契約売却報酬 +${lvl*10}%`, getCost:lvl=>Math.ceil(2000*Math.pow(1.8,lvl)) },
  investmentStability: {displayName:'投資安定化', maxLevel:5, baseCost:1500, costMultiplier:1.5, effect:lvl=>`投資変動幅 -${lvl*2}%`, getCost:lvl=>Math.ceil(1500*Math.pow(1.5,lvl)) },
  loanInterestReduction: {displayName:'ローン利子軽減', maxLevel:5, baseCost:2500, costMultiplier:1.5, effect:lvl=>`利子率 -${(lvl*0.5).toFixed(2)}%`, getCost:lvl=>Math.ceil(2500*Math.pow(1.5,lvl)) },
  advancedAutomation: {displayName:'高度自動化', maxLevel:5, baseCost:3000, costMultiplier:2.0, effect:lvl=>`自動化速度 +${lvl*20}%`, getCost:lvl=>Math.ceil(3000*Math.pow(2,lvl)) }
};

/* ===== 実績定義 ===== */
const ACHIEVEMENT_DEFINITIONS = {
  first_build: {name:'最初の一歩', desc:'任意の建物を1つ建設する', check: ()=>getTotalBuildings()>=1},
  earn_1k: {name:'初期投資家', desc:'所持金+投資の合計が1,000Gを超える', check: ()=>stats.gold+stats.investment>=1000 && stats.tick>10},
  earn_10k: {name:'中堅企業', desc:'総資産が10,000Gを超える', check: ()=>stats.gold+stats.investment>=10000},
  make_wafer: {name:'ウェハ生産者', desc:'初めてウェハを生産する', check: ()=>stats.resources.wafer>0},
  build_all_mines: {name:'資源王', desc:'6種の採掘所すべてを1つ以上建設', check: ()=>['Mine','CopperMine','CoalMine','AluminumSmelter','WaferFab','AlloyForge'].every(k=>stats.buildings[k] && stats.buildings[k].length>0)}
};

/* ===== ヘルパー ===== */
function formatNum(n){ if(n>=1e9) return (n/1e9).toFixed(2)+'B'; if(n>=1e6) return (n/1e6).toFixed(2)+'M'; if(n>=1000) return (n/1000).toFixed(2)+'K'; return Math.floor(n); }
function getTotalBuildings(){ return Object.values(stats.buildings).flat().length; }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

/* ======================
   市場・価格ロジック
   ====================== */
function getResourcePrice(key){
  const meta = RESOURCE_META[key];
  if(!meta) return 1;
  const base = meta.basePrice;
  const fluct = stats.market.marketFluctuation;
  const adj = 1 + (stats.market.priceAdjustment[key] || 0);
  const price = Math.max(1, Math.floor(base * fluct * adj));
  return price;
}

/* pricePressure: 売却による価格下落を加算する */
function applySellPriceImpact(resource, amount){
  const stabilityLevel = stats.upgrades.marketStability || 0;
  const reduction = 1 - stabilityLevel*0.1; // Lv1で10%軽減
  const impact = Math.min(0.3, (amount/1000) * 0.1) * reduction;
  stats.market.priceAdjustment[resource] = (stats.market.priceAdjustment[resource] || 0) - impact;
}

/* 市場の自動回復（tickで呼ぶ） */
function updateMarket(){
  if(stats.tick % Math.round(TICKS_PER_MINUTE/30) === 0){ // approx every 2s
    const maxFluct = 0.05;
    const change = (Math.random()*maxFluct*2) - maxFluct;
    stats.market.marketFluctuation = clamp(stats.market.marketFluctuation + change, 0.8, 1.2);
  }
  // priceAdjustment 回復
  for(const k in stats.market.priceAdjustment){
    if(stats.market.priceAdjustment[k] < 0){
      stats.market.priceAdjustment[k] = Math.min(0, stats.market.priceAdjustment[k] + 0.001 * (1 + stats.upgrades.marketStability*0.2));
    }
  }
}

/* ======================
   建物クラス（単純） and 生産
   ====================== */
class Building {
  constructor(type){
    this.type = type;
    this.spec = BUILDING_SPECS[type];
    this.timer = 0;
    this.isStalled = false;
  }
  tick(){
    this.timer++;
    this.isStalled = false;
    if(!this.spec.output){
      // Utility building actions
      if(this.type === 'AutoTransporter' && this.timer >= this.spec.time){
        autoSellOneResource();
        this.timer = 0;
      } else if(this.type === 'TradePost' && this.timer >= this.spec.time){
        autoTradeHighValueResource();
        this.timer = 0;
      } else if(this.type === 'ContractOffice' && this.timer >= this.spec.time){
        autoContractSell();
        this.timer = 0;
      }
      return false;
    }
    // Production speed effect
    const prodSpeedLevel = stats.upgrades.productionSpeed || 0;
    const prodEff = 1 - (prodSpeedLevel * 0.05);
    const productionMultiplier = Math.max(0.2, prodEff - stats.upgrades.productionEfficiency*0.05);
    const effectiveTime = Math.max(1, Math.floor(this.spec.time * productionMultiplier));

    if(this.timer >= effectiveTime){
      // stock limit
      const stockLimit = computeStockLimit();
      const outRes = this.spec.output.iron ? this.spec.output.iron : this.spec.output; // compatibility
      const outKey = Object.values(this.spec.output)[0] || this.spec.output; // if {iron:'ore',amount:1} style earlier then adapt
      // Our spec format: output:{iron:'ore',amount:1} earlier; in current we used {output:{iron:'iron',amount:1}}-- but to avoid confusion we will refer spec.output keys:
      // We defined spec.output e.g. {iron:'ore',amount:1} (odd). Use mapping at top: Let's use object: output: { res:'iron', amount:1 }
      // Adapt: if spec.output.res exists -> use that
      const outputRes = this.spec.output.res || (this.spec.output && this.spec.output.resource) || Object.keys(this.spec.output)[0];
      const outputAmt = this.spec.output.amount || (this.spec.output && this.spec.output.amount) || (this.spec.output[outputRes] || 1);

      if(stats.resources[outputRes] + outputAmt > stockLimit){ this.isStalled = true; return false; }
      if(this.spec.input){
        let can = true;
        for(const req of this.spec.input){
          if(stats.resources[req.r] < req.a){ can = false; break; }
        }
        if(!can){ this.isStalled = true; return false; }
        for(const req of this.spec.input){ stats.resources[req.r] -= req.a; }
      }
      stats.resources[outputRes] += outputAmt;
      this.timer = 0;
      return true;
    }
    return false;
  }
}

/* ======================
   自動化機能（AutoTransporter, TradePost, ContractOffice）
   ====================== */
const AUTO_SELL_ORDER = ['iron','copper_wire','steel_copper','alum','wafer','alloy'];
function autoSellOneResource(){
  // 自動搬送機は設定で売却数増加
  const amt = 1 + (stats.upgrades.autoTransportEfficiency || 0);
  for(const res of AUTO_SELL_ORDER){
    if(stats.resources[res] >= amt){
      const price = getResourcePrice(res);
      const revenue = Math.floor(price * amt);
      stats.gold += revenue;
      stats.resources[res] -= amt;
      applySellPriceImpact(res, amt);
      pushLog(`自動搬送: ${RESOURCE_META[res].name} x${amt} を売却し ${revenue}G を獲得`);
      return;
    }
  }
}
function autoTradeHighValueResource(){
  const candidates = ['wafer','alloy'];
  for(const c of candidates){
    if(stats.resources[c] > 0){
      const price = getResourcePrice(c);
      const revenue = Math.floor(price * 0.9);
      stats.gold += revenue;
      stats.resources[c] -= 1;
      applySellPriceImpact(c, 1);
      pushLog(`自動取引所: ${RESOURCE_META[c].name} を売却 (90%) で ${revenue}G`);
      return;
    }
  }
}
function autoContractSell(){
  const sellables = ['iron','copper_wire','steel_copper','alum','wafer','alloy'];
  const avail = sellables.filter(r=>stats.resources[r] > 0);
  if(avail.length===0) return;
  const pick = avail[Math.floor(Math.random()*avail.length)];
  const base = RESOURCE_META[pick].basePrice;
  const multiplier = 1.5 + (stats.upgrades.contractEfficiency||0)*0.1;
  const revenue = Math.floor(base * multiplier);
  stats.gold += revenue;
  stats.resources[pick] -= 1;
  pushLog(`契約オフィス: ${RESOURCE_META[pick].name} を契約売却で ${revenue}G (市場影響なし)`);
}

/* ======================
   生産ループ / tick
   ====================== */
function computeStockLimit(){
  const base = BASE_STOCK_LIMIT;
  const warehouseBonus = (stats.buildings.Warehouse ? stats.buildings.Warehouse.length : 0) * 5000;
  const capacityLevel = stats.upgrades.warehouseCapacity || 0;
  return Math.floor(base + warehouseBonus * (1 + capacityLevel*0.5));
}
function tickLoop(){
  stats.tick++;
  // market
  updateMarket();

  // update investments
  updateInvestment();

  // loan interest
  updateLoanInterest();

  // buildings production
  for(const type in stats.buildings){
    for(const b of stats.buildings[type]){
      b.tick && b.tick();
    }
  }

  // auto-sell toggle (if enabled)
  if(stats.autoSellEnabled){
    for(let i=0;i<stats.buildings.AutoTransporter.length;i++){
      autoSellOneResource();
    }
  }

  // achievements check
  checkAchievements();

  // update UI
  updateDisplay();

  // periodic events (every 60 ticks ~ approx every 12s at TICK_RATE_MS=200)
  if(stats.tick % (TICKS_PER_MINUTE/5) === 0) maybeSpawnEvent();
}

/* 投資更新 */
function updateInvestment(){
  if(stats.investment <= 0) return;
  const stabilityLevel = stats.upgrades.investmentStability || 0;
  const volatility = INVEST_BASE_VOLATILITY * (1 - stabilityLevel*0.15); // 減衰
  const fluct = (Math.random()*2-1) * volatility;
  const delta = Math.floor(stats.investment * fluct);
  stats.investment = Math.max(0, stats.investment + delta);
}

/* ローン利子更新（緩和版） */
function updateLoanInterest(){
  if(stats.loan <= 0) return;
  const reductionLevel = stats.upgrades.loanInterestReduction || 0;
  let rate = LOAN_BASE_RATE * (1 - reductionLevel*0.12); // each level reduces 12% of base
  // step function by amount
  const step = Math.floor(stats.loan / 10000) * 0.0002;
  rate = Math.min(rate + step, LOAN_MAX_RATE);
  stats.loan += Math.floor(stats.loan * rate);
}

/* =============== UI / 操作 =============== */
let buildingCountMultiplier = 1;

function setBuildingCountMultiplier(n){
  buildingCountMultiplier = n;
  document.querySelectorAll('[id^="mb-"]').forEach(b=>b.classList.remove('selected'));
  // highlight chosen
  updateDisplay();
}

function getMaxPurchases(cost){
  if(cost === 0) return 99999;
  return Math.floor(stats.gold / cost);
}

/* Build a building */
function buildBuilding(type){
  const spec = BUILDING_SPECS[type];
  let count = buildingCountMultiplier;
  if(count === 'max') count = getMaxPurchases(spec.cost);
  if(count <= 0){ pushLog('購入数0'); return; }
  const totalCost = spec.cost * count;
  if(stats.gold < totalCost){ showMessage('資金不足', true); return; }
  stats.gold -= totalCost;
  for(let i=0;i<count;i++){
    stats.buildings[type].push(new Building(type));
  }
  pushLog(`${spec.displayName} を ${count}基 建設しました (${totalCost}G)`);
  updateDisplay();
}

/* Sell resource */
function sellResource(key){
  const amt = stats.resources[key];
  if(amt <= 0){ showMessage('売却可能な資源がありません', false); return; }
  const price = getResourcePrice(key);
  const revenue = Math.floor(price * SELL_PRICE_RATIO * amt);
  stats.resources[key] = 0;
  stats.gold += revenue;
  applySellPriceImpact(key, amt);
  pushLog(`${RESOURCE_META[key].name} x${amt} を売却し ${revenue}G を獲得`);
  showMessage(`${RESOURCE_META[key].name} を売却しました`, true);
  updateDisplay();
}

/* Sell all resources */
function sellAllResources(){
  let totalRevenue = 0;
  let soldTypes = 0;
  const stabilityLevel = stats.upgrades.marketStability || 0;
  const reduction = 1 - (stabilityLevel * 0.1);
  for(const r in stats.resources){
    const amount = stats.resources[r];
    if(amount > 0){
      const p = getResourcePrice(r);
      const rev = Math.floor(p * SELL_PRICE_RATIO * amount);
      totalRevenue += rev;
      stats.resources[r] = 0;
      applySellPriceImpact(r, amount * reduction);
      soldTypes++;
    }
  }
  if(totalRevenue > 0){
    stats.gold += totalRevenue;
    pushLog(`全資源を売却し ${totalRevenue}G を得た (種類: ${soldTypes})`);
    showMessage(`全資源を売却しました: ${formatNum(totalRevenue)}G`, true);
  } else {
    showMessage('売却可能な資源はありません', false);
  }
  updateDisplay();
}

/* Auto-sell toggle */
function autoSellAll(){
  stats.autoSellEnabled = !stats.autoSellEnabled;
  pushLog(`自動売却: ${stats.autoSellEnabled ? 'ON' : 'OFF'}`);
  updateDisplay();
}

/* Invest / withdraw */
function investMoney(val){
  const amount = parseInt(val);
  if(isNaN(amount) || amount <= 0){ showMessage('有効な投資額を入力', false); return; }
  if(stats.gold < amount){ showMessage('資金不足', false); return; }
  stats.gold -= amount;
  stats.investment += amount;
  pushLog(`${formatNum(amount)}G を投資しました`);
  updateDisplay();
}
function withdrawInvestment(){
  if(stats.investment <= 0){ showMessage('投資なし', false); return; }
  stats.gold += stats.investment;
  pushLog(`投資 ${formatNum(stats.investment)}G を回収しました`);
  stats.investment = 0;
  updateDisplay();
}

/* Loan */
function takeLoan(amount){
  const amt = parseInt(amount);
  if(isNaN(amt) || amt<=0) return;
  if(stats.loan + amt > 2000000){ showMessage('借入上限を超えます', false); return; }
  stats.loan += amt;
  stats.gold += amt;
  pushLog(`銀行から ${formatNum(amt)}G を借入`);
  updateDisplay();
}
function repayLoan(){
  if(stats.loan <= 0){ showMessage('借入なし', false); return; }
  if(stats.gold >= stats.loan){
    stats.gold -= stats.loan;
    pushLog(`ローン ${formatNum(stats.loan)}G を全額返済`);
    stats.loan = 0;
    updateDisplay();
  } else {
    showMessage('返済資金が不足しています', false);
  }
}

/* Research */
const RESEARCH_NODES = [
  {id:'r_prod', title:'効率化 I', cost:200, desc:'全設備の生産効率 +10%', prereq:null, effect: (g)=>{ g.upgrades.productionEfficiency += 1; }},
  {id:'r_prod2', title:'効率化 II', cost:800, desc:'全設備の生産効率 +20%', prereq:'r_prod', effect:(g)=>{ g.upgrades.productionEfficiency += 2; }},
  {id:'r_market', title:'市場安定化', cost:300, desc:'売却ペナルティを軽減', prereq:null, effect:(g)=>{ g.upgrades.marketStability += 1; }},
  {id:'r_auto', title:'自動化基礎', cost:500, desc:'自動搬送の効率を上げる', prereq:null, effect:(g)=>{ g.upgrades.autoTransportEfficiency += 1; }},
  {id:'r_loan', title:'ローン管理', cost:1000, desc:'ローン利子を軽減', prereq:null, effect:(g)=>{ g.upgrades.loanInterestReduction += 1; }},
  {id:'r_invest', title:'投資安定化', cost:700, desc:'投資変動を小さくする', prereq:null, effect:(g)=>{ g.upgrades.investmentStability += 1; }},
  {id:'r_speed', title:'生産速度', cost:1200, desc:'生産速度を早める', prereq:'r_prod', effect:(g)=>{ g.upgrades.productionSpeed += 1; }}
];

function renderResearch(){
  const cont = document.getElementById('ig-research-tree');
  cont.innerHTML = '';
  RESEARCH_NODES.forEach(node=>{
    const unlocked = !!stats.research?.[node.id];
    const locked = node.prereq && !stats.research?.[node.prereq];
    const card = document.createElement('div');
    card.className = 'research-card' + (locked ? ' locked' : '');
    card.innerHTML = `<div style="font-weight:800">${node.title}</div>
      <div style="font-size:13px;color:var(--muted)">${node.desc}</div>
      <div style="margin-top:6px">${unlocked ? '取得済' : `コスト: ${node.cost}G`}</div>
      <div style="margin-top:6px"><button class="button small" ${locked||unlocked? 'disabled':''} onclick="buyResearch('${node.id}')">${unlocked? '取得済':'研究'}</button></div>`;
    cont.appendChild(card);
  });
}
function buyResearch(id){
  const node = RESEARCH_NODES.find(n=>n.id===id);
  if(!node) return;
  if(stats.gold < node.cost){ showMessage('資金不足で研究できません', false); return; }
  if(node.prereq && !stats.research?.[node.prereq]){ showMessage('前提が未達成です', false); return; }
  stats.gold -= node.cost;
  stats.research = stats.research || {};
  stats.research[id] = true;
  node.effect(stats);
  pushLog(`研究 ${node.title} を習得`);
  renderResearch();
  updateDisplay();
}

/* Achievements */
function checkAchievements(){
  for(const key in ACHIEVEMENT_DEFINITIONS){
    if(!stats.achievements[key] && ACHIEVEMENT_DEFINITIONS[key].check()){
      stats.achievements[key] = true;
      pushLog(`🏆 実績達成: ${ACHIEVEMENT_DEFINITIONS[key].name}`);
      showMessage(`実績達成: ${ACHIEVEMENT_DEFINITIONS[key].name}`, true);
    }
  }
  renderAchievements();
}
function renderAchievements(){
  const panel = document.getElementById('achievement-panel-container');
  panel.innerHTML = '';
  let total = 0, achieved = 0;
  for(const key in ACHIEVEMENT_DEFINITIONS){
    total++;
    const def = ACHIEVEMENT_DEFINITIONS[key];
    const unlocked = !!stats.achievements[key];
    if(unlocked) achieved++;
    const el = document.createElement('div');
    el.className = 'ach-card';
    el.style.opacity = unlocked ? 1 : 0.5;
    el.innerHTML = `<div style="font-weight:800">${def.name}</div><div style="font-size:13px;color:var(--muted)">${def.desc}</div>`;
    panel.appendChild(el);
  }
  document.getElementById('total-achievements').textContent = total;
  document.getElementById('achieved-count').textContent = achieved;
}

/* Quest system: example simple quests */
const QUESTS = [
  {id:'q1', title:'採掘開始', desc:'採掘所を1基建てる', check:()=>getTotalBuildings()>=1, reward: ()=>{ stats.gold += 200; pushLog('クエスト報酬: 200G'); }},
  {id:'q2', title:'鉄を集める', desc:'鉄を50個生産する', check:()=>stats.resources.iron >= 50, reward: ()=>{ stats.prestige_currency += 5; pushLog('クエスト報酬: プレステージ+5'); }}
];
function checkQuests(){
  QUESTS.forEach(q=>{
    if(!stats.quests) stats.quests = {};
    if(!stats.quests[q.id] && q.check()){
      stats.quests[q.id] = true;
      q.reward();
      pushLog(`クエスト達成: ${q.title}`);
    }
  });
}

/* Random events */
function maybeSpawnEvent(){
  if(Math.random() < 0.06){ // ~6% chance
    const events = [
      ()=>{ // 資源ボーナス
        const rKeys = Object.keys(RESOURCE_META);
        const pick = rKeys[Math.floor(Math.random()*rKeys.length)];
        const amt = Math.floor(Math.random()*10)+5;
        stats.resources[pick] += amt;
        pushLog(`イベント: ${RESOURCE_META[pick].name} をボーナスで ${amt} 受領`);
      },
      ()=>{ // 市場暴落
        for(const k in stats.market.priceAdjustment) stats.market.priceAdjustment[k] -= 0.02;
        pushLog('イベント: 市場が一時的に不安定に');
      },
      ()=>{ // 投資配当
        const gain = Math.floor((Math.random()*0.2+0.1) * Math.max(100, stats.investment));
        stats.gold += gain;
        pushLog(`イベント: 投資配当 ${gain}G を受取`);
      }
    ];
    const ev = events[Math.floor(Math.random()*events.length)];
    ev();
  }
}

/* Trade log */
let TRADE_LOG = [];
function pushLog(text){
  TRADE_LOG.unshift(`${new Date().toLocaleTimeString()} - ${text}`);
  if(TRADE_LOG.length > 200) TRADE_LOG.pop();
  renderTradeLog();
}
function renderTradeLog(){
  const el = document.getElementById('trade-log');
  el.innerHTML = TRADE_LOG.map(t=>`<div style="padding:6px;border-bottom:1px dashed rgba(255,255,255,0.02);font-size:13px;color:var(--muted)">${t}</div>`).join('');
}

/* Display: resources, buildings, production rates, research etc. */
let resourceFilter = 'all';
function filterResource(cat){ resourceFilter = cat; updateDisplay(); }

/* compute production per minute from active buildings */
function calcProductionPerMinute(){
  const totals = {};
  for(const type in stats.buildings){
    const spec = BUILDING_SPECS[type];
    if(!spec || !spec.output) continue;
    const count = stats.buildings[type].length;
    if(count === 0) continue;
    // production speed and efficiency
    const prodSpeedLevel = stats.upgrades.productionSpeed || 0;
    const prodEff = 1 - (prodSpeedLevel * 0.05) - (stats.upgrades.productionEfficiency||0)*0.05;
    const effectiveTime = Math.max(1, Math.floor(spec.time * Math.max(0.2, prodEff)));
    const cyclesPerMin = TICKS_PER_MINUTE / effectiveTime;
    const perMin = cyclesPerMin * spec.output.amount * count;
    const outKey = spec.output.res;
    totals[outKey] = (totals[outKey] || 0) + perMin;
  }
  return totals;
}

function updateDisplay(){
  // Status
  document.getElementById('gold-display').textContent = formatNum(stats.gold);
  document.getElementById('investment-display').textContent = formatNum(stats.investment);
  document.getElementById('loan-display').textContent = formatNum(stats.loan);
  document.getElementById('tick-display').textContent = stats.tick;
  document.getElementById('prestige-currency-display').textContent = stats.prestige_currency;
  const stockLimit = computeStockLimit();
  document.getElementById('stock-limit-display').textContent = formatNum(stockLimit);

  // Build buttons
  const buildButtons = document.getElementById('build-buttons');
  buildButtons.innerHTML = '';
  for(const type in BUILDING_SPECS){
    const spec = BUILDING_SPECS[type];
    const cost = spec.cost;
    let buyCount = buildingCountMultiplier;
    if(buyCount === 'max') buyCount = getMaxPurchases(cost);
    const totalCost = cost * buyCount;
    const canBuy = stats.gold >= cost;
    const btn = document.createElement('div');
    btn.className = 'build-card';
    btn.innerHTML = `<div class="build-title">${spec.displayName}</div>
      <div class="build-meta">コスト: ${cost}G ${spec.output ? '| 出力: ' + (spec.output.res) : ''}</div>
      <div style="margin-top:auto;display:flex;gap:8px;justify-content:space-between">
        <div class="small">所持: ${stats.buildings[type].length}</div>
        <div>
          <button class="button small" ${!canBuy?'disabled':''} onclick="buildBuilding('${type}')">建設 ${buyCount==='max'? '(MAX)':`(${buyCount})`}</button>
        </div>
      </div>`;
    buildButtons.appendChild(btn);
  }

  // Buildings status
  const bs = document.getElementById('buildings-status');
  bs.innerHTML = '';
  for(const type in stats.buildings){
    const spec = BUILDING_SPECS[type];
    const count = stats.buildings[type].length;
    if(count === 0) continue;
    const stalled = stats.buildings[type].filter(b=>b.isStalled).length;
    const el = document.createElement('div');
    el.style.display='flex';el.style.justifyContent='space-between';el.style.alignItems='center';
    el.innerHTML = `<div><strong>${spec.displayName}</strong> ${count}基 ${stalled>0?`(停止:${stalled})`:''}</div>
      <div class="small">${spec.output? `出力: ${spec.output.res}`:''}</div>`;
    if(stalled===0) el.classList.add('anim-run');
    bs.appendChild(el);
  }

  // Production rates per minute
  const rates = calcProductionPerMinute();
  const prDiv = document.getElementById('production-rates');
  prDiv.innerHTML = '';
  for(const k in rates){
    const name = RESOURCE_META[k].name;
    prDiv.innerHTML += `<div class="small">${name}: ${rates[k].toFixed(1)} /分</div>`;
  }
  if(Object.keys(rates).length===0) prDiv.innerHTML = '<div class="small" style="color:var(--muted)">稼働中の生産設備はありません。</div>';

  // Resource list
  const resourceList = document.getElementById('resource-list');
  resourceList.innerHTML = '';
  let totalStock = 0;
  for(const key in stats.resources){
    totalStock += stats.resources[key];
    const meta = RESOURCE_META[key];
    if(resourceFilter !== 'all' && meta.category !== resourceFilter) continue;
    const price = getResourcePrice(key);
    const priceChangePercent = ((price / meta.basePrice) - 1) * 100;
    let changeClass = priceChangePercent > 0.1 ? 'price-up' : (priceChangePercent < -0.1 ? 'price-down' : '');
    const item = document.createElement('div');
    item.className = 'resource-item';
    item.innerHTML = `<div>
        <div class="resource-name">${meta.name} <span class="small">(${key})</span></div>
        <div class="resource-meta">${stats.resources[key]} ${meta.unit} / 価格: ${price}G</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
        <div class="small ${changeClass}">${priceChangePercent.toFixed(1)}%</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="button small" ${stats.resources[key]===0?'disabled':''} onclick="sellResource('${key}')">売却 (${Math.floor(price*SELL_PRICE_RATIO)}G)</button>
        <button class="button small ghost" onclick="showResourceInfo('${key}')">説明</button>
      </div>`;
    resourceList.appendChild(item);
  }
  document.getElementById('total-stock-info').textContent = `総在庫: ${totalStock} / 上限: ${formatNum(computeStockLimit())}`;

  // Investment panel
  document.getElementById('investment-status').textContent = `${formatNum(stats.investment)}G`;

  // Research UI
  document.getElementById('research-points').textContent = (stats.researchPoints || 0);
  renderResearch();

  // Achievements
  renderAchievements();

  // Trade log
  renderTradeLog();

  // Prestige calculation
  const totalAssets = stats.gold + stats.investment - stats.loan;
  const prestigeGain = Math.max(0, Math.floor(Math.log10(Math.max(1,totalAssets)/100000) * 10) * 10);
  document.getElementById('prestige-gain-display').textContent = prestigeGain;
  document.getElementById('prestige-button').disabled = totalAssets < 100000;
}

/* Resource info modal */
function showResourceInfo(key){
  const meta = RESOURCE_META[key];
  alert(`${meta.name}\nカテゴリ: ${meta.category}\n基底価格: ${meta.basePrice}G\n単位: ${meta.unit}\n\n用途:\n` + listUsage(key));
}
function listUsage(key){
  // list building inputs that require this resource and building that outputs it
  let lines = [];
  for(const [bkey,spec] of Object.entries(BUILDING_SPECS)){
    if(spec.input){
      for(const req of spec.input){
        if(req.r === key) lines.push(`${spec.displayName} の原料 (${req.a} ${RESOURCE_META[key].unit})`);
      }
    }
    if(spec.output && spec.output.res === key) lines.push(`${spec.displayName} の生産物 (${spec.output.amount} ${RESOURCE_META[key].unit})`);
  }
  return lines.join('\n') || '特になし';
}

/* Prestige reset */
function prestigeReset(){
  const totalAssets = stats.gold + stats.investment - stats.loan;
  const prestigeGain = Math.max(0, Math.floor(Math.log10(Math.max(1,totalAssets)/100000) * 10) * 10);
  if(prestigeGain <= 0){ showMessage('プレステージ条件を満たしていません。', false); return; }
  if(!confirm(`プレステージを実行しますか？${prestigeGain}⭐を獲得します（進行はリセットされます）`)) return;
  stats.prestige_currency += prestigeGain;
  // simple reset preserving prestige
  const keep = {prestige_currency: stats.prestige_currency};
  stats = Object.assign({
    gold: 1000 + prestigeGain*10,
    investment:0, loan:0, prestige_currency: keep.prestige_currency, tick:0, buildingCountMultiplier:1, resources:{}, buildings:{}, upgrades:{ productionEfficiency:0, warehouseCapacity:0, marketStability:0, productionSpeed:0, autoTransportEfficiency:0, contractEfficiency:0, investmentStability:0, loanInterestReduction:0, advancedAutomation:0}, achievements:{}, market:{priceAdjustment:{},marketFluctuation:1.0}, autoSellEnabled:false
  }, {});
  for(const r in RESOURCE_META) stats.resources[r]=0;
  for(const b in BUILDING_SPECS) stats.buildings[b]=[];
  pushLog(`プレステージ実行: ${prestigeGain}⭐ 獲得`);
  updateDisplay();
}

/* Notifications */
function showMessage(msg, positive){
  const area = document.getElementById('message-area');
  area.textContent = msg;
  area.className = positive ? 'msg-good' : '';
  if(!positive) area.classList.add('msg-bad');
  setTimeout(()=>{ area.className=''; area.textContent=''; }, 4000);
}
function getMaxPurchases(cost){ if(cost===0) return 99999; return Math.floor(stats.gold/cost); }

/* ====== UI initialization ====== */
function initUI(){
  // build grid placeholder
  updateDisplay();
  renderResearch();
  renderAchievements();
  pushLog('ゲーム開始');
}

/* ===== Logging render ===== */
function renderTradeLog(){
  const el = document.getElementById('trade-log');
  el.innerHTML = TRADE_LOG.map(t=>`<div style="padding:6px;border-bottom:1px dashed rgba(255,255,255,0.02);font-size:13px;color:var(--muted)">${t}</div>`).join('');
}

/* ================ Achievements & quests run ================ */
function pushLog(msg){
  TRADE_LOG = TRADE_LOG || [];
  TRADE_LOG.unshift(`${new Date().toLocaleTimeString()} - ${msg}`);
  if(TRADE_LOG.length>200) TRADE_LOG.pop();
  renderTradeLog();
}

/* ================ Tab switching ================ */
function switchTab(id){
  document.querySelectorAll('.tab-content').forEach(x=>x.style.display='none');
  document.getElementById('tab-'+id).style.display='block';
  document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
  // highlight clicked one
  document.querySelectorAll('.tab-button').forEach(b=>{
    if(b.textContent.includes('建設') && id==='build') b.classList.add('active');
    if(b.textContent.includes('資源') && id==='resource') b.classList.add('active');
    if(b.textContent.includes('研究') && id==='research') b.classList.add('active');
    if(b.textContent.includes('実績') && id==='achievement') b.classList.add('active');
  });
}

/* ================ Initial population of UI elements ================ */
function populateInitialElements(){
  // add build buttons container element exists already; updateDisplay will fill
  // wire up loan buttons in status panel
  const loanPanel = document.getElementById('loan-panel');
  loanPanel.innerHTML += ` <button class="button small" onclick="takeLoan(10000)">10,000G借入</button>
    <button class="button small" onclick="repayLoan()">全額返済</button>`;
  // invest panel buttons already in DOM - their handlers call functions we defined
}

/* ======================
   Start loop
   ====================== */
initUI();
populateInitialElements();
updateDisplay();
setInterval(tickLoop, TICK_RATE_MS);

</script>
</body>
</html>
