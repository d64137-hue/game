<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã‚·ãƒ³ãƒ—ãƒ«å·¥æ¥­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ â€” ãƒ•ãƒ«æ”¹è‰¯ç‰ˆ</title>
<style>
/* ===== å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
:root{
  --bg:#121217; --panel:#1e1e28; --muted:#9aa0b4; --accent:#76FF03;
  --card:#171722; --btn:#FFB74D; --danger:#FF7043;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family: "Noto Sans JP", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
body{background:linear-gradient(180deg,#0f0f13, #10101a); color:#E6EEF3; padding:12px;}

/* Container */
#GameArea{max-width:1100px;margin:0 auto;padding:14px;border-radius:12px;background:linear-gradient(180deg,#111118 0%, #161624 100%); box-shadow:0 8px 30px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03);}

/* Header */
.header{display:flex;align-items:center;gap:12px}
h1{margin:0;font-size:20px;color:var(--accent)}
.version{font-size:12px;color:var(--muted);margin-left:6px}

/* Status Panel */
#status-panel{display:flex;flex-wrap:wrap;gap:8px;justify-content:space-between;margin-top:12px;background:var(--panel);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
.status-block{display:flex;gap:10px;align-items:center;font-size:14px}
.status-block strong{color:#fff}
.badge{background:#22222a;padding:4px 8px;border-radius:6px;font-weight:700}
.small{font-size:12px;color:var(--muted)}

/* Tabs */
#tab-container{margin-top:12px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
#tabs{display:flex;background:#13131a;border-bottom:1px solid rgba(255,255,255,0.03)}
.tab-button{flex:1;padding:10px 12px;cursor:pointer;background:transparent;border:none;color:var(--muted);font-weight:600}
.tab-button.active{color:var(--accent);background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent);box-shadow:inset 0 -3px 0 rgba(118,255,3,0.08)}
.tab-content{padding:12px;background:transparent;display:none;color:#dfe7f2}

/* Panels & columns */
.row{display:flex;gap:12px}
.col{flex:1;min-width:200px}
.panel{background:linear-gradient(180deg,#0f1114,#14141a);padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}

/* Resource list */
.resource-item{display:grid;grid-template-columns: 1fr auto auto;gap:8px;align-items:center;padding:6px;border-radius:6px}
.resource-name{font-weight:700;color:#FFEB3B}
.resource-meta{font-size:13px;color:var(--muted)}

/* Buttons */
.button{padding:6px 10px;border-radius:6px;border:none;background:var(--btn);color:#1b1b1b;font-weight:700;cursor:pointer}
.button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.button.small{padding:4px 8px;font-size:13px}

/* Build grid */
.build-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.build-card{background:linear-gradient(180deg,#0f1320,#12121a);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:8px;min-height:92px}
.build-title{font-weight:800}
.build-meta{font-size:13px;color:var(--muted)}

/* Research */
.research-grid{display:flex;flex-wrap:wrap;gap:8px}
.research-card{width:220px;padding:8px;border-radius:8px;background:linear-gradient(180deg,#0f1420,#11111a);border:1px solid rgba(255,255,255,0.02)}
.research-card.locked{opacity:0.5}

/* Achievements */
.ach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px}
.ach-card{padding:8px;border-radius:8px;background:#08110a;border:1px solid rgba(118,255,3,0.08);color:#dfffd8}

/* Production table */
.prod-table{width:100%;border-collapse:collapse;margin-top:6px}
.prod-table th,.prod-table td{padding:6px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px;text-align:left}

/* Tooltip */
.tooltip{position:relative}
.tooltip .tip{position:absolute;left:0;top:calc(100% + 6px);background:#0b0b10;color:#fff;padding:8px;border-radius:6px;font-size:13px;display:none;width:260px;z-index:60;box-shadow:0 6px 20px rgba(0,0,0,0.6)}
.tooltip:hover .tip{display:block}

/* Animations */
.anim-run{animation:runningLight 1.2s infinite}
@keyframes runningLight{0%{box-shadow:0 0 0 rgba(118,255,3,0)}50%{box-shadow:0 6px 20px rgba(118,255,3,0.06)}100%{box-shadow:0 0 0 rgba(118,255,3,0)}}

/* Message area */
#message-area{margin-top:12px;padding:10px;border-radius:6px;background:#0a0a0f;color:#fff;min-height:36px;border:1px solid rgba(255,255,255,0.02)}
.msg-good{color:#000;background:#76FF03;padding:6px;border-radius:6px}
.msg-bad{color:#fff;background:#FF7043;padding:6px;border-radius:6px}

/* Responsive */
@media (max-width:880px){
  .row{flex-direction:column}
  .build-grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
}
</style>
</head>
<body>
<div id="GameArea">
  <div class="header">
    <h1>ã‚·ãƒ³ãƒ—ãƒ«å·¥æ¥­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h1>
    <div class="version">ãƒ•ãƒ«æ”¹è‰¯ç‰ˆ</div>
  </div>

  <div id="status-panel">
    <div class="status-block">
      <div>è³‡é‡‘: <span id="gold-display" class="badge">1000</span></div>
      <div>æŠ•è³‡: <span id="investment-display" class="badge">0</span></div>
      <div id="loan-panel" style="margin-left:10px">å€Ÿå…¥: <span id="loan-display" class="badge">0</span></div>
    </div>
    <div class="status-block">
      <div>Ticks: <span id="tick-display" class="small">0</span></div>
      <div>åœ¨åº«ä¸Šé™: <span id="stock-limit-display" class="small">1000</span></div>
      <div>ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸: <span id="prestige-currency-display" class="badge">0</span></div>
    </div>
  </div>

  <div id="tab-container">
    <div id="tabs">
      <button class="tab-button active" onclick="switchTab('build')">ğŸ›  å»ºè¨­</button>
      <button class="tab-button" onclick="switchTab('resource')">ğŸ“¦ è³‡æºãƒ»å¸‚å ´</button>
      <button class="tab-button" onclick="switchTab('research')">ğŸ”¬ ç ”ç©¶</button>
      <button class="tab-button" onclick="switchTab('achievement')">ğŸ† å®Ÿç¸¾</button>
    </div>

    <div id="tab-build" class="tab-content" style="display:block">
      <div class="row">
        <div class="col panel">
          <h3>å»ºè¨­ã¨ç”Ÿç”£</h3>
          <div style="margin-bottom:8px">
            è³¼å…¥æ•°:
            <button class="button small" onclick="setBuildingCountMultiplier(1)" id="mb-1">x1</button>
            <button class="button small" onclick="setBuildingCountMultiplier(10)" id="mb-10">x10</button>
            <button class="button small" onclick="setBuildingCountMultiplier(100)" id="mb-100">x100</button>
            <button class="button small" onclick="setBuildingCountMultiplier('max')" id="mb-max">MAX</button>
          </div>
          <div id="build-buttons" class="build-grid"></div>
        </div>

        <div class="col panel">
          <h3>ç”Ÿç”£çŠ¶æ³</h3>
          <div id="buildings-status" style="font-size:13px"></div>
          <h4 style="margin-top:8px">ç”Ÿç”£ãƒ¬ãƒ¼ãƒˆ (æ¯åˆ†)</h4>
          <div id="production-rates" class="small"></div>
          <h4 style="margin-top:8px">å»ºç‰©ç¨¼åƒã‚¢ãƒ‹ãƒ¡</h4>
          <div style="font-size:13px;color:var(--muted)">ç¨¼åƒä¸­ã®å»ºç‰©ã¯ç·‘ã®å…‰ã§ç‚¹æ»…ã—ã¾ã™ã€‚</div>
        </div>
      </div>

      <div style="margin-top:8px" class="panel">
        <h3>å¸‚å ´æŠ•è³‡</h3>
        <div id="investment-panel">
          <div>ç¾åœ¨ã®æŠ•è³‡: <span id="investment-status">0</span>G</div>
          <div class="small">æŠ•è³‡ã¯ãƒ©ãƒ³ãƒ€ãƒ å¤‰å‹•ã—ã¾ã™ï¼ˆç ”ç©¶ã§å®‰å®šåŒ–å¯èƒ½ï¼‰</div>
          <div style="margin-top:6px;display:flex;gap:8px">
            <input type="number" id="invest-amount" value="1000" min="100" style="padding:6px;border-radius:6px;background:#0c0c10;border:1px solid rgba(255,255,255,0.02);color:#fff">
            <button class="button" onclick="investMoney(document.getElementById('invest-amount').value)">æŠ•è³‡</button>
            <button class="button ghost" onclick="withdrawInvestment()">å›å</button>
          </div>
        </div>
      </div>

    </div>

    <div id="tab-resource" class="tab-content">
      <div class="row">
        <div class="col panel">
          <h3>è³‡æºä¸€è¦§ï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼‰</h3>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <button class="button small" onclick="filterResource('all')">å…¨ã¦</button>
            <button class="button small" onclick="filterResource('raw')">åŸæ–™</button>
            <button class="button small" onclick="filterResource('intermediate')">åŠ å·¥å“</button>
            <button class="button small" onclick="filterResource('advanced')">ä¸Šä½åŠ å·¥</button>
          </div>
          <div id="resource-list"></div>
          <div id="total-stock-info" class="small" style="margin-top:8px"></div>
        </div>

        <div class="col panel">
          <h3>è²©å£² / è³¼å…¥ å±¥æ­´</h3>
          <div id="trade-log" style="max-height:260px;overflow:auto;font-size:13px;color:var(--muted)"></div>
          <div style="margin-top:8px">
            <button class="button small" onclick="sellAllResources()">å…¨å£²å´</button>
            <button class="button small" onclick="autoSellAll()">è‡ªå‹•å£²å´ON/OFF</button>
          </div>
        </div>
      </div>
    </div>

    <div id="tab-research" class="tab-content">
      <div class="panel">
        <h3>ç ”ç©¶</h3>
        <div>ç ”ç©¶ãƒã‚¤ãƒ³ãƒˆ: <span id="research-points">0</span></div>
        <div id="ig-research-tree" class="research-grid" style="margin-top:8px"></div>
      </div>
      <div class="panel" style="margin-top:8px">
        <h4>èª¬æ˜</h4>
        <div>ç ”ç©¶ã¯ç”Ÿç”£åŠ¹ç‡ã‚„å¸‚å ´å®‰å®šã€ãƒ­ãƒ¼ãƒ³ç·©å’Œãªã©ã‚²ãƒ¼ãƒ å†…ã®å¤šãã®åŠ¹æœã‚’ä¸ãˆã¾ã™ã€‚ç ”ç©¶ã¯è³‡é‡‘ã§è¡Œã„ã¾ã™ã€‚</div>
      </div>
    </div>

    <div id="tab-achievement" class="tab-content">
      <div class="panel">
        <h3>å®Ÿç¸¾</h3>
        <div>å®Ÿç¸¾æ•°: <span id="achieved-count">0</span> / <span id="total-achievements">0</span></div>
        <div id="achievement-panel-container" class="ach-grid" style="margin-top:8px"></div>
      </div>
      <div class="panel" style="margin-top:8px">
        <h3>ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ (è»¢ç”Ÿ)</h3>
        <div>ç²å¾—å¯èƒ½é€šè²¨: <span id="prestige-gain-display">0</span> â­</div>
        <div style="margin-top:6px">
          <button class="button" id="prestige-button" onclick="prestigeReset()">ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸å®Ÿè¡Œ</button>
        </div>
      </div>
    </div>

  </div>

  <div id="message-area">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ æ”¹è‰¯ç‰ˆã‚’æ¥½ã—ã‚“ã§ãã ã•ã„ã€‚</div>
</div>

<script>
/* ======================
   å®šæ•°ãƒ»åˆæœŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
   ====================== */
const TICK_RATE_MS = 200; // 1 tick = 200ms (5 tick = 1s)
const TICKS_PER_MINUTE = Math.round(60000 / TICK_RATE_MS);
const BASE_STOCK_LIMIT = 1000;
const LOAN_BASE_RATE = 0.0005; // åŸºæœ¬åˆ©ç‡/tick
const LOAN_MAX_RATE = 0.02; // ä¸Šé™
const INVEST_BASE_VOLATILITY = 0.01; // æŠ•è³‡ã®æ¨™æº–å¤‰å‹• (Â±1%)
const SELL_PRICE_RATIO = 0.8; // å£²å´ã¯è³¼å…¥ä¾¡æ ¼ã®80%

/* ===== è³‡æºãƒ‡ãƒ¼ã‚¿ï¼ˆã‚«ãƒ†ã‚´ãƒªï¼‰ ===== */
const RESOURCE_META = {
  ore: {name:'é‰„é‰±çŸ³', unit:'å€‹', category:'raw', basePrice:5},
  copper_ore: {name:'éŠ…é‰±çŸ³', unit:'å€‹', category:'raw', basePrice:8},
  coal_ore: {name:'çŸ³ç‚­', unit:'å€‹', category:'raw', basePrice:6},
  alum_ore: {name:'ã‚¢ãƒ«ãƒŸé‰±çŸ³', unit:'å€‹', category:'raw', basePrice:10},
  silicon_ore: {name:'ã‚·ãƒªã‚³ãƒ³é‰±çŸ³', unit:'å€‹', category:'raw', basePrice:12},
  titan_ore: {name:'ãƒã‚¿ãƒ³é‰±çŸ³', unit:'å€‹', category:'raw', basePrice:18},
  iron: {name:'é‰„', unit:'å€‹', category:'intermediate', basePrice:22},
  copper_wire: {name:'éŠ…ç·š', unit:'m', category:'intermediate', basePrice:40},
  alum: {name:'ã‚¢ãƒ«ãƒŸ', unit:'å¡Š', category:'intermediate', basePrice:35},
  steel_copper: {name:'é‰„é‹¼éŠ…', unit:'å¡Š', category:'advanced', basePrice:80},
  wafer: {name:'ã‚¦ã‚§ãƒ', unit:'æš', category:'advanced', basePrice:120},
  alloy: {name:'åˆé‡‘', unit:'å¡Š', category:'advanced', basePrice:160}
};

/* ===== å»ºç‰©ä»•æ§˜ï¼ˆå‡ºåŠ›ãƒ»å…¥åŠ›ï¼‰ ===== */
const BUILDING_SPECS = {
  Mine: {cost:100, displayName:'é‰„æ¡æ˜æ‰€', output:{iron:'ore',amount:1}, time:100, input:null},
  CopperMine: {cost:150, displayName:'éŠ…æ¡æ˜æ‰€', output:{copper_ore:'copper_ore',amount:1}, time:110, input:null},
  CoalMine: {cost:140, displayName:'çŸ³ç‚­æ¡æ˜æ‰€', output:{coal_ore:'coal_ore',amount:1}, time:80, input:null},
  Smelter: {cost:250, displayName:'é‰„è£½éŒ¬æ‰€', output:{iron:'iron',amount:1}, time:150, input:[{r:'ore',a:2},{r:'coal_ore',a:1}]},
  WireMill: {cost:400, displayName:'é›»ç·šå·¥å ´', output:{copper_wire:'copper_wire',amount:1}, time:200, input:[{r:'copper_ore',a:2},{r:'coal_ore',a:1}]},
  SteelMill: {cost:600, displayName:'è£½é‹¼æ‰€', output:{steel_copper:'steel_copper',amount:1}, time:300, input:[{r:'ore',a:1},{r:'copper_ore',a:1},{r:'coal_ore',a:2}]},
  AluminumSmelter: {cost:350, displayName:'ã‚¢ãƒ«ãƒŸè£½éŒ¬æ‰€', output:{alum:'alum',amount:1}, time:180, input:[{r:'alum_ore',a:2},{r:'coal_ore',a:1}]},
  WaferFab: {cost:800, displayName:'ã‚¦ã‚§ãƒå·¥å ´', output:{wafer:'wafer',amount:1}, time:250, input:[{r:'silicon_ore',a:1},{r:'coal_ore',a:2},{r:'alum',a:1}]},
  AlloyForge: {cost:1200, displayName:'åˆé‡‘é›é€ æ‰€', output:{alloy:'alloy',amount:1}, time:400, input:[{r:'titan_ore',a:1},{r:'iron',a:1},{r:'steel_copper',a:1}]},
  AdvancedSmelter: {cost:900, displayName:'ä¸Šç´šè£½éŒ¬æ‰€', output:{steel_copper:'steel_copper',amount:1}, time:250, input:[{r:'ore',a:1},{r:'copper_wire',a:1}]},
  AutoTransporter: {cost:1500, displayName:'è‡ªå‹•æ¬é€æ©Ÿ', output:null, time:20, input:null},
  Warehouse: {cost:2000,displayName:'å€‰åº«',output:null,time:0,input:null},
  TradePost: {cost:5000,displayName:'è‡ªå‹•å–å¼•æ‰€',output:null,time:80,input:null},
  ContractOffice: {cost:3000,displayName:'å¥‘ç´„ã‚ªãƒ•ã‚£ã‚¹',output:null,time:200,input:null}
};

/* ===== åˆæœŸã‚²ãƒ¼ãƒ çŠ¶æ…‹ ===== */
let stats = {
  gold: 1000,
  investment: 0,
  loan: 0,
  prestige_currency: 0,
  tick: 0,
  buildingCountMultiplier: 1,
  resources: {},
  buildings: {},
  upgrades: { productionEfficiency:0, warehouseCapacity:0, marketStability:0, productionSpeed:0, autoTransportEfficiency:0, contractEfficiency:0, investmentStability:0, loanInterestReduction:0, advancedAutomation:0 },
  achievements: {},
  market: { priceAdjustment: {}, marketFluctuation: 1.0 },
  autoSellEnabled: false,
  questLog: []
};

/* åˆæœŸåŒ–ï¼šè³‡æºã¨å»ºç‰©é…åˆ—ã‚’ä½œã‚‹ */
for(const r in RESOURCE_META) stats.resources[r] = 0;
for(const b in BUILDING_SPECS) stats.buildings[b] = [];

/* ===== GLOBAL UPGRADES å®šç¾©ï¼ˆè¿½åŠ åˆ†å«ã‚€ï¼‰ ===== */
const GLOBAL_UPGRADES = {
  productionEfficiency: {displayName:'ç”Ÿç”£æŠ€è¡“å‘ä¸Š', maxLevel:10, baseCost:1000, costMultiplier:1.5, effect: lvl => `ç”Ÿç”£åŠ¹ç‡ +${lvl*5}%`, getCost: lvl => Math.ceil(1000 * Math.pow(1.5, lvl)) },
  warehouseCapacity: {displayName:'å€‰åº«å®¹é‡æ‹¡å¼µ', maxLevel:10, baseCost:1500, costMultiplier:1.7, effect:lvl=>`å€‰åº«+${lvl*50}%`, getCost: lvl => Math.ceil(1500 * Math.pow(1.7, lvl)) },
  marketStability: {displayName:'å¸‚å ´å®‰å®šåŒ–', maxLevel:5, baseCost:1500, costMultiplier:1.8, effect:lvl=>`å£²å´ãƒšãƒŠãƒ«ãƒ†ã‚£ -${lvl*10}%`, getCost:lvl=>Math.ceil(1500*Math.pow(1.8,lvl)) },
  productionSpeed: {displayName:'ç”Ÿç”£é€Ÿåº¦æ”¹å–„', maxLevel:5, baseCost:1200, costMultiplier:1.7, effect:lvl=>`ç”Ÿç”£æ™‚é–“ -${lvl*5}%`, getCost:lvl=>Math.ceil(1200*Math.pow(1.7,lvl)) },
  autoTransportEfficiency: {displayName:'è‡ªå‹•æ¬é€å¼·åŒ–', maxLevel:5, baseCost:800, costMultiplier:1.6, effect:lvl=>`è‡ªå‹•æ¬é€å£²å´é‡ +${lvl}`, getCost:lvl=>Math.ceil(800*Math.pow(1.6,lvl)) },
  contractEfficiency: {displayName:'å¥‘ç´„å¼·åŒ–', maxLevel:5, baseCost:2000, costMultiplier:1.8, effect:lvl=>`å¥‘ç´„å£²å´å ±é…¬ +${lvl*10}%`, getCost:lvl=>Math.ceil(2000*Math.pow(1.8,lvl)) },
  investmentStability: {displayName:'æŠ•è³‡å®‰å®šåŒ–', maxLevel:5, baseCost:1500, costMultiplier:1.5, effect:lvl=>`æŠ•è³‡å¤‰å‹•å¹… -${lvl*2}%`, getCost:lvl=>Math.ceil(1500*Math.pow(1.5,lvl)) },
  loanInterestReduction: {displayName:'ãƒ­ãƒ¼ãƒ³åˆ©å­è»½æ¸›', maxLevel:5, baseCost:2500, costMultiplier:1.5, effect:lvl=>`åˆ©å­ç‡ -${(lvl*0.5).toFixed(2)}%`, getCost:lvl=>Math.ceil(2500*Math.pow(1.5,lvl)) },
  advancedAutomation: {displayName:'é«˜åº¦è‡ªå‹•åŒ–', maxLevel:5, baseCost:3000, costMultiplier:2.0, effect:lvl=>`è‡ªå‹•åŒ–é€Ÿåº¦ +${lvl*20}%`, getCost:lvl=>Math.ceil(3000*Math.pow(2,lvl)) }
};

/* ===== å®Ÿç¸¾å®šç¾© ===== */
const ACHIEVEMENT_DEFINITIONS = {
  first_build: {name:'æœ€åˆã®ä¸€æ­©', desc:'ä»»æ„ã®å»ºç‰©ã‚’1ã¤å»ºè¨­ã™ã‚‹', check: ()=>getTotalBuildings()>=1},
  earn_1k: {name:'åˆæœŸæŠ•è³‡å®¶', desc:'æ‰€æŒé‡‘+æŠ•è³‡ã®åˆè¨ˆãŒ1,000Gã‚’è¶…ãˆã‚‹', check: ()=>stats.gold+stats.investment>=1000 && stats.tick>10},
  earn_10k: {name:'ä¸­å …ä¼æ¥­', desc:'ç·è³‡ç”£ãŒ10,000Gã‚’è¶…ãˆã‚‹', check: ()=>stats.gold+stats.investment>=10000},
  make_wafer: {name:'ã‚¦ã‚§ãƒç”Ÿç”£è€…', desc:'åˆã‚ã¦ã‚¦ã‚§ãƒã‚’ç”Ÿç”£ã™ã‚‹', check: ()=>stats.resources.wafer>0},
  build_all_mines: {name:'è³‡æºç‹', desc:'6ç¨®ã®æ¡æ˜æ‰€ã™ã¹ã¦ã‚’1ã¤ä»¥ä¸Šå»ºè¨­', check: ()=>['Mine','CopperMine','CoalMine','AluminumSmelter','WaferFab','AlloyForge'].every(k=>stats.buildings[k] && stats.buildings[k].length>0)}
};

/* ===== ãƒ˜ãƒ«ãƒ‘ãƒ¼ ===== */
function formatNum(n){ if(n>=1e9) return (n/1e9).toFixed(2)+'B'; if(n>=1e6) return (n/1e6).toFixed(2)+'M'; if(n>=1000) return (n/1000).toFixed(2)+'K'; return Math.floor(n); }
function getTotalBuildings(){ return Object.values(stats.buildings).flat().length; }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

/* ======================
   å¸‚å ´ãƒ»ä¾¡æ ¼ãƒ­ã‚¸ãƒƒã‚¯
   ====================== */
function getResourcePrice(key){
  const meta = RESOURCE_META[key];
  if(!meta) return 1;
  const base = meta.basePrice;
  const fluct = stats.market.marketFluctuation;
  const adj = 1 + (stats.market.priceAdjustment[key] || 0);
  const price = Math.max(1, Math.floor(base * fluct * adj));
  return price;
}

/* pricePressure: å£²å´ã«ã‚ˆã‚‹ä¾¡æ ¼ä¸‹è½ã‚’åŠ ç®—ã™ã‚‹ */
function applySellPriceImpact(resource, amount){
  const stabilityLevel = stats.upgrades.marketStability || 0;
  const reduction = 1 - stabilityLevel*0.1; // Lv1ã§10%è»½æ¸›
  const impact = Math.min(0.3, (amount/1000) * 0.1) * reduction;
  stats.market.priceAdjustment[resource] = (stats.market.priceAdjustment[resource] || 0) - impact;
}

/* å¸‚å ´ã®è‡ªå‹•å›å¾©ï¼ˆtickã§å‘¼ã¶ï¼‰ */
function updateMarket(){
  if(stats.tick % Math.round(TICKS_PER_MINUTE/30) === 0){ // approx every 2s
    const maxFluct = 0.05;
    const change = (Math.random()*maxFluct*2) - maxFluct;
    stats.market.marketFluctuation = clamp(stats.market.marketFluctuation + change, 0.8, 1.2);
  }
  // priceAdjustment å›å¾©
  for(const k in stats.market.priceAdjustment){
    if(stats.market.priceAdjustment[k] < 0){
      stats.market.priceAdjustment[k] = Math.min(0, stats.market.priceAdjustment[k] + 0.001 * (1 + stats.upgrades.marketStability*0.2));
    }
  }
}

/* ======================
   å»ºç‰©ã‚¯ãƒ©ã‚¹ï¼ˆå˜ç´”ï¼‰ and ç”Ÿç”£
   ====================== */
class Building {
  constructor(type){
    this.type = type;
    this.spec = BUILDING_SPECS[type];
    this.timer = 0;
    this.isStalled = false;
  }
  tick(){
    this.timer++;
    this.isStalled = false;
    if(!this.spec.output){
      // Utility building actions
      if(this.type === 'AutoTransporter' && this.timer >= this.spec.time){
        autoSellOneResource();
        this.timer = 0;
      } else if(this.type === 'TradePost' && this.timer >= this.spec.time){
        autoTradeHighValueResource();
        this.timer = 0;
      } else if(this.type === 'ContractOffice' && this.timer >= this.spec.time){
        autoContractSell();
        this.timer = 0;
      }
      return false;
    }
    // Production speed effect
    const prodSpeedLevel = stats.upgrades.productionSpeed || 0;
    const prodEff = 1 - (prodSpeedLevel * 0.05);
    const productionMultiplier = Math.max(0.2, prodEff - stats.upgrades.productionEfficiency*0.05);
    const effectiveTime = Math.max(1, Math.floor(this.spec.time * productionMultiplier));

    if(this.timer >= effectiveTime){
      // stock limit
      const stockLimit = computeStockLimit();
      const outRes = this.spec.output.iron ? this.spec.output.iron : this.spec.output; // compatibility
      const outKey = Object.values(this.spec.output)[0] || this.spec.output; // if {iron:'ore',amount:1} style earlier then adapt
      // Our spec format: output:{iron:'ore',amount:1} earlier; in current we used {output:{iron:'iron',amount:1}}-- but to avoid confusion we will refer spec.output keys:
      // We defined spec.output e.g. {iron:'ore',amount:1} (odd). Use mapping at top: Let's use object: output: { res:'iron', amount:1 }
      // Adapt: if spec.output.res exists -> use that
      const outputRes = this.spec.output.res || (this.spec.output && this.spec.output.resource) || Object.keys(this.spec.output)[0];
      const outputAmt = this.spec.output.amount || (this.spec.output && this.spec.output.amount) || (this.spec.output[outputRes] || 1);

      if(stats.resources[outputRes] + outputAmt > stockLimit){ this.isStalled = true; return false; }
      if(this.spec.input){
        let can = true;
        for(const req of this.spec.input){
          if(stats.resources[req.r] < req.a){ can = false; break; }
        }
        if(!can){ this.isStalled = true; return false; }
        for(const req of this.spec.input){ stats.resources[req.r] -= req.a; }
      }
      stats.resources[outputRes] += outputAmt;
      this.timer = 0;
      return true;
    }
    return false;
  }
}

/* ======================
   è‡ªå‹•åŒ–æ©Ÿèƒ½ï¼ˆAutoTransporter, TradePost, ContractOfficeï¼‰
   ====================== */
const AUTO_SELL_ORDER = ['iron','copper_wire','steel_copper','alum','wafer','alloy'];
function autoSellOneResource(){
  // è‡ªå‹•æ¬é€æ©Ÿã¯è¨­å®šã§å£²å´æ•°å¢—åŠ 
  const amt = 1 + (stats.upgrades.autoTransportEfficiency || 0);
  for(const res of AUTO_SELL_ORDER){
    if(stats.resources[res] >= amt){
      const price = getResourcePrice(res);
      const revenue = Math.floor(price * amt);
      stats.gold += revenue;
      stats.resources[res] -= amt;
      applySellPriceImpact(res, amt);
      pushLog(`è‡ªå‹•æ¬é€: ${RESOURCE_META[res].name} x${amt} ã‚’å£²å´ã— ${revenue}G ã‚’ç²å¾—`);
      return;
    }
  }
}
function autoTradeHighValueResource(){
  const candidates = ['wafer','alloy'];
  for(const c of candidates){
    if(stats.resources[c] > 0){
      const price = getResourcePrice(c);
      const revenue = Math.floor(price * 0.9);
      stats.gold += revenue;
      stats.resources[c] -= 1;
      applySellPriceImpact(c, 1);
      pushLog(`è‡ªå‹•å–å¼•æ‰€: ${RESOURCE_META[c].name} ã‚’å£²å´ (90%) ã§ ${revenue}G`);
      return;
    }
  }
}
function autoContractSell(){
  const sellables = ['iron','copper_wire','steel_copper','alum','wafer','alloy'];
  const avail = sellables.filter(r=>stats.resources[r] > 0);
  if(avail.length===0) return;
  const pick = avail[Math.floor(Math.random()*avail.length)];
  const base = RESOURCE_META[pick].basePrice;
  const multiplier = 1.5 + (stats.upgrades.contractEfficiency||0)*0.1;
  const revenue = Math.floor(base * multiplier);
  stats.gold += revenue;
  stats.resources[pick] -= 1;
  pushLog(`å¥‘ç´„ã‚ªãƒ•ã‚£ã‚¹: ${RESOURCE_META[pick].name} ã‚’å¥‘ç´„å£²å´ã§ ${revenue}G (å¸‚å ´å½±éŸ¿ãªã—)`);
}

/* ======================
   ç”Ÿç”£ãƒ«ãƒ¼ãƒ— / tick
   ====================== */
function computeStockLimit(){
  const base = BASE_STOCK_LIMIT;
  const warehouseBonus = (stats.buildings.Warehouse ? stats.buildings.Warehouse.length : 0) * 5000;
  const capacityLevel = stats.upgrades.warehouseCapacity || 0;
  return Math.floor(base + warehouseBonus * (1 + capacityLevel*0.5));
}
function tickLoop(){
  stats.tick++;
  // market
  updateMarket();

  // update investments
  updateInvestment();

  // loan interest
  updateLoanInterest();

  // buildings production
  for(const type in stats.buildings){
    for(const b of stats.buildings[type]){
      b.tick && b.tick();
    }
  }

  // auto-sell toggle (if enabled)
  if(stats.autoSellEnabled){
    for(let i=0;i<stats.buildings.AutoTransporter.length;i++){
      autoSellOneResource();
    }
  }

  // achievements check
  checkAchievements();

  // update UI
  updateDisplay();

  // periodic events (every 60 ticks ~ approx every 12s at TICK_RATE_MS=200)
  if(stats.tick % (TICKS_PER_MINUTE/5) === 0) maybeSpawnEvent();
}

/* æŠ•è³‡æ›´æ–° */
function updateInvestment(){
  if(stats.investment <= 0) return;
  const stabilityLevel = stats.upgrades.investmentStability || 0;
  const volatility = INVEST_BASE_VOLATILITY * (1 - stabilityLevel*0.15); // æ¸›è¡°
  const fluct = (Math.random()*2-1) * volatility;
  const delta = Math.floor(stats.investment * fluct);
  stats.investment = Math.max(0, stats.investment + delta);
}

/* ãƒ­ãƒ¼ãƒ³åˆ©å­æ›´æ–°ï¼ˆç·©å’Œç‰ˆï¼‰ */
function updateLoanInterest(){
  if(stats.loan <= 0) return;
  const reductionLevel = stats.upgrades.loanInterestReduction || 0;
  let rate = LOAN_BASE_RATE * (1 - reductionLevel*0.12); // each level reduces 12% of base
  // step function by amount
  const step = Math.floor(stats.loan / 10000) * 0.0002;
  rate = Math.min(rate + step, LOAN_MAX_RATE);
  stats.loan += Math.floor(stats.loan * rate);
}

/* =============== UI / æ“ä½œ =============== */
let buildingCountMultiplier = 1;

function setBuildingCountMultiplier(n){
  buildingCountMultiplier = n;
  document.querySelectorAll('[id^="mb-"]').forEach(b=>b.classList.remove('selected'));
  // highlight chosen
  updateDisplay();
}

function getMaxPurchases(cost){
  if(cost === 0) return 99999;
  return Math.floor(stats.gold / cost);
}

/* Build a building */
function buildBuilding(type){
  const spec = BUILDING_SPECS[type];
  let count = buildingCountMultiplier;
  if(count === 'max') count = getMaxPurchases(spec.cost);
  if(count <= 0){ pushLog('è³¼å…¥æ•°0'); return; }
  const totalCost = spec.cost * count;
  if(stats.gold < totalCost){ showMessage('è³‡é‡‘ä¸è¶³', true); return; }
  stats.gold -= totalCost;
  for(let i=0;i<count;i++){
    stats.buildings[type].push(new Building(type));
  }
  pushLog(`${spec.displayName} ã‚’ ${count}åŸº å»ºè¨­ã—ã¾ã—ãŸ (${totalCost}G)`);
  updateDisplay();
}

/* Sell resource */
function sellResource(key){
  const amt = stats.resources[key];
  if(amt <= 0){ showMessage('å£²å´å¯èƒ½ãªè³‡æºãŒã‚ã‚Šã¾ã›ã‚“', false); return; }
  const price = getResourcePrice(key);
  const revenue = Math.floor(price * SELL_PRICE_RATIO * amt);
  stats.resources[key] = 0;
  stats.gold += revenue;
  applySellPriceImpact(key, amt);
  pushLog(`${RESOURCE_META[key].name} x${amt} ã‚’å£²å´ã— ${revenue}G ã‚’ç²å¾—`);
  showMessage(`${RESOURCE_META[key].name} ã‚’å£²å´ã—ã¾ã—ãŸ`, true);
  updateDisplay();
}

/* Sell all resources */
function sellAllResources(){
  let totalRevenue = 0;
  let soldTypes = 0;
  const stabilityLevel = stats.upgrades.marketStability || 0;
  const reduction = 1 - (stabilityLevel * 0.1);
  for(const r in stats.resources){
    const amount = stats.resources[r];
    if(amount > 0){
      const p = getResourcePrice(r);
      const rev = Math.floor(p * SELL_PRICE_RATIO * amount);
      totalRevenue += rev;
      stats.resources[r] = 0;
      applySellPriceImpact(r, amount * reduction);
      soldTypes++;
    }
  }
  if(totalRevenue > 0){
    stats.gold += totalRevenue;
    pushLog(`å…¨è³‡æºã‚’å£²å´ã— ${totalRevenue}G ã‚’å¾—ãŸ (ç¨®é¡: ${soldTypes})`);
    showMessage(`å…¨è³‡æºã‚’å£²å´ã—ã¾ã—ãŸ: ${formatNum(totalRevenue)}G`, true);
  } else {
    showMessage('å£²å´å¯èƒ½ãªè³‡æºã¯ã‚ã‚Šã¾ã›ã‚“', false);
  }
  updateDisplay();
}

/* Auto-sell toggle */
function autoSellAll(){
  stats.autoSellEnabled = !stats.autoSellEnabled;
  pushLog(`è‡ªå‹•å£²å´: ${stats.autoSellEnabled ? 'ON' : 'OFF'}`);
  updateDisplay();
}

/* Invest / withdraw */
function investMoney(val){
  const amount = parseInt(val);
  if(isNaN(amount) || amount <= 0){ showMessage('æœ‰åŠ¹ãªæŠ•è³‡é¡ã‚’å…¥åŠ›', false); return; }
  if(stats.gold < amount){ showMessage('è³‡é‡‘ä¸è¶³', false); return; }
  stats.gold -= amount;
  stats.investment += amount;
  pushLog(`${formatNum(amount)}G ã‚’æŠ•è³‡ã—ã¾ã—ãŸ`);
  updateDisplay();
}
function withdrawInvestment(){
  if(stats.investment <= 0){ showMessage('æŠ•è³‡ãªã—', false); return; }
  stats.gold += stats.investment;
  pushLog(`æŠ•è³‡ ${formatNum(stats.investment)}G ã‚’å›åã—ã¾ã—ãŸ`);
  stats.investment = 0;
  updateDisplay();
}

/* Loan */
function takeLoan(amount){
  const amt = parseInt(amount);
  if(isNaN(amt) || amt<=0) return;
  if(stats.loan + amt > 2000000){ showMessage('å€Ÿå…¥ä¸Šé™ã‚’è¶…ãˆã¾ã™', false); return; }
  stats.loan += amt;
  stats.gold += amt;
  pushLog(`éŠ€è¡Œã‹ã‚‰ ${formatNum(amt)}G ã‚’å€Ÿå…¥`);
  updateDisplay();
}
function repayLoan(){
  if(stats.loan <= 0){ showMessage('å€Ÿå…¥ãªã—', false); return; }
  if(stats.gold >= stats.loan){
    stats.gold -= stats.loan;
    pushLog(`ãƒ­ãƒ¼ãƒ³ ${formatNum(stats.loan)}G ã‚’å…¨é¡è¿”æ¸ˆ`);
    stats.loan = 0;
    updateDisplay();
  } else {
    showMessage('è¿”æ¸ˆè³‡é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™', false);
  }
}

/* Research */
const RESEARCH_NODES = [
  {id:'r_prod', title:'åŠ¹ç‡åŒ– I', cost:200, desc:'å…¨è¨­å‚™ã®ç”Ÿç”£åŠ¹ç‡ +10%', prereq:null, effect: (g)=>{ g.upgrades.productionEfficiency += 1; }},
  {id:'r_prod2', title:'åŠ¹ç‡åŒ– II', cost:800, desc:'å…¨è¨­å‚™ã®ç”Ÿç”£åŠ¹ç‡ +20%', prereq:'r_prod', effect:(g)=>{ g.upgrades.productionEfficiency += 2; }},
  {id:'r_market', title:'å¸‚å ´å®‰å®šåŒ–', cost:300, desc:'å£²å´ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’è»½æ¸›', prereq:null, effect:(g)=>{ g.upgrades.marketStability += 1; }},
  {id:'r_auto', title:'è‡ªå‹•åŒ–åŸºç¤', cost:500, desc:'è‡ªå‹•æ¬é€ã®åŠ¹ç‡ã‚’ä¸Šã’ã‚‹', prereq:null, effect:(g)=>{ g.upgrades.autoTransportEfficiency += 1; }},
  {id:'r_loan', title:'ãƒ­ãƒ¼ãƒ³ç®¡ç†', cost:1000, desc:'ãƒ­ãƒ¼ãƒ³åˆ©å­ã‚’è»½æ¸›', prereq:null, effect:(g)=>{ g.upgrades.loanInterestReduction += 1; }},
  {id:'r_invest', title:'æŠ•è³‡å®‰å®šåŒ–', cost:700, desc:'æŠ•è³‡å¤‰å‹•ã‚’å°ã•ãã™ã‚‹', prereq:null, effect:(g)=>{ g.upgrades.investmentStability += 1; }},
  {id:'r_speed', title:'ç”Ÿç”£é€Ÿåº¦', cost:1200, desc:'ç”Ÿç”£é€Ÿåº¦ã‚’æ—©ã‚ã‚‹', prereq:'r_prod', effect:(g)=>{ g.upgrades.productionSpeed += 1; }}
];

function renderResearch(){
  const cont = document.getElementById('ig-research-tree');
  cont.innerHTML = '';
  RESEARCH_NODES.forEach(node=>{
    const unlocked = !!stats.research?.[node.id];
    const locked = node.prereq && !stats.research?.[node.prereq];
    const card = document.createElement('div');
    card.className = 'research-card' + (locked ? ' locked' : '');
    card.innerHTML = `<div style="font-weight:800">${node.title}</div>
      <div style="font-size:13px;color:var(--muted)">${node.desc}</div>
      <div style="margin-top:6px">${unlocked ? 'å–å¾—æ¸ˆ' : `ã‚³ã‚¹ãƒˆ: ${node.cost}G`}</div>
      <div style="margin-top:6px"><button class="button small" ${locked||unlocked? 'disabled':''} onclick="buyResearch('${node.id}')">${unlocked? 'å–å¾—æ¸ˆ':'ç ”ç©¶'}</button></div>`;
    cont.appendChild(card);
  });
}
function buyResearch(id){
  const node = RESEARCH_NODES.find(n=>n.id===id);
  if(!node) return;
  if(stats.gold < node.cost){ showMessage('è³‡é‡‘ä¸è¶³ã§ç ”ç©¶ã§ãã¾ã›ã‚“', false); return; }
  if(node.prereq && !stats.research?.[node.prereq]){ showMessage('å‰æãŒæœªé”æˆã§ã™', false); return; }
  stats.gold -= node.cost;
  stats.research = stats.research || {};
  stats.research[id] = true;
  node.effect(stats);
  pushLog(`ç ”ç©¶ ${node.title} ã‚’ç¿’å¾—`);
  renderResearch();
  updateDisplay();
}

/* Achievements */
function checkAchievements(){
  for(const key in ACHIEVEMENT_DEFINITIONS){
    if(!stats.achievements[key] && ACHIEVEMENT_DEFINITIONS[key].check()){
      stats.achievements[key] = true;
      pushLog(`ğŸ† å®Ÿç¸¾é”æˆ: ${ACHIEVEMENT_DEFINITIONS[key].name}`);
      showMessage(`å®Ÿç¸¾é”æˆ: ${ACHIEVEMENT_DEFINITIONS[key].name}`, true);
    }
  }
  renderAchievements();
}
function renderAchievements(){
  const panel = document.getElementById('achievement-panel-container');
  panel.innerHTML = '';
  let total = 0, achieved = 0;
  for(const key in ACHIEVEMENT_DEFINITIONS){
    total++;
    const def = ACHIEVEMENT_DEFINITIONS[key];
    const unlocked = !!stats.achievements[key];
    if(unlocked) achieved++;
    const el = document.createElement('div');
    el.className = 'ach-card';
    el.style.opacity = unlocked ? 1 : 0.5;
    el.innerHTML = `<div style="font-weight:800">${def.name}</div><div style="font-size:13px;color:var(--muted)">${def.desc}</div>`;
    panel.appendChild(el);
  }
  document.getElementById('total-achievements').textContent = total;
  document.getElementById('achieved-count').textContent = achieved;
}

/* Quest system: example simple quests */
const QUESTS = [
  {id:'q1', title:'æ¡æ˜é–‹å§‹', desc:'æ¡æ˜æ‰€ã‚’1åŸºå»ºã¦ã‚‹', check:()=>getTotalBuildings()>=1, reward: ()=>{ stats.gold += 200; pushLog('ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬: 200G'); }},
  {id:'q2', title:'é‰„ã‚’é›†ã‚ã‚‹', desc:'é‰„ã‚’50å€‹ç”Ÿç”£ã™ã‚‹', check:()=>stats.resources.iron >= 50, reward: ()=>{ stats.prestige_currency += 5; pushLog('ã‚¯ã‚¨ã‚¹ãƒˆå ±é…¬: ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸+5'); }}
];
function checkQuests(){
  QUESTS.forEach(q=>{
    if(!stats.quests) stats.quests = {};
    if(!stats.quests[q.id] && q.check()){
      stats.quests[q.id] = true;
      q.reward();
      pushLog(`ã‚¯ã‚¨ã‚¹ãƒˆé”æˆ: ${q.title}`);
    }
  });
}

/* Random events */
function maybeSpawnEvent(){
  if(Math.random() < 0.06){ // ~6% chance
    const events = [
      ()=>{ // è³‡æºãƒœãƒ¼ãƒŠã‚¹
        const rKeys = Object.keys(RESOURCE_META);
        const pick = rKeys[Math.floor(Math.random()*rKeys.length)];
        const amt = Math.floor(Math.random()*10)+5;
        stats.resources[pick] += amt;
        pushLog(`ã‚¤ãƒ™ãƒ³ãƒˆ: ${RESOURCE_META[pick].name} ã‚’ãƒœãƒ¼ãƒŠã‚¹ã§ ${amt} å—é ˜`);
      },
      ()=>{ // å¸‚å ´æš´è½
        for(const k in stats.market.priceAdjustment) stats.market.priceAdjustment[k] -= 0.02;
        pushLog('ã‚¤ãƒ™ãƒ³ãƒˆ: å¸‚å ´ãŒä¸€æ™‚çš„ã«ä¸å®‰å®šã«');
      },
      ()=>{ // æŠ•è³‡é…å½“
        const gain = Math.floor((Math.random()*0.2+0.1) * Math.max(100, stats.investment));
        stats.gold += gain;
        pushLog(`ã‚¤ãƒ™ãƒ³ãƒˆ: æŠ•è³‡é…å½“ ${gain}G ã‚’å—å–`);
      }
    ];
    const ev = events[Math.floor(Math.random()*events.length)];
    ev();
  }
}

/* Trade log */
let TRADE_LOG = [];
function pushLog(text){
  TRADE_LOG.unshift(`${new Date().toLocaleTimeString()} - ${text}`);
  if(TRADE_LOG.length > 200) TRADE_LOG.pop();
  renderTradeLog();
}
function renderTradeLog(){
  const el = document.getElementById('trade-log');
  el.innerHTML = TRADE_LOG.map(t=>`<div style="padding:6px;border-bottom:1px dashed rgba(255,255,255,0.02);font-size:13px;color:var(--muted)">${t}</div>`).join('');
}

/* Display: resources, buildings, production rates, research etc. */
let resourceFilter = 'all';
function filterResource(cat){ resourceFilter = cat; updateDisplay(); }

/* compute production per minute from active buildings */
function calcProductionPerMinute(){
  const totals = {};
  for(const type in stats.buildings){
    const spec = BUILDING_SPECS[type];
    if(!spec || !spec.output) continue;
    const count = stats.buildings[type].length;
    if(count === 0) continue;
    // production speed and efficiency
    const prodSpeedLevel = stats.upgrades.productionSpeed || 0;
    const prodEff = 1 - (prodSpeedLevel * 0.05) - (stats.upgrades.productionEfficiency||0)*0.05;
    const effectiveTime = Math.max(1, Math.floor(spec.time * Math.max(0.2, prodEff)));
    const cyclesPerMin = TICKS_PER_MINUTE / effectiveTime;
    const perMin = cyclesPerMin * spec.output.amount * count;
    const outKey = spec.output.res;
    totals[outKey] = (totals[outKey] || 0) + perMin;
  }
  return totals;
}

function updateDisplay(){
  // Status
  document.getElementById('gold-display').textContent = formatNum(stats.gold);
  document.getElementById('investment-display').textContent = formatNum(stats.investment);
  document.getElementById('loan-display').textContent = formatNum(stats.loan);
  document.getElementById('tick-display').textContent = stats.tick;
  document.getElementById('prestige-currency-display').textContent = stats.prestige_currency;
  const stockLimit = computeStockLimit();
  document.getElementById('stock-limit-display').textContent = formatNum(stockLimit);

  // Build buttons
  const buildButtons = document.getElementById('build-buttons');
  buildButtons.innerHTML = '';
  for(const type in BUILDING_SPECS){
    const spec = BUILDING_SPECS[type];
    const cost = spec.cost;
    let buyCount = buildingCountMultiplier;
    if(buyCount === 'max') buyCount = getMaxPurchases(cost);
    const totalCost = cost * buyCount;
    const canBuy = stats.gold >= cost;
    const btn = document.createElement('div');
    btn.className = 'build-card';
    btn.innerHTML = `<div class="build-title">${spec.displayName}</div>
      <div class="build-meta">ã‚³ã‚¹ãƒˆ: ${cost}G ${spec.output ? '| å‡ºåŠ›: ' + (spec.output.res) : ''}</div>
      <div style="margin-top:auto;display:flex;gap:8px;justify-content:space-between">
        <div class="small">æ‰€æŒ: ${stats.buildings[type].length}</div>
        <div>
          <button class="button small" ${!canBuy?'disabled':''} onclick="buildBuilding('${type}')">å»ºè¨­ ${buyCount==='max'? '(MAX)':`(${buyCount})`}</button>
        </div>
      </div>`;
    buildButtons.appendChild(btn);
  }

  // Buildings status
  const bs = document.getElementById('buildings-status');
  bs.innerHTML = '';
  for(const type in stats.buildings){
    const spec = BUILDING_SPECS[type];
    const count = stats.buildings[type].length;
    if(count === 0) continue;
    const stalled = stats.buildings[type].filter(b=>b.isStalled).length;
    const el = document.createElement('div');
    el.style.display='flex';el.style.justifyContent='space-between';el.style.alignItems='center';
    el.innerHTML = `<div><strong>${spec.displayName}</strong> ${count}åŸº ${stalled>0?`(åœæ­¢:${stalled})`:''}</div>
      <div class="small">${spec.output? `å‡ºåŠ›: ${spec.output.res}`:''}</div>`;
    if(stalled===0) el.classList.add('anim-run');
    bs.appendChild(el);
  }

  // Production rates per minute
  const rates = calcProductionPerMinute();
  const prDiv = document.getElementById('production-rates');
  prDiv.innerHTML = '';
  for(const k in rates){
    const name = RESOURCE_META[k].name;
    prDiv.innerHTML += `<div class="small">${name}: ${rates[k].toFixed(1)} /åˆ†</div>`;
  }
  if(Object.keys(rates).length===0) prDiv.innerHTML = '<div class="small" style="color:var(--muted)">ç¨¼åƒä¸­ã®ç”Ÿç”£è¨­å‚™ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';

  // Resource list
  const resourceList = document.getElementById('resource-list');
  resourceList.innerHTML = '';
  let totalStock = 0;
  for(const key in stats.resources){
    totalStock += stats.resources[key];
    const meta = RESOURCE_META[key];
    if(resourceFilter !== 'all' && meta.category !== resourceFilter) continue;
    const price = getResourcePrice(key);
    const priceChangePercent = ((price / meta.basePrice) - 1) * 100;
    let changeClass = priceChangePercent > 0.1 ? 'price-up' : (priceChangePercent < -0.1 ? 'price-down' : '');
    const item = document.createElement('div');
    item.className = 'resource-item';
    item.innerHTML = `<div>
        <div class="resource-name">${meta.name} <span class="small">(${key})</span></div>
        <div class="resource-meta">${stats.resources[key]} ${meta.unit} / ä¾¡æ ¼: ${price}G</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
        <div class="small ${changeClass}">${priceChangePercent.toFixed(1)}%</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="button small" ${stats.resources[key]===0?'disabled':''} onclick="sellResource('${key}')">å£²å´ (${Math.floor(price*SELL_PRICE_RATIO)}G)</button>
        <button class="button small ghost" onclick="showResourceInfo('${key}')">èª¬æ˜</button>
      </div>`;
    resourceList.appendChild(item);
  }
  document.getElementById('total-stock-info').textContent = `ç·åœ¨åº«: ${totalStock} / ä¸Šé™: ${formatNum(computeStockLimit())}`;

  // Investment panel
  document.getElementById('investment-status').textContent = `${formatNum(stats.investment)}G`;

  // Research UI
  document.getElementById('research-points').textContent = (stats.researchPoints || 0);
  renderResearch();

  // Achievements
  renderAchievements();

  // Trade log
  renderTradeLog();

  // Prestige calculation
  const totalAssets = stats.gold + stats.investment - stats.loan;
  const prestigeGain = Math.max(0, Math.floor(Math.log10(Math.max(1,totalAssets)/100000) * 10) * 10);
  document.getElementById('prestige-gain-display').textContent = prestigeGain;
  document.getElementById('prestige-button').disabled = totalAssets < 100000;
}

/* Resource info modal */
function showResourceInfo(key){
  const meta = RESOURCE_META[key];
  alert(`${meta.name}\nã‚«ãƒ†ã‚´ãƒª: ${meta.category}\nåŸºåº•ä¾¡æ ¼: ${meta.basePrice}G\nå˜ä½: ${meta.unit}\n\nç”¨é€”:\n` + listUsage(key));
}
function listUsage(key){
  // list building inputs that require this resource and building that outputs it
  let lines = [];
  for(const [bkey,spec] of Object.entries(BUILDING_SPECS)){
    if(spec.input){
      for(const req of spec.input){
        if(req.r === key) lines.push(`${spec.displayName} ã®åŸæ–™ (${req.a} ${RESOURCE_META[key].unit})`);
      }
    }
    if(spec.output && spec.output.res === key) lines.push(`${spec.displayName} ã®ç”Ÿç”£ç‰© (${spec.output.amount} ${RESOURCE_META[key].unit})`);
  }
  return lines.join('\n') || 'ç‰¹ã«ãªã—';
}

/* Prestige reset */
function prestigeReset(){
  const totalAssets = stats.gold + stats.investment - stats.loan;
  const prestigeGain = Math.max(0, Math.floor(Math.log10(Math.max(1,totalAssets)/100000) * 10) * 10);
  if(prestigeGain <= 0){ showMessage('ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“ã€‚', false); return; }
  if(!confirm(`ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ${prestigeGain}â­ã‚’ç²å¾—ã—ã¾ã™ï¼ˆé€²è¡Œã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ï¼‰`)) return;
  stats.prestige_currency += prestigeGain;
  // simple reset preserving prestige
  const keep = {prestige_currency: stats.prestige_currency};
  stats = Object.assign({
    gold: 1000 + prestigeGain*10,
    investment:0, loan:0, prestige_currency: keep.prestige_currency, tick:0, buildingCountMultiplier:1, resources:{}, buildings:{}, upgrades:{ productionEfficiency:0, warehouseCapacity:0, marketStability:0, productionSpeed:0, autoTransportEfficiency:0, contractEfficiency:0, investmentStability:0, loanInterestReduction:0, advancedAutomation:0}, achievements:{}, market:{priceAdjustment:{},marketFluctuation:1.0}, autoSellEnabled:false
  }, {});
  for(const r in RESOURCE_META) stats.resources[r]=0;
  for(const b in BUILDING_SPECS) stats.buildings[b]=[];
  pushLog(`ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸å®Ÿè¡Œ: ${prestigeGain}â­ ç²å¾—`);
  updateDisplay();
}

/* Notifications */
function showMessage(msg, positive){
  const area = document.getElementById('message-area');
  area.textContent = msg;
  area.className = positive ? 'msg-good' : '';
  if(!positive) area.classList.add('msg-bad');
  setTimeout(()=>{ area.className=''; area.textContent=''; }, 4000);
}
function getMaxPurchases(cost){ if(cost===0) return 99999; return Math.floor(stats.gold/cost); }

/* ====== UI initialization ====== */
function initUI(){
  // build grid placeholder
  updateDisplay();
  renderResearch();
  renderAchievements();
  pushLog('ã‚²ãƒ¼ãƒ é–‹å§‹');
}

/* ===== Logging render ===== */
function renderTradeLog(){
  const el = document.getElementById('trade-log');
  el.innerHTML = TRADE_LOG.map(t=>`<div style="padding:6px;border-bottom:1px dashed rgba(255,255,255,0.02);font-size:13px;color:var(--muted)">${t}</div>`).join('');
}

/* ================ Achievements & quests run ================ */
function pushLog(msg){
  TRADE_LOG = TRADE_LOG || [];
  TRADE_LOG.unshift(`${new Date().toLocaleTimeString()} - ${msg}`);
  if(TRADE_LOG.length>200) TRADE_LOG.pop();
  renderTradeLog();
}

/* ================ Tab switching ================ */
function switchTab(id){
  document.querySelectorAll('.tab-content').forEach(x=>x.style.display='none');
  document.getElementById('tab-'+id).style.display='block';
  document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
  // highlight clicked one
  document.querySelectorAll('.tab-button').forEach(b=>{
    if(b.textContent.includes('å»ºè¨­') && id==='build') b.classList.add('active');
    if(b.textContent.includes('è³‡æº') && id==='resource') b.classList.add('active');
    if(b.textContent.includes('ç ”ç©¶') && id==='research') b.classList.add('active');
    if(b.textContent.includes('å®Ÿç¸¾') && id==='achievement') b.classList.add('active');
  });
}

/* ================ Initial population of UI elements ================ */
function populateInitialElements(){
  // add build buttons container element exists already; updateDisplay will fill
  // wire up loan buttons in status panel
  const loanPanel = document.getElementById('loan-panel');
  loanPanel.innerHTML += ` <button class="button small" onclick="takeLoan(10000)">10,000Gå€Ÿå…¥</button>
    <button class="button small" onclick="repayLoan()">å…¨é¡è¿”æ¸ˆ</button>`;
  // invest panel buttons already in DOM - their handlers call functions we defined
}

/* ======================
   Start loop
   ====================== */
initUI();
populateInitialElements();
updateDisplay();
setInterval(tickLoop, TICK_RATE_MS);

</script>
</body>
</html>
