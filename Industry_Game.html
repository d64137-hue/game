<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚·ãƒ³ãƒ—ãƒ«å·¥æ¥­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (v11.0 - å¸‚å ´å®‰å®šåŒ–ï¼†æ–°è¦ç´ 5ç¨®ç‰ˆ)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            background: #2a2a2a; 
            color: white; 
            text-align: center; 
            font-family: sans-serif; 
            margin: 0; 
            padding-top: 10px; 
            padding-bottom: 50px; 
        }
        h1 {
            color: #76FF03; 
            margin-bottom: 10px;
            font-size: 1.5em;
        }
        #GameArea {
            max-width: 800px; 
            margin: 0 auto;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 8px;
            background: #1e1e1e;
        }

        /* --- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ --- */
        #status-panel { 
            background: #333; 
            padding: 8px; 
            margin-bottom: 10px; 
            border-radius: 5px; 
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; 
        }
        #status-panel > div {
             font-size: 1.1em;
             margin-right: 15px;
        }
        
        #loan-panel {
            background: #880E4F; 
            padding: 5px;
            border-radius: 5px;
            margin-top: 5px;
        }
        #loan-panel-status {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .loan-action-button {
            padding: 3px 8px;
            background-color: #FFC300;
            color: black;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8em;
            margin-left: 5px;
        }
        .loan-action-button:disabled {
             background-color: #555;
             color: #aaa;
        }
        
        #quick-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: flex-end;
            margin-top: 5px;
        }
        .quick-sell-button {
            padding: 4px 8px;
            background-color: #00BCD4; 
            color: black;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8em;
            min-width: 70px;
        }


        /* --- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒŠ --- */
        #tab-container {
            border: 1px solid #444;
            border-radius: 5px;
            background: #252525;
            padding: 0;
        }
        #tabs {
            display: flex;
            justify-content: space-around;
            border-bottom: 1px solid #444;
            margin-bottom: 10px;
        }
        .tab-button {
            flex-grow: 1;
            padding: 10px 0;
            cursor: pointer;
            background: #333;
            color: #aaa;
            border: none;
            font-size: 1.0em;
        }
        .tab-button.active {
            background: #1e1e1e;
            color: #76FF03;
            font-weight: bold;
            border-bottom: 3px solid #76FF03;
        }
        .tab-content {
            padding: 10px;
            min-height: 400px; 
            text-align: left;
            background: #1e1e1e;
            border-radius: 0 0 5px 5px;
        }
        
        /* --- è³‡æºãƒ‘ãƒãƒ« --- */
        #resource-panel { background: #1e1e1e; border: none; margin: 0; padding: 0;}
        .resource-item {
            display: grid;
            grid-template-columns: 1fr 1fr auto; 
            gap: 5px;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px dotted #888;
        }
        .resource-name { font-weight: bold; color: #FFC300; font-size: 0.9em; }
        .price-info { font-size: 0.8em; color: #ccc;}
        .sell-actions { 
            display: flex; 
            align-items: center; 
            justify-content: flex-end;
        }
        .sell-button {
            padding: 5px 8px;
            font-size: 0.8em;
            background-color: #FF7043;
            color: black;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px;
        }
        .price-change { margin-left: 5px; font-weight: bold; }
        .price-up { color: #76FF03; }
        .price-down { color: #FF7043; }
        #total-stock-info { text-align: right; padding-top: 5px; font-size: 0.9em; color: #aaa; }

        /* --- å»ºè¨­ãƒ‘ãƒãƒ« --- */
        #build-panel { background: #1e1e1e; border: none; margin: 0; padding: 0;}
        #buildings-status { margin-bottom: 15px; font-size: 0.9em; border-bottom: 1px dashed #444; padding-bottom: 5px;}
        #buildings-status span { margin-right: 10px; }
        
        #multi-buy-options {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }
        .multi-buy-button {
            padding: 5px 10px;
            font-size: 0.9em;
            min-width: 50px;
            background-color: #90A4AE;
            color: black;
            margin: 3px;
        }
        .multi-buy-button.selected {
            background-color: #FFC300;
            color: #1e1e1e;
        }
        
        #build-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }
        .build-button {
            padding: 10px 5px;
            font-size: 0.9em;
            min-width: auto;
        }
        .upgrade-button {
            display: block;
            margin-top: 8px;
            padding: 5px 10px;
            font-size: 0.8em;
            background-color: #FF7043;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        .building-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .building-count {
            font-weight: bold;
            margin-right: 10px;
        }

        /* --- ç ”ç©¶ãƒ‘ãƒãƒ« --- */
        #research-panel { background: #1e1e1e; border: none; margin: 0; padding: 0;}
        .research-item {
            border-bottom: 1px dotted #888;
            padding: 10px 0;
        }
        .research-button {
            padding: 8px 15px;
            font-size: 0.9em;
            background-color: #FFC300;
            color: #1e1e1e;
        }

        /* --- æŠ•è³‡ãƒ‘ãƒãƒ« --- */
        #investment-panel {
            border: 1px solid #FFC300;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            background: #4A148C; 
        }
        .investment-action {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .invest-button {
            padding: 8px 15px;
            background-color: #FFC300;
            color: #1e1e1e;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }
        .invest-button:disabled {
             background-color: #555;
             color: #aaa;
             cursor: not-allowed;
        }
        #investment-status { margin-top: 10px; font-weight: bold; }
        .invest-rate { font-size: 0.9em; margin-top: 5px; }


        /* --- å®Ÿç¸¾/ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‘ãƒãƒ« --- */
        #achievement-panel-container {
            padding: 10px 0;
            text-align: center;
        }
        .achievement-item {
            border: 1px solid #76FF03;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            background: #1e451e; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .achievement-item.locked {
            border: 1px dashed #555;
            background: #333;
            color: #aaa;
        }
        .ach-status { font-weight: bold; }
        
        #prestige-panel {
            border: 1px solid #FFC300;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            background: #2196F3;
        }
        #prestige-button {
            padding: 10px 20px;
            font-size: 1.1em;
            background-color: #FFC300;
            color: black;
            font-weight: bold;
            cursor: pointer;
        }
        #prestige-button:disabled {
            background-color: #999;
            cursor: not-allowed;
        }


        /* --- ãã®ä»– --- */
        #message-area { 
            margin-top: 10px; 
            padding: 5px;
            border-radius: 4px;
            min-height: 20px;
            color: yellow;
        }
        .msg-achieve { background-color: #76FF03; color: black; font-weight: bold; }
        #stock-limit-info {
            font-size: 0.9em;
            color: #00FFFF;
            margin-top: 5px;
            border-top: 1px dashed #444;
            padding-top: 5px;
        }
    </style>
</head>
<body>
    <div id="GameArea">
        <h1>ã‚·ãƒ³ãƒ—ãƒ«å·¥æ¥­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (v11.0)</h1>

        <div id="status-panel">
            <div>è³‡é‡‘ (Gold): <span id="gold-display">1000</span></div>
            <div>æŠ•è³‡é¡: <span id="investment-display">0</span>G</div> 
            <div id="loan-panel">
                <div id="loan-panel-status">å€Ÿå…¥é¡: 0G</div>
                <button class="loan-action-button" onclick="takeLoan(10000)">10,000Gå€Ÿå…¥</button>
                <button class="loan-action-button" id="repay-loan-button" onclick="repayLoan()">å…¨é¡è¿”æ¸ˆ</button>
            </div>
            <div id="quick-actions">
                <button class="quick-sell-button" id="qs-wafer" onclick="sellResource('wafer')">ã‚¦ã‚§ãƒå£²å´</button>
                <button class="quick-sell-button" id="qs-alloy" onclick="sellResource('alloy')">åˆé‡‘å£²å´</button>
                <button class="quick-sell-button" id="sell-all-button" onclick="sellAllResources()">å…¨å£²å´</button>
            </div>
        </div>

        <div style="text-align: left; margin-bottom: 10px; font-size: 0.9em;">
             ç¨¼åƒæ™‚é–“ (Ticks): <span id="tick-display">0</span>
             | **åœ¨åº«ä¸Šé™**: <span id="stock-limit-display">1000</span>
             | **ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸é€šè²¨**: <span id="prestige-currency-display">0</span> <span style="color:#FFC300;">â­</span>
        </div>

        <div id="tab-container">
            <div id="tabs">
                <button class="tab-button active" onclick="switchTab('build')">ğŸ› ï¸ å»ºè¨­</button>
                <button class="tab-button" onclick="switchTab('resource')">ğŸ“¦ è³‡æºãƒ»å¸‚å ´</button>
                <button class="tab-button" onclick="switchTab('research')">ğŸ”¬ ç ”ç©¶</button>
                <button class="tab-button" onclick="switchTab('achievement')">ğŸ† å®Ÿç¸¾/è»¢ç”Ÿ</button>
            </div>

            <div id="tab-build" class="tab-content">
                <h2>ğŸ› ï¸ å»ºç‰©å»ºè¨­</h2>
                
                <div id="buildings-status">
                    </div>
                
                <div id="production-rates">
                    </div>
                
                <p id="keyboard-instructions" style="text-align: center; margin: 5px 0; font-size: 0.9em;">è³¼å…¥æ•°ã‚’é¸æŠã—ã€å»ºç‰©ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>

                <div id="multi-buy-options">
                    <p style="margin-right: 15px; font-weight: bold;">è³¼å…¥æ•°:</p>
                    <button class="multi-buy-button selected" data-count="1" onclick="setBuildingCountMultiplier(1)">x1</button>
                    <button class="multi-buy-button" data-count="10" onclick="setBuildingCountMultiplier(10)">x10</button>
                    <button class="multi-buy-button" data-count="100" onclick="setBuildingCountMultiplier(100)">x100</button>
                    <button class="multi-buy-button" data-count="max" onclick="setBuildingCountMultiplier('max')">MAX</button>
                </div>
                
                <div id="build-buttons">
                    </div>

                 <div id="investment-panel">
                    <h3>ğŸ’° å¸‚å ´æŠ•è³‡</h3>
                    <div id="investment-status">ç¾åœ¨ã€0Gã‚’æŠ•è³‡ä¸­ã€‚</div>
                    <div class="invest-rate">æ¯ãƒ†ã‚£ãƒƒã‚¯ $0.5\% \sim 1.0\%$ ã®ãƒ©ãƒ³ãƒ€ãƒ å¤‰å‹•ãŒã‚ã‚Šã¾ã™ã€‚(å®‰å®šç‰ˆ)</div>
                    <div class="investment-action">
                        <input type="number" id="invest-amount" value="1000" min="100">
                        <button class="invest-button" onclick="investMoney(document.getElementById('invest-amount').value)">æŠ•è³‡</button>
                        <button class="invest-button" onclick="withdrawInvestment()">å…¨é¡å›å</button>
                    </div>
                </div>

            </div>

            <div id="tab-resource" class="tab-content" style="display:none;">
                <h2>ğŸ“¦ è³‡æºåœ¨åº« (å¸‚å ´ä¾¡æ ¼)</h2>
                <div id="stock-limit-info">
                    </div>
                <div id="resource-list">
                    </div>
            </div>

            <div id="tab-research" class="tab-content" style="display:none;">
                <h2>ğŸ”¬ ç ”ç©¶é–‹ç™º</h2>
                <div id="research-list">
                    </div>
            </div>

             <div id="tab-achievement" class="tab-content" style="display:none;">
                <h2>ğŸ† å®Ÿç¸¾ (å®Ÿç¸¾æ•°: <span id="achieved-count">0</span> / <span id="total-achievements">0</span>)</h2>
                <div id="achievement-panel-container"></div>
                
                <div id="prestige-panel">
                    <h3>â­ ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ (è»¢ç”Ÿ)</h3>
                    <p>ã“ã®ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã€é€²æ—ã«å¿œã˜ãŸ**ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸é€šè²¨**ã‚’ç²å¾—ã—ã¾ã™ã€‚</p>
                    <p style="font-weight: bold;">ç²å¾—å¯èƒ½é€šè²¨: <span id="prestige-gain-display">0</span> â­</p>
                    <p style="font-size: 0.8em; color: #ddd;">(æ¡ä»¶: è³‡é‡‘ç·é¡100,000Gä»¥ä¸Š)</p>
                    <button id="prestige-button" onclick="prestigeReset()">ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸å®Ÿè¡Œ</button>
                </div>

            </div>

        </div>
        
        <div id="message-area">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼æ¡æ˜æ‰€ã‚’å»ºã¦ã¦è³‡æºã‚’é›†ã‚ã‚ˆã†ã€‚</div>

    </div>
    
    <script>
        // --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹å¤‰æ•° ---
        let stats = {
            gold: 1000,
            investment: 0, 
            loan: 0, // â˜… NEW: ãƒ­ãƒ¼ãƒ³é¡
            prestige_currency: 0, // â˜… NEW: ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸é€šè²¨
            tick: 0,
            buildingCountMultiplier: 1, 
            resources: {
                ore: 0, copper_ore: 0, coal_ore: 0, alum_ore: 0, silicon_ore: 0, titan_ore: 0, 
                iron: 0, copper_wire: 0, steel_copper: 0, alum: 0, wafer: 0, alloy: 0, 
            },
            buildings: {
                Mine: [], CopperMine: [], CoalMine: [], AluminumMine: [], SiliconMine: [], TitaniumMine: [], 
                Smelter: [], WireMill: [], SteelMill: [], AdvancedSmelter: [], // â˜… NEW: ä¸Šç´šè£½éŒ¬æ‰€
                AluminumSmelter: [], WaferFab: [], AlloyForge: [], 
                AdvMine: [],
                AutoTransporter: [], 
                Warehouse: [], 
                TradePost: [], 
                ContractOffice: [], // â˜… NEW: å¥‘ç´„ã‚ªãƒ•ã‚£ã‚¹
            },
            upgrades: {
                productionEfficiency: 0, 
                warehouseCapacity: 0, 
                marketStability: 0, // â˜… NEW: å¸‚å ´å®‰å®šåŒ–æŠ€è¡“
            },
            market: {
                priceAdjustment: {
                    ore: 0, copper_ore: 0, coal_ore: 0, alum_ore: 0, silicon_ore: 0, titan_ore: 0, 
                    iron: 0, copper_wire: 0, steel_copper: 0, alum: 0, wafer: 0, alloy: 0, 
                },
                marketFluctuation: 1.0, 
            },
            achievements: { 
                first_build: false, max_1k_gold: false, max_10k_gold: false, max_100k_gold: false,
                iron_master: false, wafer_creator: false, all_mines: false, adv_mine_upgrade: false
            }
        };
        
        // --- å®šæ•° ---
        const TICK_RATE_MS = 100; 
        const TICKS_PER_MINUTE = 60000 / TICK_RATE_MS; 
        const BASE_STOCK_LIMIT = 1000; 
        const LOAN_INTEREST_RATE = 0.0005; // 0.05% per tick

        const BASE_RESOURCE_PRICES = {
            ore: 5, copper_ore: 8, coal_ore: 10, alum_ore: 12, silicon_ore: 15, titan_ore: 20,
            iron: 20, copper_wire: 40, steel_copper: 80, alum: 35, wafer: 100, alloy: 150,
        };
        
        const RESOURCE_NAMES = {
            ore: 'é‰„é‰±çŸ³', copper_ore: 'éŠ…é‰±çŸ³', coal_ore: 'çŸ³ç‚­', alum_ore: 'ã‚¢ãƒ«ãƒŸé‰±çŸ³', silicon_ore: 'ã‚·ãƒªã‚³ãƒ³é‰±çŸ³', titan_ore: 'ãƒã‚¿ãƒ³é‰±çŸ³',
            iron: 'é‰„', copper_wire: 'éŠ…ç·š', steel_copper: 'é‰„é‹¼éŠ…', alum: 'ã‚¢ãƒ«ãƒŸãƒ‹ã‚¦ãƒ ', wafer: 'ã‚·ãƒªã‚³ãƒ³ã‚¦ã‚§ãƒ', alloy: 'ãƒã‚¿ãƒ³åˆé‡‘'
        };
        
        const RESOURCE_UNITS = {
            ore: 'å€‹', copper_ore: 'å€‹', coal_ore: 'å€‹', coal_ore: 'å€‹', alum_ore: 'å€‹', silicon_ore: 'å€‹', titan_ore: 'å€‹',
            iron: 'å€‹', copper_wire: 'm', steel_copper: 'å¡Š', alum: 'å¡Š', wafer: 'æš', alloy: 'å¡Š'
        };

        // ç ”ç©¶ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å®šç¾©
        const GLOBAL_UPGRADES = {
            productionEfficiency: {
                displayName: 'ç”Ÿç”£æŠ€è¡“å‘ä¸Š', maxLevel: 10, baseCost: 1000, costMultiplier: 1.5,
                effect: (level) => `ç”Ÿç”£é€Ÿåº¦ãŒ ${(level * 5)}% å‘ä¸Š`,
                getCost: (level) => Math.ceil(GLOBAL_UPGRADES.productionEfficiency.baseCost * Math.pow(GLOBAL_UPGRADES.productionEfficiency.costMultiplier, level))
            },
            warehouseCapacity: {
                displayName: 'å€‰åº«å®¹é‡æ‹¡å¼µ', maxLevel: 5, baseCost: 5000, costMultiplier: 2.0,
                effect: (level) => `å€‰åº«ã«ã‚ˆã‚‹å®¹é‡å¢—åŠ é‡ãŒ ${level*50}% å‘ä¸Š`,
                getCost: (level) => Math.ceil(GLOBAL_UPGRADES.warehouseCapacity.baseCost * Math.pow(GLOBAL_UPGRADES.warehouseCapacity.costMultiplier, level))
            },
            marketStability: { // â˜… NEW: å¸‚å ´å®‰å®šåŒ–æŠ€è¡“
                displayName: 'å¸‚å ´å®‰å®šåŒ–æŠ€è¡“', maxLevel: 5, baseCost: 1500, costMultiplier: 1.8,
                effect: (level) => `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å£²å´ã«ã‚ˆã‚‹ä¾¡æ ¼ä¸‹è½ã‚’ ${(level * 10)}% è»½æ¸›`,
                getCost: (level) => Math.ceil(GLOBAL_UPGRADES.marketStability.baseCost * Math.pow(GLOBAL_UPGRADES.marketStability.costMultiplier, level))
            }
        };

        // å»ºç‰©ã‚¹ãƒšãƒƒã‚¯å®šç¾©
        const BUILDING_SPECS = {
            // åŸæ–™æ¡æ˜æ‰€
            Mine: { cost: 100, output: { resource: 'ore', amount: 1 }, time: 100, input: null, displayName: 'é‰„æ¡æ˜æ‰€' },
            CopperMine: { cost: 150, output: { resource: 'copper_ore', amount: 1 }, time: 120, input: null, displayName: 'éŠ…æ¡æ˜æ‰€' },
            CoalMine: { cost: 180, output: { resource: 'coal_ore', amount: 1 }, time: 70, input: null, displayName: 'çŸ³ç‚­æ¡æ˜æ‰€' },
            AluminumMine: { cost: 200, output: { resource: 'alum_ore', amount: 1 }, time: 110, input: null, displayName: 'ã‚¢ãƒ«ãƒŸæ¡æ˜æ‰€' }, 
            SiliconMine: { cost: 250, output: { resource: 'silicon_ore', amount: 1 }, time: 130, input: null, displayName: 'ã‚·ãƒªã‚³ãƒ³æ¡æ˜æ‰€' }, 
            TitaniumMine: { cost: 300, output: { resource: 'titan_ore', amount: 1 }, time: 150, input: null, displayName: 'ãƒã‚¿ãƒ³æ¡æ˜æ‰€' }, 

            // ä¸­é–“è£½å“å·¥å ´
            Smelter: { cost: 250, output: { resource: 'iron', amount: 1 }, time: 150, 
                input: [{ resource: 'ore', amount: 2 }, { resource: 'coal_ore', amount: 1 }], displayName: 'é‰„è£½éŒ¬æ‰€' }, 
            WireMill: { cost: 400, output: { resource: 'copper_wire', amount: 1 }, time: 200, 
                input: [{ resource: 'copper_ore', amount: 2 }, { resource: 'coal_ore', amount: 1 }], displayName: 'é›»ç·šå·¥å ´' }, 
            SteelMill: { cost: 600, output: { resource: 'steel_copper', amount: 1 }, time: 300, 
                input: [{ resource: 'ore', amount: 1 }, { resource: 'copper_ore', amount: 1 }, { resource: 'coal_ore', amount: 2 }], displayName: 'è£½é‹¼æ‰€' }, 
            
            // ä¸Šç´šå·¥å ´
            AluminumSmelter: { cost: 350, output: { resource: 'alum', amount: 1 }, time: 180, 
                input: [{ resource: 'alum_ore', amount: 2 }, { resource: 'coal_ore', amount: 1 }], displayName: 'ã‚¢ãƒ«ãƒŸè£½éŒ¬æ‰€' },
            WaferFab: { cost: 800, output: { resource: 'wafer', amount: 1 }, time: 250, 
                input: [{ resource: 'silicon_ore', amount: 1 }, { resource: 'coal_ore', amount: 2 }, { resource: 'alum', amount: 1 }], displayName: 'ã‚¦ã‚§ãƒå·¥å ´' },
            AlloyForge: { cost: 1200, output: { resource: 'alloy', amount: 1 }, time: 400, 
                input: [{ resource: 'titan_ore', amount: 1 }, { resource: 'iron', amount: 1 }, { resource: 'steel_copper', amount: 1 }], displayName: 'åˆé‡‘é›é€ æ‰€' },

            // â˜… NEW: åŠ¹ç‡ã®è‰¯ã„å·¥å ´
            AdvancedSmelter: { cost: 900, output: { resource: 'steel_copper', amount: 1 }, time: 250,
                input: [{ resource: 'ore', amount: 1 }, { resource: 'copper_wire', amount: 1 }], displayName: 'ä¸Šç´šè£½éŒ¬æ‰€' },


            // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å»ºç‰©
            AutoTransporter: { 
                cost: 1500, output: null, time: 20, 
                input: null, displayName: 'è‡ªå‹•æ¬é€æ©Ÿ'
            },
            Warehouse: {
                cost: 2000, output: null, time: 0,
                input: null, displayName: 'å€‰åº« (å®¹é‡æ‹¡å¼µ)'
            },
            TradePost: { 
                cost: 5000, output: null, time: 100, 
                input: null, displayName: 'è‡ªå‹•å–å¼•æ‰€' 
            },
            ContractOffice: { // â˜… NEW: å¥‘ç´„ã‚ªãƒ•ã‚£ã‚¹
                cost: 3000, output: null, time: 200, 
                input: null, displayName: 'å¥‘ç´„ã‚ªãƒ•ã‚£ã‚¹ (å®‰å®šå£²å´)' 
            },
            
            // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å»ºç‰©
            AdvMine: { cost: 0, output: { resource: 'ore', amount: 2 }, time: 100, input: null, displayName: 'ä¸Šç´šé‰„æ¡æ˜æ‰€' }
        };
        
        const AUTO_SELL_RESOURCES = ['iron', 'copper_wire', 'steel_copper', 'alum'];

        // å®Ÿç¸¾å®šç¾©
        const ACHIEVEMENT_DEFINITIONS = {
            first_build: { name: 'æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—', description: 'ä»»æ„ã®å»ºç‰©ã‚’1åŸºå»ºè¨­ã™ã‚‹ã€‚', check: () => getTotalBuildings() >= 1 },
            max_1k_gold: { name: 'åˆæœŸæŠ•è³‡å®¶', description: 'è³‡é‡‘ã®ç·é¡ï¼ˆæ‰‹æŒã¡ï¼‹æŠ•è³‡ï¼‰ãŒ1,000Gã‚’è¶…ãˆã‚‹ã€‚', check: () => stats.gold + stats.investment >= 1000 && stats.tick > 10 },
            max_10k_gold: { name: 'ä¸­å …ä¼æ¥­', description: 'è³‡é‡‘ã®ç·é¡ï¼ˆæ‰‹æŒã¡ï¼‹æŠ•è³‡ï¼‰ãŒ10,000Gã‚’è¶…ãˆã‚‹ã€‚', check: () => stats.gold + stats.investment >= 10000 },
            max_100k_gold: { name: 'å¤§å¯Œè±ª', description: 'è³‡é‡‘ã®ç·é¡ï¼ˆæ‰‹æŒã¡ï¼‹æŠ•è³‡ï¼‰ãŒ100,000Gã‚’è¶…ãˆã‚‹ã€‚', check: () => stats.gold + stats.investment >= 100000 },
            iron_master: { name: 'é‰„ã®åŸºç¤', description: 'é‰„è£½éŒ¬æ‰€ã‚’10åŸºä»¥ä¸Šå»ºè¨­ã™ã‚‹ã€‚', check: () => stats.buildings.Smelter.length >= 10 },
            wafer_creator: { name: 'ãƒã‚¤ãƒ†ã‚¯å‚å…¥', description: 'ã‚·ãƒªã‚³ãƒ³ã‚¦ã‚§ãƒã‚’åˆã‚ã¦ç”Ÿç”£ã™ã‚‹ã€‚', check: () => stats.resources.wafer > 0 },
            all_mines: { name: 'å…¨è³‡æºåˆ¶è¦‡', description: 'å…¨6ç¨®é¡ã®æ¡æ˜æ‰€ã‚’1åŸºä»¥ä¸Šå»ºè¨­ã™ã‚‹ã€‚', check: () => ['Mine', 'CopperMine', 'CoalMine', 'AluminumMine', 'SiliconMine', 'TitaniumMine'].every(t => stats.buildings[t].length >= 1) },
            adv_mine_upgrade: { name: 'è¿‘ä»£åŒ–', description: 'ä¸Šç´šæ¡æ˜æ‰€ã‚’åˆã‚ã¦å»ºè¨­ã™ã‚‹ã€‚', check: () => stats.buildings.AdvMine.length > 0 }
        };

        function getTotalBuildings() {
            return Object.values(stats.buildings).flat().length;
        }


        // --- ã‚¯ãƒ©ã‚¹å®šç¾© ---
        class Building {
            constructor(type) {
                this.type = type;
                this.spec = BUILDING_SPECS[type];
                this.timer = 0;
                this.isStalled = false; 
            }

            update(productionMultiplier, stockLimit) {
                this.timer++;
                this.isStalled = false; 
                
                const effectiveTime = Math.max(1, Math.floor(this.spec.time * productionMultiplier));
                const { resource: outputRes, amount: outputAmt } = this.spec.output || {};

                // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å»ºç‰©ï¼ˆç”Ÿç”£ã—ãªã„ï¼‰
                if (!outputRes) {
                    // è‡ªå‹•æ¬é€æ©Ÿã®ãƒ­ã‚¸ãƒƒã‚¯
                    if (this.type === 'AutoTransporter' && this.timer >= effectiveTime) {
                         autoSellOneResource(); 
                         this.timer = 0;
                         return false;
                    }
                    
                    // è‡ªå‹•å–å¼•æ‰€ã®ãƒ­ã‚¸ãƒƒã‚¯
                    if (this.type === 'TradePost' && this.timer >= effectiveTime) {
                        autoTradeHighValueResource();
                        this.timer = 0;
                        return false;
                    }

                    // â˜… NEW: å¥‘ç´„ã‚ªãƒ•ã‚£ã‚¹ã®ãƒ­ã‚¸ãƒƒã‚¯
                    if (this.type === 'ContractOffice' && this.timer >= effectiveTime) {
                         autoContractSell(); 
                         this.timer = 0;
                         return false;
                    }

                    if (this.type === 'Warehouse') return false; 
                    return false;
                }

                if (this.timer >= effectiveTime) {
                    
                    // åœ¨åº«ä¸Šé™ãƒã‚§ãƒƒã‚¯ (ç”Ÿç”£ãŒã‚¹ãƒˆãƒƒãƒ—ã™ã‚‹æ¡ä»¶)
                    if (stats.resources[outputRes] + outputAmt > stockLimit) {
                        this.isStalled = true; 
                        return false; 
                    }

                    // ææ–™ãƒã‚§ãƒƒã‚¯ã¨æ¶ˆè²»
                    if (this.spec.input) {
                        let canProduce = true;
                        
                        for (const requirement of this.spec.input) {
                            if (stats.resources[requirement.resource] < requirement.amount) {
                                canProduce = false;
                                break;
                            }
                        }

                        if (!canProduce) {
                            this.isStalled = true; 
                            return false; 
                        }

                        for (const requirement of this.spec.input) {
                            stats.resources[requirement.resource] -= requirement.amount;
                        }
                    }
                    
                    // ç”Ÿç”£
                    stats.resources[outputRes] += outputAmt;
                    this.timer = 0; 
                    return true; 
                }
                return false; 
            }
        }

        // --- ã‚²ãƒ¼ãƒ ç®¡ç†é–¢æ•° ---
        
        // è‡ªå‹•æ¬é€æ©Ÿã«ã‚ˆã‚‹ä¸­é–“è³‡æºã®è‡ªå‹•å£²å´
        function autoSellOneResource() {
            for (let i = 0; i < stats.buildings.AutoTransporter.length; i++) {
                const resKey = AUTO_SELL_RESOURCES[i % AUTO_SELL_RESOURCES.length];
                
                if (stats.resources[resKey] > 0) {
                    const amountToSell = 1; 
                    const price = getResourcePrice(resKey);
                    const revenue = amountToSell * price;
                    
                    stats.gold += revenue;
                    stats.resources[resKey] -= amountToSell;
                    
                    const marketImpact = 0.00005; 
                    stats.market.priceAdjustment[resKey] -= marketImpact; 
                }
            }
        }

        // è‡ªå‹•å–å¼•æ‰€ã«ã‚ˆã‚‹é«˜ä¾¡å€¤è³‡æºã®å–å¼•
        function autoTradeHighValueResource() {
            for (let i = 0; i < stats.buildings.TradePost.length; i++) {
                let targetResource = null;
                const waferPrice = getResourcePrice('wafer');
                const alloyPrice = getResourcePrice('alloy');

                if (stats.resources.wafer > 0 && stats.resources.alloy === 0) {
                     targetResource = 'wafer';
                } else if (stats.resources.alloy > 0 && stats.resources.wafer === 0) {
                     targetResource = 'alloy';
                } else if (stats.resources.wafer > 0 && stats.resources.alloy > 0) {
                    targetResource = waferPrice >= alloyPrice ? 'wafer' : 'alloy';
                }

                if (targetResource) {
                    const price = getResourcePrice(targetResource);
                    const revenue = Math.floor(price * 0.9); // 90%ã®ä¾¡æ ¼ã§å£²å´

                    stats.gold += revenue;
                    stats.resources[targetResource] -= 1;
                    
                    const marketImpact = 0.00001; 
                    stats.market.priceAdjustment[targetResource] -= marketImpact;
                }
            }
        }

        // â˜… NEW: å¥‘ç´„ã‚ªãƒ•ã‚£ã‚¹ã«ã‚ˆã‚‹å®‰å®šå£²å´ (å¸‚å ´ä¾¡æ ¼ã«å½±éŸ¿ãªã—)
        function autoContractSell() {
            const contractSellable = ['iron', 'copper_wire', 'steel_copper', 'alum', 'wafer', 'alloy'];
            const availableResources = contractSellable.filter(r => stats.resources[r] > 0);
            
            if (availableResources.length > 0) {
                const resKey = availableResources[Math.floor(Math.random() * availableResources.length)];
                const basePrice = BASE_RESOURCE_PRICES[resKey];
                const revenue = Math.floor(basePrice * 1.5); // 150%ã®å›ºå®šä¾¡æ ¼ã§å£²å´

                stats.gold += revenue;
                stats.resources[resKey] -= 1;
                
                // å¸‚å ´ã¸ã®å½±éŸ¿ã¯ã‚¼ãƒ­
                // showMessage(`ğŸ“œ å¥‘ç´„ã‚ªãƒ•ã‚£ã‚¹: ${RESOURCE_NAMES[resKey]}ã‚’1å€‹ç´å“ã—ã€${revenue}Gã‚’ç²å¾—ã—ã¾ã—ãŸã€‚ (å¸‚å ´å½±éŸ¿ãªã—)`, 'lightblue');
            }
        }


        // æŠ•è³‡æ©Ÿèƒ½ã®æ›´æ–°
        function updateInvestment() {
            if (stats.investment <= 0) return;

            const fluctuationRate = (Math.random() * 0.015) - 0.005; // -0.5% ã‹ã‚‰ 1.0%
            const changeAmount = Math.floor(stats.investment * fluctuationRate);
            
            stats.investment += changeAmount;
            stats.investment = Math.max(0, stats.investment); 
        }

        // â˜… NEW: ãƒ­ãƒ¼ãƒ³åˆ©å­ã®è¨ˆç®—
        function updateLoanInterest() {
             if (stats.loan <= 0) return;

             const interest = Math.floor(stats.loan * LOAN_INTEREST_RATE);
             stats.loan += interest;
             
             // å€Ÿå…¥ãŒ100,000Gã‚’è¶…ãˆãŸå ´åˆã€åˆ©å­ãŒåŠ é€Ÿã™ã‚‹ï¼ˆãƒšãƒŠãƒ«ãƒ†ã‚£ï¼‰
             if (stats.loan > 100000) {
                 const penaltyInterest = Math.floor(stats.loan * 0.0001); // è¿½åŠ ã§0.01%
                 stats.loan += penaltyInterest;
             }
        }


        // å®Ÿç¸¾ãƒã‚§ãƒƒã‚¯
        function checkAchievements() {
            for (const key in ACHIEVEMENT_DEFINITIONS) {
                if (!stats.achievements[key]) {
                    if (ACHIEVEMENT_DEFINITIONS[key].check()) {
                        stats.achievements[key] = true;
                        showMessage(`ğŸ† å®Ÿç¸¾é”æˆï¼: ${ACHIEVEMENT_DEFINITIONS[key].name}`, 'lime', 'msg-achieve');
                    }
                }
            }
        }

        function updateGame() {
            stats.tick++;
            
            updateMarket(); 
            updateInvestment(); 
            updateLoanInterest(); // â˜… NEW: ãƒ­ãƒ¼ãƒ³åˆ©å­ã®æ›´æ–°
            checkAchievements();

            const prodLevel = stats.upgrades.productionEfficiency;
            const productionMultiplier = 1.0 - (prodLevel * 0.05); 
            
            const capacityLevel = stats.upgrades.warehouseCapacity;
            const capacityMultiplier = 1.0 + (capacityLevel * 0.5); 
            const warehouseBonus = stats.buildings.Warehouse.length * 5000; 
            const stockLimit = BASE_STOCK_LIMIT + (warehouseBonus * capacityMultiplier);


            for (const type in stats.buildings) {
                stats.buildings[type].forEach(building => {
                    building.update(productionMultiplier, stockLimit);
                });
            }

            updateDisplay(stockLimit);
        }
        
        // å¸‚å ´å¤‰å‹•ã®æ›´æ–°
        function updateMarket() {
            // A. ãƒ©ãƒ³ãƒ€ãƒ ãªå¸‚å ´å¤‰å‹• (2ç§’ã”ã¨)
            if (stats.tick % 20 === 0) { 
                const maxFluctuation = 0.05; 
                const randomChange = (Math.random() * maxFluctuation * 2) - maxFluctuation;
                stats.market.marketFluctuation = Math.min(1.2, Math.max(0.8, stats.market.marketFluctuation + randomChange));
            }

            // B. å£²å´ã«ã‚ˆã‚‹ä¾¡æ ¼ä¸‹è½ã®å›å¾© (FIX: 10å€é«˜é€ŸåŒ–)
            for (const key in stats.market.priceAdjustment) {
                if (stats.market.priceAdjustment[key] < 0) {
                    stats.market.priceAdjustment[key] = Math.min(0, stats.market.priceAdjustment[key] + 0.001); // 0.0001 -> 0.001
                }
            }
        }

        // è³‡æºã®ç¾åœ¨ä¾¡æ ¼ã‚’å–å¾—
        function getResourcePrice(resourceKey) {
            const basePrice = BASE_RESOURCE_PRICES[resourceKey];
            const randomMultiplier = stats.market.marketFluctuation;
            const saleAdjustment = 1.0 + stats.market.priceAdjustment[resourceKey];
            
            return Math.max(1, Math.floor(basePrice * randomMultiplier * saleAdjustment));
        }

        // è³¼å…¥æ•°ä¹—æ•°ã®è¨­å®š
        function setBuildingCountMultiplier(count) {
            stats.buildingCountMultiplier = count;
            document.querySelectorAll('.multi-buy-button').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.getAttribute('data-count') == count) {
                    btn.classList.add('selected');
                }
            });
            updateDisplay(); 
        }

        // æœ€å¤§è³¼å…¥å¯èƒ½æ•°ã®è¨ˆç®—
        function getMaxPurchases(cost) {
            if (cost === 0) return 99999;
            return Math.floor(stats.gold / cost);
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(`tab-${tabId}`).style.display = 'block';
            document.querySelector(`.tab-button[onclick*="'${tabId}'"]`).classList.add('active');
        }

        // UIæç”»ã®æ›´æ–°
        function updateDisplay(stockLimit) {
            // 1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (å¸¸ã«è¡¨ç¤º)
            document.getElementById('gold-display').textContent = stats.gold.toFixed(0); 
            document.getElementById('investment-display').textContent = stats.investment.toFixed(0); 
            document.getElementById('tick-display').textContent = stats.tick;
            document.getElementById('stock-limit-display').textContent = stockLimit.toFixed(0);
            document.getElementById('stock-limit-info').textContent = `ç¾åœ¨ã®åœ¨åº«ä¸Šé™: ${stockLimit.toFixed(0)}`;
            document.getElementById('prestige-currency-display').textContent = stats.prestige_currency.toFixed(0);
            
            const currentMultiplier = stats.buildingCountMultiplier === 'max' ? 'MAX' : `x${stats.buildingCountMultiplier}`;
            document.getElementById('keyboard-instructions').textContent = `è³¼å…¥æ•°ã‚’é¸æŠã—ã€å»ºç‰©ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚ (è³¼å…¥æ•°: ${currentMultiplier})`; 

            // 1A. ãƒ­ãƒ¼ãƒ³ãƒ‘ãƒãƒ«ã®æ›´æ–°
            const loanStatusDiv = document.getElementById('loan-panel-status');
            const repayButton = document.getElementById('repay-loan-button');
            if (stats.loan > 0) {
                 loanStatusDiv.innerHTML = `å€Ÿå…¥é¡: <span style="color: #FF7043;">${stats.loan.toFixed(0)}G</span> (æ—¥æ­©${(LOAN_INTEREST_RATE*100*TICKS_PER_MINUTE*24).toFixed(2)}\%ç›¸å½“)`;
                 repayButton.disabled = stats.gold < stats.loan;
                 repayButton.textContent = `å…¨é¡è¿”æ¸ˆ (${stats.loan.toFixed(0)}G)`;
            } else {
                 loanStatusDiv.textContent = 'å€Ÿå…¥é¡: 0G (å€Ÿã‚Šå…¥ã‚Œå¯èƒ½)';
                 repayButton.disabled = true;
                 repayButton.textContent = `å…¨é¡è¿”æ¸ˆ (0G)`;
            }

            // 1B. ã‚¯ã‚¤ãƒƒã‚¯å£²å´ãƒœã‚¿ãƒ³ã®æ›´æ–°
            document.getElementById('qs-wafer').disabled = stats.resources.wafer === 0;
            document.getElementById('qs-alloy').disabled = stats.resources.alloy === 0;
            let totalStock = Object.values(stats.resources).reduce((sum, current) => sum + current, 0);
            document.getElementById('sell-all-button').disabled = totalStock === 0;
            
            // æŠ•è³‡ãƒ‘ãƒãƒ«ã®æ›´æ–°
            const investAmount = document.getElementById('invest-amount').value;
            document.querySelector('.investment-action button:nth-child(2)').disabled = stats.gold < investAmount;
            document.querySelector('.investment-action button:nth-child(3)').disabled = stats.investment <= 0;


            // 2. è³‡æºãƒªã‚¹ãƒˆã®å‹•çš„ç”Ÿæˆ (è³‡æºã‚¿ãƒ–)
            const resourceList = document.getElementById('resource-list');
            resourceList.innerHTML = '';
            
            for (const key in stats.resources) {
                const amount = stats.resources[key];
                const price = getResourcePrice(key); 
                const displayName = RESOURCE_NAMES[key];
                const unit = RESOURCE_UNITS[key];
                
                const basePrice = BASE_RESOURCE_PRICES[key];
                const priceChangePercent = ((price / basePrice) - 1) * 100;
                let changeClass = 'price-down';
                let changeIcon = 'â–¼';
                if (priceChangePercent > 0.1) {
                    changeClass = 'price-up';
                    changeIcon = 'â–²';
                } else if (priceChangePercent > -0.1) {
                    changeIcon = 'ï¼';
                    changeClass = '';
                }

                const itemDiv = document.createElement('div');
                itemDiv.className = 'resource-item';
                
                itemDiv.innerHTML += `
                    <span class="resource-name">${displayName} (${key})</span>
                    <span class="resource-value" id="${key}-display">${amount.toFixed(0)} ${unit}</span>
                    <div class="sell-actions">
                        <span class="price-info">
                            ${price}G/${unit} 
                            <span class="${changeClass} price-change">
                                ${changeIcon}${Math.abs(priceChangePercent).toFixed(1)}%
                            </span>
                        </span>
                        <button class="sell-button" onclick="sellResource('${key}')" ${amount === 0 ? 'disabled' : ''}>
                            å£²å´
                        </button>
                    </div>
                `;
                resourceList.appendChild(itemDiv);
            }
            

            // 3. ç ”ç©¶ãƒ‘ãƒãƒ«ã®æ›´æ–° (ç ”ç©¶ã‚¿ãƒ–)
            const researchList = document.getElementById('research-list');
            researchList.innerHTML = '';
            for (const key in GLOBAL_UPGRADES) {
                const spec = GLOBAL_UPGRADES[key];
                const currentLevel = stats.upgrades[key];
                const nextLevel = currentLevel + 1;
                const cost = spec.getCost(currentLevel);
                const isMax = currentLevel >= spec.maxLevel;
                
                const researchDiv = document.createElement('div');
                researchDiv.className = 'research-item';
                researchDiv.innerHTML = `
                    <span style="font-weight: bold; color: #FFEB3B;">${spec.displayName} (Lv.${currentLevel})</span>
                    <p style="margin: 5px 0; font-size: 0.9em;">
                        ${isMax ? 'æœ€å¤§ãƒ¬ãƒ™ãƒ«é”æˆã€‚' : `æ¬¡ãƒ¬ãƒ™ãƒ«åŠ¹æœ: ${spec.effect(nextLevel)}`}
                    </p>
                    <button class="research-button" 
                            onclick="researchUpgrade('${key}')" 
                            ${stats.gold < cost || isMax ? 'disabled' : ''}>
                        ${isMax ? 'æœ€å¤§' : `ç ”ç©¶ (${cost}G)`}
                    </button>
                `;
                researchList.appendChild(researchDiv);
            }


            // 4. å»ºè¨­çŠ¶æ³ã¨ç”Ÿç”£èƒ½åŠ›ã®è¨ˆç®—ãƒ»è¡¨ç¤º (å»ºè¨­ã‚¿ãƒ–)
            const buildButtonsDiv = document.getElementById('build-buttons');
            const buildingsStatusDiv = document.getElementById('buildings-status');
            const productionRatesDiv = document.getElementById('production-rates');
            
            buildButtonsDiv.innerHTML = '';
            buildingsStatusDiv.innerHTML = '';
            productionRatesDiv.innerHTML = 'ç”Ÿç”£ãƒ¬ãƒ¼ãƒˆ (PPM): ';

            let totalProductionRates = {};
            
            let buildingTypes = Object.keys(BUILDING_SPECS);


            for (const type of buildingTypes) {
                const spec = BUILDING_SPECS[type];
                const count = stats.buildings[type].length;
                let stalledCount = 0;
                const cost = spec.cost;

                // å»ºç‰©ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
                if (count > 0 || (cost > 0 && type !== 'AdvMine')) {
                    if (type !== 'Warehouse' && type !== 'TradePost' && type !== 'ContractOffice') { 
                        stats.buildings[type].forEach(b => {
                            if (b.isStalled) stalledCount++;
                        });
                    }
                    
                    let statusText = '';
                    if (type === 'Warehouse') {
                         statusText = `(å®¹é‡å¢—åŠ : ${count * 5000} + æ‹¡å¼µ)`;
                    } else if (type === 'AutoTransporter') {
                         statusText = `(è‡ªå‹•å£²å´é€Ÿåº¦: ${count * 3}è³‡æº/åˆ†)`;
                    } else if (type === 'TradePost') {
                         statusText = `(è‡ªå‹•å–å¼•é€Ÿåº¦: ${count * 6}è³‡æº/åˆ†)`;
                    } else if (type === 'ContractOffice') { // â˜… NEW: å¥‘ç´„ã‚ªãƒ•ã‚£ã‚¹
                         statusText = `(å®‰å®šç´å“é€Ÿåº¦: ${count * 3}è³‡æº/åˆ†)`;
                    } else {
                        statusText = `(${count - stalledCount} / ${count} ç¨¼åƒ)`;
                        if (stalledCount === 0) statusText = `(${count} åŸº)`;
                    }
                    

                    const buildingLine = document.createElement('div');
                    buildingLine.className = 'building-line';
                    
                    const countSpan = document.createElement('span');
                    countSpan.className = 'building-count';
                    countSpan.textContent = `${spec.displayName}: ${count}åŸº ${statusText}`;
                    countSpan.style.color = stalledCount > 0 ? '#FF7043' : 'white'; 
                    buildingLine.appendChild(countSpan);
                    
                    // Mineã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
                    if (type === 'Mine' && count > 0) {
                        const upgradeCost = 500 * count;
                        const upgradeButton = document.createElement('button');
                        upgradeButton.className = 'upgrade-button';
                        upgradeButton.textContent = `å…¨UG (${upgradeCost}G)`;
                        upgradeButton.disabled = stats.gold < upgradeCost;
                        upgradeButton.onclick = () => upgradeBuilding('Mine', 'AdvMine', upgradeCost);
                        buildingLine.appendChild(upgradeButton);
                    }
                    
                    buildingsStatusDiv.appendChild(buildingLine);
                    
                    // ç”Ÿç”£ãƒ¬ãƒ¼ãƒˆè¨ˆç®—
                    if (spec.output) {
                        const prodLevel = stats.upgrades.productionEfficiency;
                        const productionMultiplier = 1.0 - (prodLevel * 0.05);
                        const effectiveTime = Math.max(1, Math.floor(spec.time * productionMultiplier));

                        const cyclesPerMin = TICKS_PER_MINUTE / effectiveTime;
                        const outputPerMin = cyclesPerMin * spec.output.amount * (count - stalledCount);
                        
                        const outputResource = spec.output.resource;
                        totalProductionRates[outputResource] = (totalProductionRates[outputResource] || 0) + outputPerMin;
                    }
                }

                // å»ºè¨­ãƒœã‚¿ãƒ³ã®ç”Ÿæˆ (ã‚³ã‚¹ãƒˆãŒã‚ã‚‹å»ºç‰©ã®ã¿)
                if (cost > 0) {
                    let buyCount = stats.buildingCountMultiplier;
                    if (buyCount === 'max') {
                        buyCount = getMaxPurchases(cost);
                    }
                    const totalCost = cost * buyCount;
                    const displayCost = buyCount > 1 ? `(${totalCost.toFixed(0)}G)` : `(${cost.toFixed(0)}G)`;
                    
                    const buttonText = `${spec.displayName} ${displayCost}`;

                    const button = document.createElement('button');
                    button.className = 'build-button';
                    button.id = `build-${type.toLowerCase()}`;
                    button.textContent = buttonText;
                    button.onclick = () => buildBuilding(type);
                    
                    button.disabled = stats.gold < cost;
                    if (buyCount > 0 && stats.gold >= totalCost) {
                        button.disabled = false;
                    } else if (buyCount > 0 && stats.gold < totalCost) {
                        button.textContent = `${spec.displayName} (è³‡é‡‘ä¸è¶³!)`;
                        button.disabled = true;
                    }
                    
                    buildButtonsDiv.appendChild(button);
                }
            }
            
            // ç”Ÿç”£ãƒ¬ãƒ¼ãƒˆã®è¡¨ç¤º
            let rateHtml = '';
            for (const resKey in totalProductionRates) {
                 rateHtml += `<span>${RESOURCE_NAMES[resKey]}: ${totalProductionRates[resKey].toFixed(1)}/åˆ† | </span>`;
            }
            productionRatesDiv.innerHTML = rateHtml || 'ç¨¼åƒä¸­ã®ç”Ÿç”£è¨­å‚™ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
            
            // 5. ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‘ãƒãƒ«ã®æ›´æ–°
            const totalAssets = stats.gold + stats.investment + stats.loan; // ãƒ­ãƒ¼ãƒ³ã‚‚è³‡ç”£ã¨ã—ã¦è¨ˆç®—
            const prestigeGain = Math.floor(Math.log10(totalAssets / 100000) * 10) * 10; // è³‡é‡‘10ä¸‡Gã‹ã‚‰è¨ˆç®—é–‹å§‹ (ä¾‹: 10ä¸‡Gã§0, 100ä¸‡Gã§10)
            document.getElementById('prestige-gain-display').textContent = Math.max(0, prestigeGain);

            const prestigeButton = document.getElementById('prestige-button');
            const canPrestige = totalAssets >= 100000;
            prestigeButton.disabled = !canPrestige;
            prestigeButton.textContent = canPrestige ? `ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸å®Ÿè¡Œ (${prestigeGain} â­ç²å¾—)` : 'è³‡é‡‘ç·é¡10ä¸‡Gé”æˆã§è§£æ”¾';

        }

        // ç ”ç©¶ã®å®Ÿè¡Œ
        function researchUpgrade(key) {
            const spec = GLOBAL_UPGRADES[key];
            const currentLevel = stats.upgrades[key];
            const cost = spec.getCost(currentLevel);

            if (stats.gold >= cost && currentLevel < spec.maxLevel) {
                stats.gold -= cost;
                stats.upgrades[key]++;
                showMessage(`${spec.displayName}ã‚’Lv.${stats.upgrades[key]}ã«ç ”ç©¶ã—ã¾ã—ãŸï¼ (${spec.effect(stats.upgrades[key])})`, 'cyan');
            } else {
                showMessage('ç ”ç©¶è³‡é‡‘ãŒä¸è¶³ã—ã¦ã„ã‚‹ã‹ã€æœ€å¤§ãƒ¬ãƒ™ãƒ«ã§ã™ã€‚', 'red');
            }
            updateDisplay();
        }

        // å»ºç‰©ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®å®Ÿè¡Œ
        function upgradeBuilding(oldType, newType, cost) {
            if (stats.gold >= cost) {
                stats.gold -= cost;
                
                stats.buildings[newType].push(...stats.buildings[oldType]);
                stats.buildings[oldType] = [];

                stats.buildings[newType].forEach(b => {
                    b.type = newType;
                    b.spec = BUILDING_SPECS[newType];
                });

                showMessage(`${BUILDING_SPECS[oldType].displayName} å…¨${stats.buildings[newType].length}åŸºã‚’ ${BUILDING_SPECS[newType].displayName}ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ (${cost.toFixed(0)}Gæ¶ˆè²»)`, 'purple');
            } else {
                showMessage('ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰è³‡é‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ï¼', 'red');
            }
            updateDisplay();
        }

        // å»ºç‰©ã®è³¼å…¥
        function buildBuilding(type) {
            const spec = BUILDING_SPECS[type];
            const cost = spec.cost;
            let count = stats.buildingCountMultiplier;

            if (count === 'max') {
                count = getMaxPurchases(cost);
            }

            const totalCost = cost * count;

            if (count === 0) {
                showMessage('è³¼å…¥ã§ãã‚‹å»ºç‰©ã®æ•°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'red');
                return;
            }

            if (stats.gold >= totalCost) {
                stats.gold -= totalCost;
                for (let i = 0; i < count; i++) {
                    stats.buildings[type].push(new Building(type));
                }
                
                let message = `${spec.displayName}ã‚’${count}åŸºå»ºè¨­ã—ã¾ã—ãŸï¼ (${totalCost.toFixed(0)}Gæ¶ˆè²»)`;
                if (count > 1) {
                    message += ` (1åŸºã‚ãŸã‚Š${spec.cost.toFixed(0)}G)`;
                }
                showMessage(message, 'yellow');
            } else {
                showMessage('è³‡é‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ï¼', 'red');
            }
            updateDisplay();
        }

        function sellResource(resource) {
            const amount = stats.resources[resource];
            if (amount > 0) {
                const price = getResourcePrice(resource); 
                const revenue = amount * price;
                stats.gold += revenue;
                stats.resources[resource] = 0;
                
                // â˜… NEW: å¸‚å ´å®‰å®šåŒ–ç ”ç©¶ã«ã‚ˆã‚‹å£²å´ãƒšãƒŠãƒ«ãƒ†ã‚£ã®è»½æ¸›
                const stabilityLevel = stats.upgrades.marketStability;
                const reduction = 1.0 - (stabilityLevel * 0.1); // Lv.5ã§50%è»½æ¸›
                
                const marketImpact = Math.min(0.2, (amount / 1000) * 0.1) * reduction; 
                stats.market.priceAdjustment[resource] -= marketImpact;

                showMessage(`åœ¨åº«ã®${amount.toFixed(0)}${RESOURCE_UNITS[resource]}ã®${RESOURCE_NAMES[resource]}ã‚’å£²å´ã—ã€${revenue.toFixed(0)}Gã‚’ç²å¾—ã—ã¾ã—ãŸã€‚`, 'lime');
            } else {
                showMessage('å£²å´ã§ãã‚‹è³‡æºãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'yellow');
            }
            updateDisplay();
        }

        function sellAllResources() {
            let totalRevenue = 0;
            let soldCount = 0;
            
            // â˜… NEW: å¸‚å ´å®‰å®šåŒ–ç ”ç©¶ã«ã‚ˆã‚‹å£²å´ãƒšãƒŠãƒ«ãƒ†ã‚£ã®è»½æ¸›
            const stabilityLevel = stats.upgrades.marketStability;
            const reduction = 1.0 - (stabilityLevel * 0.1); 

            for (const resourceKey in stats.resources) {
                const amount = stats.resources[resourceKey];
                if (amount > 0) {
                    const price = getResourcePrice(resourceKey);
                    const revenue = amount * price;
                    totalRevenue += revenue;
                    stats.resources[resourceKey] = 0; 
                    soldCount++;
                    
                    const marketImpact = Math.min(0.2, (amount / 1000) * 0.1) * reduction; 
                    stats.market.priceAdjustment[resourceKey] -= marketImpact;
                }
            }

            if (totalRevenue > 0) {
                stats.gold += totalRevenue;
                showMessage(`å…¨${soldCount}ç¨®é¡ã®è³‡æºã‚’å£²å´ã—ã€åˆè¨ˆ${totalRevenue.toFixed(0)}Gã‚’ç²å¾—ã—ã¾ã—ãŸã€‚`, 'lime');
            } else {
                showMessage('å£²å´ã§ãã‚‹è³‡æºãŒä¸€ã¤ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚', 'yellow');
            }
            updateDisplay();
        }
        
        // æŠ•è³‡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        function investMoney(amountStr) {
            const amount = parseInt(amountStr);
            if (isNaN(amount) || amount <= 0) {
                showMessage('æœ‰åŠ¹ãªæŠ•è³‡é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'red');
                return;
            }
            if (stats.gold >= amount) {
                stats.gold -= amount;
                stats.investment += amount;
                showMessage(`${amount.toFixed(0)}Gã‚’å¸‚å ´ã«æŠ•è³‡ã—ã¾ã—ãŸã€‚å¸‚å ´å¤‰å‹•ã«ã‚ˆã‚‹åˆ©ç›Š/æå¤±ãŒç™ºç”Ÿã—ã¾ã™ã€‚`, 'orange');
            } else {
                showMessage('æŠ•è³‡è³‡é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚', 'red');
            }
            updateDisplay();
        }

        function withdrawInvestment() {
            if (stats.investment > 0) {
                stats.gold += stats.investment;
                const withdrawn = stats.investment.toFixed(0);
                stats.investment = 0;
                showMessage(`æŠ•è³‡é¡${withdrawn}Gã‚’å…¨é¡å›åã—ã¾ã—ãŸã€‚`, 'orange');
            } else {
                 showMessage('å›åã§ãã‚‹æŠ•è³‡é¡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚', 'red');
            }
            updateDisplay();
        }

        // â˜… NEW: ãƒ­ãƒ¼ãƒ³å€Ÿå…¥
        function takeLoan(amount) {
            if (stats.loan > 1000000) {
                 showMessage('å€Ÿå…¥é¡ãŒå¤§ãã™ãã¾ã™ã€‚ã¾ãšã¯è¿”æ¸ˆã—ã¦ãã ã•ã„ã€‚', 'red');
                 return;
            }
            stats.gold += amount;
            stats.loan += amount;
            showMessage(`ğŸ¦ éŠ€è¡Œã‹ã‚‰${amount.toFixed(0)}Gã‚’å€Ÿå…¥ã—ã¾ã—ãŸã€‚æ¯ãƒ†ã‚£ãƒƒã‚¯åˆ©å­ãŒç™ºç”Ÿã—ã¾ã™ï¼`, 'red');
            updateDisplay();
        }
        
        // â˜… NEW: ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆ
        function repayLoan() {
            if (stats.loan <= 0) {
                showMessage('å€Ÿå…¥é¡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚', 'yellow');
                return;
            }
            if (stats.gold >= stats.loan) {
                stats.gold -= stats.loan;
                stats.loan = 0;
                showMessage('ğŸ¦ ãƒ­ãƒ¼ãƒ³ã‚’å…¨é¡è¿”æ¸ˆã—ã¾ã—ãŸï¼ã“ã‚Œã§åˆ©å­ã«æ‚©ã¾ã•ã‚Œã¾ã›ã‚“ã€‚', 'lime');
            } else {
                showMessage('è³‡é‡‘ãŒè¶³ã‚Šãšã€å…¨é¡è¿”æ¸ˆã§ãã¾ã›ã‚“ã€‚', 'red');
            }
            updateDisplay();
        }
        
        // â˜… NEW: ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆ
        function prestigeReset() {
            const totalAssets = stats.gold + stats.investment + stats.loan;
            const prestigeGain = Math.floor(Math.log10(totalAssets / 100000) * 10) * 10;
            
            if (prestigeGain <= 0 || totalAssets < 100000) {
                showMessage('ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’è¡Œã†ã«ã¯ã€è³‡é‡‘ç·é¡100,000Gä»¥ä¸ŠãŒå¿…è¦ã§ã™ã€‚', 'red');
                return;
            }
            
            if (confirm(`ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿå…¨ã¦ã®é€²æ—ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã€${prestigeGain} â­ã‚’ç²å¾—ã—ã¾ã™ã€‚`)) {
                
                const initialStats = { // åˆæœŸçŠ¶æ…‹ã‚’å®šç¾©
                    gold: 1000, investment: 0, loan: 0, tick: 0, buildingCountMultiplier: 1, 
                    resources: { ore: 0, copper_ore: 0, coal_ore: 0, alum_ore: 0, silicon_ore: 0, titan_ore: 0, iron: 0, copper_wire: 0, steel_copper: 0, alum: 0, wafer: 0, alloy: 0, },
                    buildings: { Mine: [], CopperMine: [], CoalMine: [], AluminumMine: [], SiliconMine: [], TitaniumMine: [], Smelter: [], WireMill: [], SteelMill: [], AdvancedSmelter: [], AluminumSmelter: [], WaferFab: [], AlloyForge: [], AdvMine: [], AutoTransporter: [], Warehouse: [], TradePost: [], ContractOffice: [], },
                    upgrades: { productionEfficiency: 0, warehouseCapacity: 0, marketStability: 0, },
                    market: { priceAdjustment: { ore: 0, copper_ore: 0, coal_ore: 0, alum_ore: 0, silicon_ore: 0, titan_ore: 0, iron: 0, copper_wire: 0, steel_copper: 0, alum: 0, wafer: 0, alloy: 0, }, marketFluctuation: 1.0, },
                    achievements: { first_build: false, max_1k_gold: false, max_10k_gold: false, max_100k_gold: false, iron_master: false, wafer_creator: false, all_mines: false, adv_mine_upgrade: false }
                };
                
                // ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸é€šè²¨ã®åŠ ç®—
                stats.prestige_currency += prestigeGain;
                
                // ãƒªã‚»ãƒƒãƒˆ
                stats = Object.assign(stats, initialStats); 
                
                showMessage(`â­ ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸å®Œäº†ï¼${prestigeGain} â­ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚ã‚²ãƒ¼ãƒ ãŒæœ€åˆã‹ã‚‰å†é–‹ã•ã‚Œã¾ã™ã€‚`, 'cyan');
                switchTab('build');
                updateDisplay(BASE_STOCK_LIMIT);
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½
        function showMessage(text, color, className = '') {
            const messageArea = document.getElementById('message-area');
            messageArea.textContent = text;
            messageArea.style.color = color;
            messageArea.className = ''; 
            if (className) {
                messageArea.classList.add(className);
            } else {
                messageArea.style.backgroundColor = 'transparent'; 
            }
        }


        // --- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ---
        
        switchTab('build'); 

        function gameLoop() {
            updateGame();
            
            setTimeout(gameLoop, TICK_RATE_MS); 
        }

        // --- åˆæœŸåŒ– ---
        updateDisplay(BASE_STOCK_LIMIT);
        gameLoop(); 
    </script>
</body>
</html>