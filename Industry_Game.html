<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚·ãƒ³ãƒ—ãƒ«å·¥æ¥­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (v12.0 - UI/æ©Ÿèƒ½æ‹¡å¼µç‰ˆ)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* =========================================================================
           åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã¨UIãƒªãƒ‹ãƒ¥ãƒ¼ã‚¢ãƒ« (è¦æœ›: 2, 7, 12, 17)
           ========================================================================= */
        body { 
            background: #121212; /* æ¿ƒã„ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ */
            color: #E0E0E0; 
            text-align: center; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding-top: 15px; 
            padding-bottom: 50px; 
        }
        h1 {
            color: #4CAF50; /* ç·‘ */
            margin-bottom: 15px;
            font-size: 1.8em;
            text-shadow: 1px 1px 2px #000;
        }
        #GameArea {
            max-width: 900px; 
            margin: 0 auto;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 12px;
            background: #1E1E1E;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        /* --- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ« --- */
        #status-panel { 
            background: #282828; 
            padding: 10px; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }
        .status-box {
            background: #333;
            padding: 8px;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: 600;
        }
        .status-box .label {
            display: block;
            font-size: 0.8em;
            color: #9E9E9E;
            margin-bottom: 2px;
        }
        #gold-display, #investment-display, #prestige-currency-display {
            color: #FFC107; /* è³‡é‡‘ã¯é»„è‰² */
            transition: color 0.1s ease;
        }
        .flash-positive { color: #4CAF50 !important; } /* ç·‘ã«ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
        .flash-negative { color: #F44336 !important; } /* èµ¤ã«ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
        
        /* --- ãƒ­ãƒ¼ãƒ³/ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ --- */
        #auxiliary-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.9em;
            padding: 0 5px;
        }
        #loan-panel {
            background: #424242; 
            padding: 8px;
            border-radius: 6px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }
        .loan-action-button, .quick-sell-button {
            padding: 4px 8px;
            background-color: #FFC107;
            color: #1E1E1E;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8em;
            margin-left: 5px;
            transition: background-color 0.2s;
        }
        .loan-action-button:disabled, .quick-sell-button:disabled {
             background-color: #555;
             color: #aaa;
             cursor: not-allowed;
        }
        
        /* --- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒŠ --- */
        #tabs {
            display: flex;
            border-bottom: 1px solid #444;
        }
        .tab-button {
            flex-grow: 1;
            padding: 12px 0;
            cursor: pointer;
            background: #333;
            color: #9E9E9E;
            border: none;
            font-size: 1.0em;
            transition: background 0.3s;
        }
        .tab-button:hover:not(.active) {
            background: #444;
        }
        .tab-button.active {
            background: #1E1E1E;
            color: #4CAF50;
            font-weight: bold;
            border-bottom: 3px solid #4CAF50;
        }
        .tab-content {
            padding: 15px;
            min-height: 400px; 
            text-align: left;
            background: #1E1E1E;
            border-radius: 0 0 8px 8px;
        }

        /* --- å»ºè¨­ãƒ‘ãƒãƒ« --- */
        #build-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .building-card {
            background: #282828;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #4CAF50;
            position: relative;
        }
        .building-info { font-size: 0.9em; color: #BBB; }
        .building-info strong { color: #E0E0E0; }
        .building-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        .build-button, .sell-building-button {
            padding: 6px 12px;
            font-size: 0.9em;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .build-button {
            background-color: #4CAF50; /* ç·‘ */
            color: #1E1E1E;
        }
        .sell-building-button {
            background-color: #F44336; /* èµ¤ */
            color: white;
            padding: 4px 8px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        .upgrade-button {
            background-color: #2196F3;
            color: white;
            padding: 4px 8px;
            font-size: 0.8em;
            margin-top: 5px;
            display: block;
        }
        .upgrade-button:disabled { background-color: #555; }

        /* --- ç”Ÿç”£ãƒ¬ãƒ¼ãƒˆè©³ç´° (6, 16) --- */
        #production-status {
             background: #282828;
             padding: 10px;
             border-radius: 6px;
             margin-bottom: 15px;
             font-size: 0.9em;
        }
        .prod-line {
             display: grid;
             grid-template-columns: 2fr 1fr 1fr;
             padding: 3px 0;
             border-bottom: 1px dotted #444;
        }
        .prod-line:last-child { border-bottom: none; }
        .prod-rate { color: #FFC107; font-weight: bold;}
        .prod-stalled { color: #F44336;}

        /* --- è³‡æºãƒ‘ãƒãƒ« (5, 15) --- */
        .resource-category h3 {
            border-bottom: 2px solid #666;
            padding-bottom: 5px;
            margin-top: 20px;
            color: #9E9E9E;
        }
        .resource-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr; 
            gap: 10px;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dotted #333;
        }
        .resource-name { font-weight: bold; color: #4CAF50; font-size: 1em; }
        .price-info { font-size: 0.9em; color: #E0E0E0;}
        .sell-actions { 
            display: flex; 
            align-items: center; 
            justify-content: flex-end;
        }
        .price-change { margin-left: 5px; font-weight: bold; }
        .price-up { color: #76FF03; }
        .price-down { color: #FF7043; }
        .sell-button {
            background-color: #FFC107;
            color: #1E1E1E;
            padding: 5px 10px;
        }

        /* --- æƒ…å ±/ãƒ˜ãƒ«ãƒ—ãƒ‘ãƒãƒ« (3, 13) --- */
        #tab-info h3 {
            color: #2196F3;
            border-bottom: 1px dashed #444;
            padding-bottom: 5px;
            margin-top: 20px;
        }
        .info-card {
            background: #282828;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        .info-card strong { color: #FFC107; }
        .recipe-list {
            list-style: none;
            padding-left: 15px;
        }
        .recipe-list li {
            margin-bottom: 5px;
        }

        /* --- å®Ÿç¸¾/è»¢ç”Ÿãƒ‘ãƒãƒ« (7, 10, 17, 20) --- */
        .achievement-item {
            border: 1px solid #333;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            background: #282828; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .achievement-item.achieved {
            border-left: 5px solid #4CAF50;
            background: #233A24; 
        }
        .achievement-item.locked {
            border-left: 5px solid #555;
            color: #aaa;
        }
        
        #ranking-panel {
            background: #333;
            padding: 15px;
            margin-top: 20px;
            border-radius: 6px;
        }
        #ranking-list {
            list-style: none;
            padding: 0;
        }
        #ranking-list li {
            background: #282828;
            margin-bottom: 5px;
            padding: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            font-weight: bold;
        }
        .rank-1 { color: gold; }
        .rank-2 { color: silver; }
        .rank-3 { color: #CD7F32; }


        /* --- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ --- */
        #message-area { 
            margin-top: 15px; 
            padding: 8px;
            border-radius: 6px;
            min-height: 20px;
            font-weight: bold;
            color: #FFC107;
            background-color: #282828;
            transition: background-color 0.2s ease;
        }
        .msg-achieve { background-color: #4CAF50 !important; color: #1E1E1E !important; }
        .msg-loan { background-color: #F44336 !important; color: white !important; }

        /* å…¨ã¦ã®ãƒœã‚¿ãƒ³ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        button {
            transition: background-color 0.1s, transform 0.05s;
        }
        button:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div id="GameArea">
        <h1>ã‚·ãƒ³ãƒ—ãƒ«å·¥æ¥­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (v12.0)</h1>

        <div id="status-panel">
            <div class="status-box"><span class="label">è³‡é‡‘ (Gold)</span><span id="gold-display">1000</span></div>
            <div class="status-box"><span class="label">æŠ•è³‡é¡</span><span id="investment-display">0</span>G</div> 
            <div class="status-box"><span class="label">ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸é€šè²¨</span><span id="prestige-currency-display">0</span> â­</div>
        </div>
        
        <div id="auxiliary-status">
             <div style="color: #9E9E9E;">
                ç¨¼åƒæ™‚é–“ (Ticks): <span id="tick-display">0</span>
                | **åœ¨åº«ä¸Šé™**: <span id="stock-limit-display">1000</span>
             </div>

             <div id="loan-panel">
                <div id="loan-panel-status">å€Ÿå…¥é¡: 0G</div>
                <button class="loan-action-button" onclick="takeLoan(10000)">1ä¸‡Gå€Ÿå…¥</button>
                <button class="loan-action-button" id="repay-loan-button" onclick="repayLoan()">å…¨é¡è¿”æ¸ˆ</button>
            </div>
        </div>
        
        <div id="quick-actions" style="margin-bottom: 15px; text-align: right;">
            <button class="quick-sell-button" id="qs-wafer" onclick="sellResource('wafer')">ã‚¦ã‚§ãƒå£²å´</button>
            <button class="quick-sell-button" id="qs-alloy" onclick="sellResource('alloy')">åˆé‡‘å£²å´</button>
            <button class="quick-sell-button" id="sell-all-button" onclick="sellAllResources()">å…¨å£²å´</button>
        </div>


        <div id="tab-container">
            <div id="tabs">
                <button class="tab-button active" onclick="switchTab('build')">ğŸ› ï¸ å»ºè¨­</button>
                <button class="tab-button" onclick="switchTab('resource')">ğŸ“¦ è³‡æºãƒ»å¸‚å ´</button>
                <button class="tab-button" onclick="switchTab('research')">ğŸ”¬ ç ”ç©¶</button>
                <button class="tab-button" onclick="switchTab('achievement')">ğŸ† è»¢ç”Ÿãƒ»å®Ÿç¸¾</button>
                <button class="tab-button" onclick="switchTab('info')">â„¹ï¸ æƒ…å ±ãƒ»ãƒ˜ãƒ«ãƒ—</button>
            </div>

            <div id="tab-build" class="tab-content">
                <h2>ğŸ› ï¸ å»ºç‰©å»ºè¨­</h2>
                
                <div id="production-status">
                    <h3>ğŸ­ å»ºç‰©ç¨¼åƒçŠ¶æ³ã¨ç”Ÿç”£ãƒ¬ãƒ¼ãƒˆ (æ¯åˆ†ç”Ÿç”£æ•°: PPM)</h3>
                    <div id="prod-rate-details">ç¨¼åƒä¸­ã®è¨­å‚™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
                </div>

                <div id="investment-panel" style="background: #333; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                    <h3>ğŸ’° å¸‚å ´æŠ•è³‡</h3>
                    <div id="investment-status">ç¾åœ¨ã€0Gã‚’æŠ•è³‡ä¸­ã€‚</div>
                    <div class="invest-rate" style="font-size: 0.85em; color: #9E9E9E;">æ¯ãƒ†ã‚£ãƒƒã‚¯ $\pm 0.5\%$ ç¨‹åº¦ã®ãƒ©ãƒ³ãƒ€ãƒ å¤‰å‹•ãŒã‚ã‚Šã¾ã™ã€‚</div>
                    <div class="investment-action">
                        <input type="number" id="invest-amount" value="1000" min="100" style="padding: 5px; background: #1E1E1E; border: 1px solid #555; color: white; border-radius: 4px;">
                        <button class="invest-button" onclick="investMoney(document.getElementById('invest-amount').value)">æŠ•è³‡</button>
                        <button class="invest-button" onclick="withdrawInvestment()">å…¨é¡å›å</button>
                    </div>
                </div>
                
                <div id="multi-buy-options" style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px; background: #282828; padding: 5px; border-radius: 4px;">
                    <p style="margin-right: 15px; font-weight: bold; font-size: 0.9em;">è³¼å…¥æ•°:</p>
                    <button class="multi-buy-button selected" data-count="1" onclick="setBuildingCountMultiplier(1)">x1</button>
                    <button class="multi-buy-button" data-count="10" onclick="setBuildingCountMultiplier(10)">x10</button>
                    <button class="multi-buy-button" data-count="100" onclick="setBuildingCountMultiplier(100)">x100</button>
                    <button class="multi-buy-button" data-count="max" onclick="setBuildingCountMultiplier('max')">MAX</button>
                </div>
                
                <div id="build-buttons">
                    </div>

            </div>

            <div id="tab-resource" class="tab-content" style="display:none;">
                <h2>ğŸ“¦ è³‡æºåœ¨åº« (å¸‚å ´ä¾¡æ ¼)</h2>
                <div id="stock-limit-info" style="font-size: 0.9em; color: #4CAF50; margin-bottom: 15px;"></div>
                <div id="resource-list">
                    </div>
            </div>

            <div id="tab-research" class="tab-content" style="display:none;">
                <h2>ğŸ”¬ ç ”ç©¶é–‹ç™º</h2>
                <div id="research-list">
                    </div>
            </div>

             <div id="tab-achievement" class="tab-content" style="display:none;">
                <h2>ğŸ† å®Ÿç¸¾ (<span id="achieved-count">0</span> / <span id="total-achievements">0</span>)</h2>
                <div id="achievement-panel-container"></div>
                
                <div id="prestige-panel" style="border: 1px solid #FFC107; padding: 15px; margin-top: 20px; border-radius: 5px; background: #323232;">
                    <h3>â­ ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ (è»¢ç”Ÿ)</h3>
                    <p>ã“ã®ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã€é€²æ—ã«å¿œã˜ãŸ**ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸é€šè²¨**ã‚’ç²å¾—ã—ã¾ã™ã€‚</p>
                    <p style="font-weight: bold; font-size: 1.1em;">ç²å¾—å¯èƒ½é€šè²¨: <span id="prestige-gain-display">0</span> â­</p>
                    <p style="font-size: 0.8em; color: #ddd;">(æ¡ä»¶: è³‡é‡‘ç·é¡100,000Gä»¥ä¸Š)</p>
                    <button id="prestige-button" onclick="prestigeReset()" style="padding: 10px 20px; font-size: 1.1em; background-color: #FFC107; color: black; font-weight: bold; cursor: pointer; border: none; border-radius: 4px;">ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸å®Ÿè¡Œ</button>
                </div>

                <div id="ranking-panel">
                    <h3>ğŸ… ãƒˆãƒƒãƒ—ãƒ©ãƒ³ã‚­ãƒ³ã‚° (ãƒ­ãƒ¼ã‚«ãƒ«)</h3>
                    <ul id="ranking-list">
                        </ul>
                </div>

            </div>
            
            <div id="tab-info" class="tab-content" style="display:none;">
                <h2>â„¹ï¸ æƒ…å ±ãƒ»ãƒ˜ãƒ«ãƒ—</h2>
                <div class="info-card">
                    <strong>æ“ä½œæ–¹æ³•:</strong> çŸ¢å°ã‚­ãƒ¼ã‚„ WASD ãªã©ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒã‚¦ã‚¹ï¼ˆã¾ãŸã¯ã‚¿ãƒƒãƒ—ï¼‰ã§å»ºç‰©ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å»ºè¨­ã—ã€è‡ªå‹•ç”Ÿç”£ã‚’è¦‹å®ˆã‚Šã¾ã—ã‚‡ã†ã€‚è³‡é‡‘ãŒå¢—ãˆãŸã‚‰æ–°ã—ã„è¨­å‚™ã‚’é–‹ç™ºã—ã€å¸‚å ´ã§è³‡æºã‚’å£²å´ã—ã¾ã™ã€‚
                </div>
                
                <h3>å»ºç‰©ä¸€è¦§ã¨ãƒ¬ã‚·ãƒ”</h3>
                <div id="building-info-list">
                    </div>
            </div>


        </div>
        
        <div id="message-area">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼æ¡æ˜æ‰€ã‚’å»ºã¦ã¦è³‡æºã‚’é›†ã‚ã‚ˆã†ã€‚</div>

    </div>
    
    <script>
        // --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹å¤‰æ•° ---
        let stats = {
            gold: 1000,
            investment: 0, 
            loan: 0, 
            prestige_currency: 0, 
            tick: 0,
            buildingCountMultiplier: 1, 
            resources: {
                ore: 0, copper_ore: 0, coal_ore: 0, alum_ore: 0, silicon_ore: 0, titan_ore: 0, 
                iron: 0, copper_wire: 0, steel_copper: 0, alum: 0, wafer: 0, alloy: 0, 
            },
            buildings: {
                Mine: [], CopperMine: [], CoalMine: [], AluminumMine: [], SiliconMine: [], TitaniumMine: [], 
                Smelter: [], WireMill: [], SteelMill: [], AdvancedSmelter: [], 
                AluminumSmelter: [], WaferFab: [], AlloyForge: [], 
                AdvMine: [],
                AutoTransporter: [], 
                Warehouse: [], 
                TradePost: [], 
                ContractOffice: [], 
            },
            // â˜…ã“ã“ã‚’ä¿®æ­£ã—ã¾ã—ãŸâ˜…
            upgrades: {
                productionEfficiency: 0, warehouseCapacity: 0, marketStability: 0,
                // â˜… NEW RESEARCH ITEMS - ã‚¨ãƒ©ãƒ¼åŸå› ã®é …ç›®
                prestigeBoost: 0, // ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸é€šè²¨ç²å¾—é‡ã‚¢ãƒƒãƒ—
                autoSellEfficiency: 0, // è‡ªå‹•å£²å´æ™‚ã®åˆ©ç›Šç‡ã‚¢ãƒƒãƒ—
                loanInterestMitigation: 0, // ãƒ­ãƒ¼ãƒ³åˆ©å­è»½æ¸›
                researchSpeed: 0, // ç ”ç©¶ã‚³ã‚¹ãƒˆå‰Šæ¸›
                advancedMaterials: 0, // ä¸Šç´šç´ æã®ç”Ÿç”£åŠ¹ç‡ã‚¢ãƒƒãƒ—
            },
            market: {
                priceAdjustment: {
                    ore: 0, copper_ore: 0, coal_ore: 0, alum_ore: 0, silicon_ore: 0, titan_ore: 0, 
                    iron: 0, copper_wire: 0, steel_copper: 0, alum: 0, wafer: 0, alloy: 0, 
                },
                marketFluctuation: 1.0, 
            },
            achievements: { 
                first_build: false, max_1k_gold: false, max_10k_gold: false, max_100k_gold: false,
                iron_master: false, wafer_creator: false, all_mines: false, adv_mine_upgrade: false
            }
        };
        
        // --- å®šæ•° ---
        const TICK_RATE_MS = 100; 
        const TICKS_PER_MINUTE = 60000 / TICK_RATE_MS; 
        const BASE_STOCK_LIMIT = 1000; 
        // â˜… NEW/FIX: ãƒ­ãƒ¼ãƒ³åˆ©å­ã‚’1/10ã«è»½æ¸› (0.0005 -> 0.00005) (è¦æœ›: 4, 14)
        const LOAN_INTEREST_RATE = 0.00005; // 0.005% per tick (~3% per minute)
        const SELL_BUILDING_RATE = 0.8; // å»ºç‰©ã®å£²å´ç‡ (è¦æœ›: 9, 19)

        const BASE_RESOURCE_PRICES = {
            ore: 5, copper_ore: 8, coal_ore: 10, alum_ore: 12, silicon_ore: 15, titan_ore: 20,
            iron: 20, copper_wire: 40, steel_copper: 80, alum: 35, wafer: 100, alloy: 150,
        };
        
        const RESOURCE_NAMES = {
            ore: 'é‰„é‰±çŸ³', copper_ore: 'éŠ…é‰±çŸ³', coal_ore: 'çŸ³ç‚­', alum_ore: 'ã‚¢ãƒ«ãƒŸé‰±çŸ³', silicon_ore: 'ã‚·ãƒªã‚³ãƒ³é‰±çŸ³', titan_ore: 'ãƒã‚¿ãƒ³é‰±çŸ³',
            iron: 'é‰„', copper_wire: 'éŠ…ç·š', steel_copper: 'é‰„é‹¼éŠ…', alum: 'ã‚¢ãƒ«ãƒŸãƒ‹ã‚¦ãƒ ', wafer: 'ã‚·ãƒªã‚³ãƒ³ã‚¦ã‚§ãƒ', alloy: 'ãƒã‚¿ãƒ³åˆé‡‘'
        };

        const RESOURCE_UNITS = {
            ore: 'å€‹', copper_ore: 'å€‹', coal_ore: 'å€‹', alum_ore: 'å€‹', silicon_ore: 'å€‹', titan_ore: 'å€‹',
            iron: 'å€‹', copper_wire: 'm', steel_copper: 'å¡Š', alum: 'å¡Š', wafer: 'æš', alloy: 'å¡Š'
        };
        
        // â˜… NEW: è³‡æºã‚«ãƒ†ã‚´ãƒªå®šç¾© (è¦æœ›: 5, 15)
        const RESOURCE_CATEGORIES = {
            'åŸæ–™ (Raw)': ['ore', 'copper_ore', 'coal_ore', 'alum_ore', 'silicon_ore', 'titan_ore'],
            'ä¸­é–“åŠ å·¥å“ (Intermediate)': ['iron', 'copper_wire', 'steel_copper', 'alum'],
            'ä¸Šç´šåŠ å·¥å“ (Advanced)': ['wafer', 'alloy'],
        };
        
        // ç ”ç©¶ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å®šç¾© (è¦æœ›: 1, 11)
        const GLOBAL_UPGRADES = {
            productionEfficiency: {
                displayName: 'ç”Ÿç”£æŠ€è¡“å‘ä¸Š', maxLevel: 10, baseCost: 1000, costMultiplier: 1.5,
                effect: (level) => `ç”Ÿç”£é€Ÿåº¦ãŒ ${(level * 5)}% å‘ä¸Š`,
                getCost: (level) => Math.ceil(GLOBAL_UPGRADES.productionEfficiency.baseCost * Math.pow(GLOBAL_UPGRADES.productionEfficiency.costMultiplier, level))
            },
            warehouseCapacity: {
                displayName: 'å€‰åº«å®¹é‡æ‹¡å¼µ', maxLevel: 5, baseCost: 5000, costMultiplier: 2.0,
                effect: (level) => `å€‰åº«ã«ã‚ˆã‚‹å®¹é‡å¢—åŠ é‡ãŒ ${level*50}% å‘ä¸Š`,
                getCost: (level) => Math.ceil(GLOBAL_UPGRADES.warehouseCapacity.baseCost * Math.pow(GLOBAL_UPGRADES.warehouseCapacity.costMultiplier, level))
            },
            marketStability: { 
                displayName: 'å¸‚å ´å®‰å®šåŒ–æŠ€è¡“', maxLevel: 5, baseCost: 1500, costMultiplier: 1.8,
                effect: (level) => `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å£²å´ã«ã‚ˆã‚‹ä¾¡æ ¼ä¸‹è½ã‚’ ${(level * 10)}% è»½æ¸›`,
                getCost: (level) => Math.ceil(GLOBAL_UPGRADES.marketStability.baseCost * Math.pow(GLOBAL_UPGRADES.marketStability.costMultiplier, level))
            },
            // â˜… NEW RESEARCH â˜…
            prestigeBoost: {
                displayName: 'ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸åŠ¹ç‡åŒ–', maxLevel: 5, baseCost: 10000, costMultiplier: 2.5,
                effect: (level) => `ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸é€šè²¨ç²å¾—é‡ãŒ ${(level * 10)}% å¢—åŠ `,
                getCost: (level) => Math.ceil(GLOBAL_UPGRADES.prestigeBoost.baseCost * Math.pow(GLOBAL_UPGRADES.prestigeBoost.costMultiplier, level))
            },
            autoSellEfficiency: {
                displayName: 'è‡ªå‹•åŒ–åˆ©ç›Šå‘ä¸Š', maxLevel: 10, baseCost: 500, costMultiplier: 1.4,
                effect: (level) => `è‡ªå‹•å–å¼•æ‰€ã¨å¥‘ç´„ã‚ªãƒ•ã‚£ã‚¹ã®åˆ©ç›ŠãŒ ${(level * 5)}% å‘ä¸Š`,
                getCost: (level) => Math.ceil(GLOBAL_UPGRADES.autoSellEfficiency.baseCost * Math.pow(GLOBAL_UPGRADES.autoSellEfficiency.costMultiplier, level))
            },
            loanInterestMitigation: {
                displayName: 'åˆ©å­è»½æ¸›ç­–', maxLevel: 5, baseCost: 8000, costMultiplier: 2.0,
                effect: (level) => `ãƒ­ãƒ¼ãƒ³åˆ©å­ç™ºç”Ÿç‡ã‚’ ${(level * 15)}% è»½æ¸›`,
                getCost: (level) => Math.ceil(GLOBAL_UPGRADES.loanInterestMitigation.baseCost * Math.pow(GLOBAL_UPGRADES.loanInterestMitigation.costMultiplier, level))
            },
            researchSpeed: { 
                displayName: 'ç ”ç©¶ã‚³ã‚¹ãƒˆå‰Šæ¸›', maxLevel: 5, baseCost: 3000, costMultiplier: 1.6,
                effect: (level) => `ç ”ç©¶ã‚³ã‚¹ãƒˆãŒ ${(level * 5)}% å‰Šæ¸›`,
                getCost: (level) => Math.ceil(GLOBAL_UPGRADES.researchSpeed.baseCost * Math.pow(GLOBAL_UPGRADES.researchSpeed.costMultiplier, level))
            },
            advancedMaterials: { 
                displayName: 'ä¸Šç´šç´ æç”Ÿç”£åŠ¹ç‡', maxLevel: 5, baseCost: 12000, costMultiplier: 2.2,
                effect: (level) => `ä¸Šç´šåŠ å·¥å“ã®ç”Ÿç”£é‡ãŒ ${(level * 10)}% å¢—åŠ `,
                getCost: (level) => Math.ceil(GLOBAL_UPGRADES.advancedMaterials.baseCost * Math.pow(GLOBAL_UPGRADES.advancedMaterials.costMultiplier, level))
            }
        };

        // å»ºç‰©ã‚¹ãƒšãƒƒã‚¯å®šç¾©
        const BUILDING_SPECS = {
            // æ¡æ˜æ‰€
            Mine: { cost: 100, output: { resource: 'ore', amount: 1 }, time: 100, input: null, displayName: 'é‰„æ¡æ˜æ‰€', description: 'æœ€ã‚‚åŸºæœ¬çš„ãªè³‡æºã§ã‚ã‚‹é‰„é‰±çŸ³ã‚’æ¡æ˜ã—ã¾ã™ã€‚' },
            CopperMine: { cost: 150, output: { resource: 'copper_ore', amount: 1 }, time: 120, input: null, displayName: 'éŠ…æ¡æ˜æ‰€', description: 'éŠ…é‰±çŸ³ã‚’æ¡æ˜ã—ã¾ã™ã€‚é›»ç·šå·¥å ´ã§ä½¿ç”¨ã—ã¾ã™ã€‚' },
            CoalMine: { cost: 180, output: { resource: 'coal_ore', amount: 1 }, time: 70, input: null, displayName: 'çŸ³ç‚­æ¡æ˜æ‰€', description: 'çŸ³ç‚­ã‚’æ¡æ˜ã—ã¾ã™ã€‚å¤šãã®è£½éŒ¬æ‰€ã§ä½¿ç”¨ã•ã‚Œã‚‹é‡è¦ãªç‡ƒæ–™ã§ã™ã€‚' },
            AluminumMine: { cost: 200, output: { resource: 'alum_ore', amount: 1 }, time: 110, input: null, displayName: 'ã‚¢ãƒ«ãƒŸæ¡æ˜æ‰€', description: 'ã‚¢ãƒ«ãƒŸé‰±çŸ³ã‚’æ¡æ˜ã—ã¾ã™ã€‚ã‚¢ãƒ«ãƒŸè£½éŒ¬æ‰€ã§ä½¿ç”¨ã—ã¾ã™ã€‚' }, 
            SiliconMine: { cost: 250, output: { resource: 'silicon_ore', amount: 1 }, time: 130, input: null, displayName: 'ã‚·ãƒªã‚³ãƒ³æ¡æ˜æ‰€', description: 'ã‚·ãƒªã‚³ãƒ³é‰±çŸ³ã‚’æ¡æ˜ã—ã¾ã™ã€‚ã‚¦ã‚§ãƒå·¥å ´ã§ä½¿ç”¨ã—ã¾ã™ã€‚' }, 
            TitaniumMine: { cost: 300, output: { resource: 'titan_ore', amount: 1 }, time: 150, input: null, displayName: 'ãƒã‚¿ãƒ³æ¡æ˜æ‰€', description: 'ãƒã‚¿ãƒ³é‰±çŸ³ã‚’æ¡æ˜ã—ã¾ã™ã€‚åˆé‡‘é›é€ æ‰€ã§æœ€ã‚‚é‡è¦ãªç´ æã§ã™ã€‚' }, 

            // ä¸­é–“è£½å“å·¥å ´
            Smelter: { cost: 250, output: { resource: 'iron', amount: 1 }, time: 150, 
                input: [{ resource: 'ore', amount: 2 }, { resource: 'coal_ore', amount: 1 }], displayName: 'é‰„è£½éŒ¬æ‰€', description: 'é‰„é‰±çŸ³ã‚’åŠ å·¥ã—ã€é‰„ã‚’ç”Ÿç”£ã—ã¾ã™ã€‚' }, 
            WireMill: { cost: 400, output: { resource: 'copper_wire', amount: 1 }, time: 200, 
                input: [{ resource: 'copper_ore', amount: 2 }, { resource: 'coal_ore', amount: 1 }], displayName: 'é›»ç·šå·¥å ´', description: 'éŠ…é‰±çŸ³ã‚’åŠ å·¥ã—ã€éŠ…ç·šã‚’ç”Ÿç”£ã—ã¾ã™ã€‚' }, 
            SteelMill: { cost: 600, output: { resource: 'steel_copper', amount: 1 }, time: 300, 
                input: [{ resource: 'ore', amount: 1 }, { resource: 'copper_ore', amount: 1 }, { resource: 'coal_ore', amount: 2 }], displayName: 'è£½é‹¼æ‰€', description: 'é‰„é‰±çŸ³ã€éŠ…é‰±çŸ³ã€çŸ³ç‚­ã‚’æ··ãœã¦é‰„é‹¼éŠ…ã‚’ç”Ÿç”£ã—ã¾ã™ã€‚' }, 
            
            // ä¸Šç´šå·¥å ´
            AluminumSmelter: { cost: 350, output: { resource: 'alum', amount: 1 }, time: 180, 
                input: [{ resource: 'alum_ore', amount: 2 }, { resource: 'coal_ore', amount: 1 }], displayName: 'ã‚¢ãƒ«ãƒŸè£½éŒ¬æ‰€', description: 'ã‚¢ãƒ«ãƒŸé‰±çŸ³ã‚’åŠ å·¥ã—ã€ã‚¢ãƒ«ãƒŸãƒ‹ã‚¦ãƒ ã‚’ç”Ÿç”£ã—ã¾ã™ã€‚' },
            WaferFab: { cost: 800, output: { resource: 'wafer', amount: 1 }, time: 250, 
                input: [{ resource: 'silicon_ore', amount: 1 }, { resource: 'coal_ore', amount: 2 }, { resource: 'alum', amount: 1 }], displayName: 'ã‚¦ã‚§ãƒå·¥å ´', description: 'ã‚·ãƒªã‚³ãƒ³ã‚¦ã‚§ãƒã‚’ç”Ÿç”£ã™ã‚‹ãƒã‚¤ãƒ†ã‚¯å·¥å ´ã§ã™ã€‚é«˜é¡ã§å£²å´ã§ãã¾ã™ã€‚' },
            AlloyForge: { cost: 1200, output: { resource: 'alloy', amount: 1 }, time: 400, 
                input: [{ resource: 'titan_ore', amount: 1 }, { resource: 'iron', amount: 1 }, { resource: 'steel_copper', amount: 1 }], displayName: 'åˆé‡‘é›é€ æ‰€', description: 'ãƒã‚¿ãƒ³åˆé‡‘ã‚’ç”Ÿç”£ã™ã‚‹æœ€çµ‚åŠ å·¥æ–½è¨­ã§ã™ã€‚æœ€ã‚‚é«˜é¡ãªè£½å“ã§ã™ã€‚' },

            // åŠ¹ç‡ã®è‰¯ã„å·¥å ´
            AdvancedSmelter: { cost: 900, output: { resource: 'steel_copper', amount: 1 }, time: 250,
                input: [{ resource: 'ore', amount: 1 }, { resource: 'copper_wire', amount: 1 }], displayName: 'ä¸Šç´šè£½éŒ¬æ‰€', description: 'ã‚ˆã‚Šæ´—ç·´ã•ã‚ŒãŸãƒ¬ã‚·ãƒ”ã§é‰„é‹¼éŠ…ã‚’ç”Ÿç”£ã—ã¾ã™ã€‚' },


            // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å»ºç‰©
            AutoTransporter: { 
                cost: 1500, output: null, time: 20, 
                input: null, displayName: 'è‡ªå‹•æ¬é€æ©Ÿ', description: 'ä¸­é–“è³‡æºï¼ˆé‰„ã€éŠ…ç·šãªã©ï¼‰ã‚’è‡ªå‹•ã§å£²å´ã—ã¾ã™ã€‚'
            },
            Warehouse: {
                cost: 2000, output: null, time: 0,
                input: null, displayName: 'å€‰åº« (å®¹é‡æ‹¡å¼µ)', description: 'åœ¨åº«ä¸Šé™ã‚’æ‹¡å¼µã—ã¾ã™ã€‚ç ”ç©¶ã§åŠ¹æœãŒå¢—åŠ ã—ã¾ã™ã€‚'
            },
            TradePost: { 
                cost: 5000, output: null, time: 100, 
                input: null, displayName: 'è‡ªå‹•å–å¼•æ‰€', description: 'æœ€ã‚‚é«˜ä¾¡ãªä¸Šç´šè³‡æºï¼ˆã‚¦ã‚§ãƒã€åˆé‡‘ï¼‰ã‚’è‡ªå‹•ã§å£²å´ã—ã¾ã™ã€‚'
            },
            ContractOffice: { 
                cost: 3000, output: null, time: 200, 
                input: null, displayName: 'å¥‘ç´„ã‚ªãƒ•ã‚£ã‚¹ (å®‰å®šå£²å´)', description: 'è³‡æºã‚’å¸‚å ´ä¾¡æ ¼ã«å½±éŸ¿ã‚’ä¸ãˆãšã«ã€å›ºå®šã®é«˜å€¤ã§å£²å´ã—ã¾ã™ã€‚'
            },
            
            // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å»ºç‰©
            AdvMine: { cost: 0, output: { resource: 'ore', amount: 2 }, time: 100, input: null, displayName: 'ä¸Šç´šé‰„æ¡æ˜æ‰€', description: 'é‰„æ¡æ˜æ‰€ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã€2å€ã®é‰„é‰±çŸ³ã‚’æ¡æ˜ã—ã¾ã™ã€‚' }
        };
        
        const AUTO_SELL_RESOURCES = ['iron', 'copper_wire', 'steel_copper', 'alum'];

        // å®Ÿç¸¾å®šç¾©
        const ACHIEVEMENT_DEFINITIONS = {
            first_build: { name: 'æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—', description: 'ä»»æ„ã®å»ºç‰©ã‚’1åŸºå»ºè¨­ã™ã‚‹ã€‚', check: () => getTotalBuildings() >= 1 },
            max_1k_gold: { name: 'åˆæœŸæŠ•è³‡å®¶', description: 'è³‡é‡‘ã®ç·é¡ï¼ˆæ‰‹æŒã¡ï¼‹æŠ•è³‡ï¼‰ãŒ1,000Gã‚’è¶…ãˆã‚‹ã€‚', check: () => stats.gold + stats.investment >= 1000 && stats.tick > 10 },
            max_10k_gold: { name: 'ä¸­å …ä¼æ¥­', description: 'è³‡é‡‘ã®ç·é¡ï¼ˆæ‰‹æŒã¡ï¼‹æŠ•è³‡ï¼‰ãŒ10,000Gã‚’è¶…ãˆã‚‹ã€‚', check: () => stats.gold + stats.investment >= 10000 },
            max_100k_gold: { name: 'å¤§å¯Œè±ª', description: 'è³‡é‡‘ã®ç·é¡ï¼ˆæ‰‹æŒã¡ï¼‹æŠ•è³‡ï¼‰ãŒ100,000Gã‚’è¶…ãˆã‚‹ã€‚', check: () => stats.gold + stats.investment >= 100000 },
            iron_master: { name: 'é‰„ã®åŸºç¤', description: 'é‰„è£½éŒ¬æ‰€ã‚’10åŸºä»¥ä¸Šå»ºè¨­ã™ã‚‹ã€‚', check: () => stats.buildings.Smelter.length >= 10 },
            wafer_creator: { name: 'ãƒã‚¤ãƒ†ã‚¯å‚å…¥', description: 'ã‚·ãƒªã‚³ãƒ³ã‚¦ã‚§ãƒã‚’åˆã‚ã¦ç”Ÿç”£ã™ã‚‹ã€‚', check: () => stats.resources.wafer > 0 },
            all_mines: { name: 'å…¨è³‡æºåˆ¶è¦‡', description: 'å…¨6ç¨®é¡ã®æ¡æ˜æ‰€ã‚’1åŸºä»¥ä¸Šå»ºè¨­ã™ã‚‹ã€‚', check: () => ['Mine', 'CopperMine', 'CoalMine', 'AluminumMine', 'SiliconMine', 'TitaniumMine'].every(t => stats.buildings[t].length >= 1) },
            adv_mine_upgrade: { name: 'è¿‘ä»£åŒ–', description: 'ä¸Šç´šæ¡æ˜æ‰€ã‚’åˆã‚ã¦å»ºè¨­ã™ã‚‹ã€‚', check: () => stats.buildings.AdvMine.length > 0 }
        };

        let lastGold = stats.gold;
        let lastResources = {...stats.resources};
        
        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

        function getTotalBuildings() {
            return Object.values(stats.buildings).flat().length;
        }
        
        // â˜… NEW: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’Local Storageã‹ã‚‰èª­ã¿è¾¼ã¿/æ›¸ãå‡ºã— (è¦æœ›: 10, 20)
        function loadRanking() {
            try {
                const ranking = JSON.parse(localStorage.getItem('industryRanking')) || [];
                return Array.isArray(ranking) ? ranking : [];
            } catch (e) {
                console.error("Failed to load ranking:", e);
                return [];
            }
        }
        
        function saveRanking(newScore) {
            let ranking = loadRanking();
            
            // æ–°ã—ã„ã‚¹ã‚³ã‚¢ã‚’è¿½åŠ 
            const rankEntry = {
                score: newScore,
                date: new Date().toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
            };
            ranking.push(rankEntry);
            
            // ã‚¹ã‚³ã‚¢ãŒé«˜ã„é †ã«ã‚½ãƒ¼ãƒˆã—ã€ãƒˆãƒƒãƒ—10ã®ã¿ä¿æŒ
            ranking.sort((a, b) => b.score - a.score);
            ranking = ranking.slice(0, 10);
            
            localStorage.setItem('industryRanking', JSON.stringify(ranking));
        }

        // --- ã‚¯ãƒ©ã‚¹å®šç¾© ---
        class Building {
            constructor(type) {
                this.type = type;
                this.spec = BUILDING_SPECS[type];
                this.timer = 0;
                this.isStalled = false; 
            }

            // ... (Building.updateã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ã»ã¼å¤‰æ›´ãªã—ã€‚è‡ªå‹•å£²å´éƒ¨åˆ†ã«ç ”ç©¶åŠ¹æœã‚’åæ˜ ) ...
            update(productionMultiplier, stockLimit) {
                this.timer++;
                this.isStalled = false; 
                
                const effectiveTime = Math.max(1, Math.floor(this.spec.time * productionMultiplier));
                const { resource: outputRes, amount: outputAmt } = this.spec.output || {};

                // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å»ºç‰©ï¼ˆç”Ÿç”£ã—ãªã„ï¼‰
                if (!outputRes) {
                    if (this.type === 'AutoTransporter' && this.timer >= effectiveTime) {
                         autoSellOneResource(); 
                         this.timer = 0;
                         return false;
                    }
                    
                    if (this.type === 'TradePost' && this.timer >= effectiveTime) {
                        autoTradeHighValueResource();
                        this.timer = 0;
                        return false;
                    }

                    if (this.type === 'ContractOffice' && this.timer >= effectiveTime) {
                         autoContractSell(); 
                         this.timer = 0;
                         return false;
                    }

                    if (this.type === 'Warehouse') return false; 
                    return false;
                }

                if (this.timer >= effectiveTime) {
                    // â˜… NEW: ä¸Šç´šç´ æç”Ÿç”£åŠ¹ç‡ã‚¢ãƒƒãƒ—ç ”ç©¶
                    let finalOutputAmt = outputAmt;
                    if (RESOURCE_CATEGORIES['ä¸Šç´šåŠ å·¥å“ (Advanced)'].includes(outputRes)) {
                        const level = stats.upgrades.advancedMaterials;
                        finalOutputAmt *= (1.0 + level * 0.1); // Lv1ã§10%å¢—
                    }
                    
                    // åœ¨åº«ä¸Šé™ãƒã‚§ãƒƒã‚¯ (ç”Ÿç”£ãŒã‚¹ãƒˆãƒƒãƒ—ã™ã‚‹æ¡ä»¶)
                    if (stats.resources[outputRes] + finalOutputAmt > stockLimit) {
                        this.isStalled = true; 
                        return false; 
                    }

                    // ææ–™ãƒã‚§ãƒƒã‚¯ã¨æ¶ˆè²»
                    if (this.spec.input) {
                        let canProduce = true;
                        
                        for (const requirement of this.spec.input) {
                            if (stats.resources[requirement.resource] < requirement.amount) {
                                canProduce = false;
                                break;
                            }
                        }

                        if (!canProduce) {
                            this.isStalled = true; 
                            return false; 
                        }

                        for (const requirement of this.spec.input) {
                            stats.resources[requirement.resource] -= requirement.amount;
                        }
                    }
                    
                    // ç”Ÿç”£
                    stats.resources[outputRes] += finalOutputAmt;
                    this.timer = 0; 
                    return true; 
                }
                return false; 
            }
        }

        // --- ã‚²ãƒ¼ãƒ ç®¡ç†é–¢æ•° ---
        
        // è‡ªå‹•æ¬é€æ©Ÿã«ã‚ˆã‚‹ä¸­é–“è³‡æºã®è‡ªå‹•å£²å´
        function autoSellOneResource() {
            const sellEfficiencyLevel = stats.upgrades.autoSellEfficiency;
            const efficiencyMultiplier = 1.0 + sellEfficiencyLevel * 0.05; // 5% per level
            
            for (let i = 0; i < stats.buildings.AutoTransporter.length; i++) {
                const resKey = AUTO_SELL_RESOURCES[i % AUTO_SELL_RESOURCES.length];
                
                if (stats.resources[resKey] > 0) {
                    const amountToSell = 1; 
                    const price = getResourcePrice(resKey);
                    const revenue = amountToSell * price * efficiencyMultiplier; // åŠ¹ç‡ç ”ç©¶é©ç”¨
                    
                    stats.gold += revenue;
                    stats.resources[resKey] -= amountToSell;
                    
                    const marketImpact = 0.00005; 
                    stats.market.priceAdjustment[resKey] -= marketImpact; 
                }
            }
        }

        // è‡ªå‹•å–å¼•æ‰€ã«ã‚ˆã‚‹é«˜ä¾¡å€¤è³‡æºã®å–å¼•
        function autoTradeHighValueResource() {
            const sellEfficiencyLevel = stats.upgrades.autoSellEfficiency;
            const efficiencyMultiplier = 1.0 + sellEfficiencyLevel * 0.05; 
            
            for (let i = 0; i < stats.buildings.TradePost.length; i++) {
                let targetResource = null;
                const waferPrice = getResourcePrice('wafer');
                const alloyPrice = getResourcePrice('alloy');

                if (stats.resources.wafer > 0 && stats.resources.alloy === 0) {
                     targetResource = 'wafer';
                } else if (stats.resources.alloy > 0 && stats.resources.wafer === 0) {
                     targetResource = 'alloy';
                } else if (stats.resources.wafer > 0 && stats.resources.alloy > 0) {
                    targetResource = waferPrice >= alloyPrice ? 'wafer' : 'alloy';
                }

                if (targetResource) {
                    const price = getResourcePrice(targetResource);
                    const revenue = Math.floor(price * 0.9 * efficiencyMultiplier); // åŠ¹ç‡ç ”ç©¶é©ç”¨
                    
                    stats.gold += revenue;
                    stats.resources[targetResource] -= 1;
                    
                    const marketImpact = 0.00001; 
                    stats.market.priceAdjustment[targetResource] -= marketImpact;
                }
            }
        }

        // å¥‘ç´„ã‚ªãƒ•ã‚£ã‚¹ã«ã‚ˆã‚‹å®‰å®šå£²å´ (å¸‚å ´ä¾¡æ ¼ã«å½±éŸ¿ãªã—)
        function autoContractSell() {
            const sellEfficiencyLevel = stats.upgrades.autoSellEfficiency;
            const efficiencyMultiplier = 1.0 + sellEfficiencyLevel * 0.05; 
            
            const contractSellable = ['iron', 'copper_wire', 'steel_copper', 'alum', 'wafer', 'alloy'];
            const availableResources = contractSellable.filter(r => stats.resources[r] > 0);
            
            if (availableResources.length > 0) {
                const resKey = availableResources[Math.floor(Math.random() * availableResources.length)];
                const basePrice = BASE_RESOURCE_PRICES[resKey];
                const revenue = Math.floor(basePrice * 1.5 * efficiencyMultiplier); // åŠ¹ç‡ç ”ç©¶é©ç”¨

                stats.gold += revenue;
                stats.resources[resKey] -= 1;
            }
        }


        // æŠ•è³‡æ©Ÿèƒ½ã®æ›´æ–°
        function updateInvestment() {
            if (stats.investment <= 0) return;

            const fluctuationRate = (Math.random() * 0.01) - 0.005; // -0.5% ã‹ã‚‰ 0.5% (è¦æœ›: 4, 14)
            const changeAmount = Math.floor(stats.investment * fluctuationRate);
            
            stats.investment += changeAmount;
            stats.investment = Math.max(0, stats.investment); 
        }

        // ãƒ­ãƒ¼ãƒ³åˆ©å­ã®è¨ˆç®—
        function updateLoanInterest() {
             if (stats.loan <= 0) return;

             const mitigationLevel = stats.upgrades.loanInterestMitigation;
             const interestMultiplier = 1.0 - mitigationLevel * 0.15; // 15% per level
             
             let interest = Math.floor(stats.loan * LOAN_INTEREST_RATE * interestMultiplier);
             
             // å€Ÿå…¥ãŒ100,000Gã‚’è¶…ãˆãŸå ´åˆã€åˆ©å­ãŒåŠ é€Ÿã™ã‚‹ï¼ˆãƒšãƒŠãƒ«ãƒ†ã‚£ï¼‰
             if (stats.loan > 100000) {
                 const penaltyInterest = Math.floor(stats.loan * 0.00001); // è¿½åŠ ã§0.001%
                 interest += penaltyInterest;
             }
             
             stats.loan += interest;
        }

        // å®Ÿç¸¾ãƒã‚§ãƒƒã‚¯
        function checkAchievements() {
            for (const key in ACHIEVEMENT_DEFINITIONS) {
                if (!stats.achievements[key]) {
                    if (ACHIEVEMENT_DEFINITIONS[key].check()) {
                        stats.achievements[key] = true;
                        showMessage(`ğŸ† å®Ÿç¸¾é”æˆï¼: ${ACHIEVEMENT_DEFINITIONS[key].name}`, 'lime', 'msg-achieve');
                    }
                }
            }
        }

        function updateGame() {
            stats.tick++;
            
            updateMarket(); 
            updateInvestment(); 
            updateLoanInterest(); 
            checkAchievements();
            
            // â˜… NEW: ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã®å‰çŠ¶æ…‹ä¿å­˜ (è¦æœ›: 8, 18)
            lastGold = stats.gold;
            lastResources = {...stats.resources};

            const prodLevel = stats.upgrades.productionEfficiency;
            const productionMultiplier = 1.0 - (prodLevel * 0.05); 
            
            const capacityLevel = stats.upgrades.warehouseCapacity;
            const capacityMultiplier = 1.0 + (capacityLevel * 0.5); 
            const warehouseBonus = stats.buildings.Warehouse.length * 5000; 
            const stockLimit = BASE_STOCK_LIMIT + (warehouseBonus * capacityMultiplier);


            for (const type in stats.buildings) {
                stats.buildings[type].forEach(building => {
                    building.update(productionMultiplier, stockLimit);
                });
            }

            updateDisplay(stockLimit);
            
            // â˜… NEW: ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ (è¦æœ›: 8, 18)
            applyFlashAnimations();
        }
        
        // å¸‚å ´å¤‰å‹•ã®æ›´æ–°
        function updateMarket() {
            // A. ãƒ©ãƒ³ãƒ€ãƒ ãªå¸‚å ´å¤‰å‹• (2ç§’ã”ã¨)
            if (stats.tick % 20 === 0) { 
                const maxFluctuation = 0.05; 
                const randomChange = (Math.random() * maxFluctuation * 2) - maxFluctuation;
                stats.market.marketFluctuation = Math.min(1.2, Math.max(0.8, stats.market.marketFluctuation + randomChange));
            }

            // B. å£²å´ã«ã‚ˆã‚‹ä¾¡æ ¼ä¸‹è½ã®å›å¾©
            for (const key in stats.market.priceAdjustment) {
                if (stats.market.priceAdjustment[key] < 0) {
                    stats.market.priceAdjustment[key] = Math.min(0, stats.market.priceAdjustment[key] + 0.001); 
                }
            }
        }

        // è³‡æºã®ç¾åœ¨ä¾¡æ ¼ã‚’å–å¾—
        function getResourcePrice(resourceKey) {
            const basePrice = BASE_RESOURCE_PRICES[resourceKey];
            const randomMultiplier = stats.market.marketFluctuation;
            const saleAdjustment = 1.0 + stats.market.priceAdjustment[resourceKey];
            
            return Math.max(1, Math.floor(basePrice * randomMultiplier * saleAdjustment));
        }

        // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–¢æ•° ---

        // å»ºç‰©ã®å£²å´ (è¦æœ›: 9, 19)
        function sellBuilding(type) {
            const buildingsOfType = stats.buildings[type];
            if (buildingsOfType && buildingsOfType.length > 0) {
                
                let count = stats.buildingCountMultiplier;
                if (count === 'max') {
                    count = buildingsOfType.length;
                }
                count = Math.min(count, buildingsOfType.length);
                
                if (count === 0) return;

                const cost = BUILDING_SPECS[type].cost;
                const totalRefund = Math.floor(cost * count * SELL_BUILDING_RATE);
                
                stats.gold += totalRefund;
                buildingsOfType.splice(0, count); // å…ˆé ­ã‹ã‚‰æŒ‡å®šæ•°å‰Šé™¤

                showMessage(`${BUILDING_SPECS[type].displayName}ã‚’${count}åŸºå£²å´ã—ã€${totalRefund.toFixed(0)}Gã‚’å›åã—ã¾ã—ãŸã€‚ (80%è¿”é‡‘)`, 'orange');
            } else {
                showMessage('å£²å´ã§ãã‚‹å»ºç‰©ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'yellow');
            }
            updateDisplay();
        }

        // è³¼å…¥æ•°ä¹—æ•°ã®è¨­å®š
        function setBuildingCountMultiplier(count) {
            stats.buildingCountMultiplier = count;
            document.querySelectorAll('.multi-buy-button').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.getAttribute('data-count') == count) {
                    btn.classList.add('selected');
                }
            });
            updateDisplay(); 
        }

        // æœ€å¤§è³¼å…¥å¯èƒ½æ•°ã®è¨ˆç®—
        function getMaxPurchases(cost) {
            if (cost === 0) return 99999;
            return Math.floor(stats.gold / cost);
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(`tab-${tabId}`).style.display = 'block';
            document.querySelector(`.tab-button[onclick*="'${tabId}'"]`).classList.add('active');
            
            // æƒ…å ±ã‚¿ãƒ–ã‚’é–‹ã„ãŸã¨ãã«æƒ…å ±ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
            if (tabId === 'info') {
                 generateInfoList();
            }
            
            // å®Ÿç¸¾ã‚¿ãƒ–ã‚’é–‹ã„ãŸã¨ãã«å®Ÿç¸¾ã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ç”Ÿæˆ
            if (tabId === 'achievement') {
                 generateAchievementList();
                 generateRankingList();
            }
        }
        
        // --- UIæç”»é–¢æ•° ---

        // â˜… NEW: ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é©ç”¨ (è¦æœ›: 8, 18)
        function applyFlashAnimations() {
            // ã‚´ãƒ¼ãƒ«ãƒ‰ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
            const goldDisplay = document.getElementById('gold-display');
            if (stats.gold > lastGold) {
                goldDisplay.classList.add('flash-positive');
            } else if (stats.gold < lastGold) {
                goldDisplay.classList.add('flash-negative');
            }
            setTimeout(() => {
                goldDisplay.classList.remove('flash-positive', 'flash-negative');
            }, 100); 

            // è³‡æºã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ (ãƒªã‚½ãƒ¼ã‚¹ã‚¿ãƒ–ãŒé–‹ã„ã¦ã„ã‚Œã°)
            if (document.getElementById('tab-resource').style.display !== 'none') {
                for (const key in stats.resources) {
                    if (stats.resources[key] > lastResources[key]) {
                        const element = document.getElementById(`${key}-display`);
                        if (element) {
                            element.classList.add('flash-positive');
                            setTimeout(() => { element.classList.remove('flash-positive'); }, 100);
                        }
                    }
                }
            }
        }
        
        // UIæç”»ã®æ›´æ–°
        function updateDisplay(stockLimit) {
            // 1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (å¸¸ã«è¡¨ç¤º)
            document.getElementById('gold-display').textContent = stats.gold.toFixed(0); 
            document.getElementById('investment-display').textContent = stats.investment.toFixed(0); 
            document.getElementById('tick-display').textContent = stats.tick;
            document.getElementById('stock-limit-display').textContent = stockLimit.toFixed(0);
            document.getElementById('stock-limit-info').textContent = `ç¾åœ¨ã®åœ¨åº«ä¸Šé™: ${stockLimit.toFixed(0)}`;
            document.getElementById('prestige-currency-display').textContent = stats.prestige_currency.toFixed(0);

            // 1A. ãƒ­ãƒ¼ãƒ³ãƒ‘ãƒãƒ«ã®æ›´æ–°
            const loanStatusDiv = document.getElementById('loan-panel-status');
            const repayButton = document.getElementById('repay-loan-button');
            
            // â˜… FIX: interestMultiplierã‚’ä½¿ç”¨ã™ã‚‹éš›ã«upgradesã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹
            const mitigationLevel = stats.upgrades.loanInterestMitigation || 0;
            const interestMultiplier = 1.0 - mitigationLevel * 0.15;
            const interestRateDisplay = (LOAN_INTEREST_RATE * TICKS_PER_MINUTE * interestMultiplier * 100).toFixed(4);
            
            if (stats.loan > 0) {
                 loanStatusDiv.innerHTML = `å€Ÿå…¥é¡: <span style="color: #FF7043;">${stats.loan.toFixed(0)}G</span> (åˆ©å­ç´„${interestRateDisplay}\%/åˆ†)`;
                 repayButton.disabled = stats.gold < stats.loan;
                 repayButton.textContent = `å…¨é¡è¿”æ¸ˆ (${stats.loan.toFixed(0)}G)`;
            } else {
                 loanStatusDiv.textContent = 'å€Ÿå…¥é¡: 0G (å€Ÿã‚Šå…¥ã‚Œå¯èƒ½)';
                 repayButton.disabled = true;
                 repayButton.textContent = `å…¨é¡è¿”æ¸ˆ (0G)`;
            }

            // 1B. ã‚¯ã‚¤ãƒƒã‚¯å£²å´ãƒœã‚¿ãƒ³ã®æ›´æ–°
            document.getElementById('qs-wafer').disabled = stats.resources.wafer === 0;
            document.getElementById('qs-alloy').disabled = stats.resources.alloy === 0;
            let totalStock = Object.values(stats.resources).reduce((sum, current) => sum + current, 0);
            document.getElementById('sell-all-button').disabled = totalStock === 0;
            
            // æŠ•è³‡ãƒ‘ãƒãƒ«ã®æ›´æ–°
            const investAmount = document.getElementById('invest-amount').value;
            document.querySelector('#investment-panel .invest-button:nth-child(2)').disabled = stats.gold < investAmount;
            document.querySelector('#investment-panel .invest-button:nth-child(3)').disabled = stats.investment <= 0;
            document.getElementById('investment-status').textContent = `ç¾åœ¨ã€${stats.investment.toFixed(0)}Gã‚’æŠ•è³‡ä¸­ã€‚`;


            // 2. è³‡æºãƒªã‚¹ãƒˆã®å‹•çš„ç”Ÿæˆ (è³‡æºã‚¿ãƒ–)
            const resourceList = document.getElementById('resource-list');
            if (resourceList.parentElement.style.display !== 'none') {
                resourceList.innerHTML = '';
                
                // â˜… NEW: ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«è¡¨ç¤º (è¦æœ›: 5, 15)
                for (const category in RESOURCE_CATEGORIES) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'resource-category';
                    categoryDiv.innerHTML = `<h3>${category}</h3>`;
                    
                    RESOURCE_CATEGORIES[category].forEach(key => {
                        const amount = stats.resources[key];
                        const price = getResourcePrice(key); 
                        const displayName = RESOURCE_NAMES[key];
                        const unit = RESOURCE_UNITS[key];
                        
                        const basePrice = BASE_RESOURCE_PRICES[key];
                        const priceChangePercent = ((price / basePrice) - 1) * 100;
                        let changeClass = 'price-down';
                        let changeIcon = 'â–¼';
                        if (priceChangePercent > 0.1) {
                            changeClass = 'price-up';
                            changeIcon = 'â–²';
                        } else if (priceChangePercent > -0.1) {
                            changeIcon = 'ï¼';
                            changeClass = '';
                        }

                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'resource-item';
                        
                        itemDiv.innerHTML += `
                            <span class="resource-name">${displayName}</span>
                            <span class="resource-value" id="${key}-display">${amount.toFixed(0)} ${unit}</span>
                            <div class="sell-actions">
                                <span class="price-info">
                                    ${price}G/${unit} 
                                    <span class="${changeClass} price-change">
                                        ${changeIcon}${Math.abs(priceChangePercent).toFixed(1)}%
                                    </span>
                                </span>
                                <button class="sell-button" onclick="sellResource('${key}')" ${amount === 0 ? 'disabled' : ''}>
                                    å£²å´
                                </button>
                            </div>
                        `;
                        categoryDiv.appendChild(itemDiv);
                    });
                    resourceList.appendChild(categoryDiv);
                }
            }

            // 3. ç ”ç©¶ãƒ‘ãƒãƒ«ã®æ›´æ–° (ç ”ç©¶ã‚¿ãƒ–)
            const researchList = document.getElementById('research-list');
            if (researchList.parentElement.style.display !== 'none') {
                researchList.innerHTML = '';
                for (const key in GLOBAL_UPGRADES) {
                    const spec = GLOBAL_UPGRADES[key];
                    const currentLevel = stats.upgrades[key];
                    const nextLevel = currentLevel + 1;
                    const cost = spec.getCost(currentLevel);
                    const isMax = currentLevel >= spec.maxLevel;
                    
                    const researchDiv = document.createElement('div');
                    researchDiv.className = 'research-item';
                    researchDiv.style.borderLeft = `5px solid #2196F3`;
                    researchDiv.style.backgroundColor = `#282828`;
                    researchDiv.style.padding = '10px';
                    researchDiv.style.marginBottom = '10px';
                    researchDiv.style.borderRadius = '5px';
                    
                    // â˜… NEW: ç ”ç©¶ã‚³ã‚¹ãƒˆå‰Šæ¸›ç ”ç©¶ã®åæ˜ 
                    const researchCostReduction = (stats.upgrades.researchSpeed || 0) * 0.05; // 5% per level
                    const finalCost = Math.ceil(cost * (1.0 - researchCostReduction));

                    researchDiv.innerHTML = `
                        <span style="font-weight: bold; color: #FFEB3B; font-size: 1.1em;">${spec.displayName} (Lv.${currentLevel})</span>
                        <p style="margin: 5px 0; font-size: 0.9em; color: #aaa;">
                            ${isMax ? 'æœ€å¤§ãƒ¬ãƒ™ãƒ«é”æˆã€‚' : `æ¬¡ãƒ¬ãƒ™ãƒ«åŠ¹æœ: ${spec.effect(nextLevel)}`}
                        </p>
                        <button class="research-button" 
                                onclick="researchUpgrade('${key}')" 
                                ${stats.gold < finalCost || isMax ? 'disabled' : ''}>
                            ${isMax ? 'æœ€å¤§' : `ç ”ç©¶ (${finalCost}G)`}
                        </button>
                    `;
                    researchList.appendChild(researchDiv);
                }
            }


            // 4. å»ºè¨­çŠ¶æ³ã¨ç”Ÿç”£èƒ½åŠ›ã®è¨ˆç®—ãƒ»è¡¨ç¤º (å»ºè¨­ã‚¿ãƒ–)
            const buildButtonsDiv = document.getElementById('build-buttons');
            const prodRateDetailsDiv = document.getElementById('prod-rate-details');

            if (buildButtonsDiv.parentElement.style.display !== 'none') {
                buildButtonsDiv.innerHTML = '';
                prodRateDetailsDiv.innerHTML = '';

                let totalProductionRates = {};
                let buildingTypes = Object.keys(BUILDING_SPECS);
                let statusHtml = '';

                const prodLevel = stats.upgrades.productionEfficiency;
                const productionMultiplier = 1.0 - (prodLevel * 0.05); 
                
                // å»ºç‰©ã‚«ãƒ¼ãƒ‰ã®ç”Ÿæˆ
                for (const type of buildingTypes) {
                    const spec = BUILDING_SPECS[type];
                    const count = stats.buildings[type].length;
                    const cost = spec.cost;
                    const isMineUpgrade = type === 'AdvMine';
                    const canBuy = cost > 0;

                    // å»ºç‰©ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º (ç¨¼åƒçŠ¶æ³ã¨è©³ç´°ãƒ¬ãƒ¼ãƒˆ)
                    if (count > 0 || canBuy) {
                        let stalledCount = 0;
                        if (spec.output) { 
                             stats.buildings[type].forEach(b => {
                                 if (b.isStalled) stalledCount++;
                             });
                        }
                        
                        // ç”Ÿç”£ãƒ¬ãƒ¼ãƒˆè¨ˆç®— (è¦æœ›: 6, 16)
                        if (spec.output) {
                            const effectiveTime = Math.max(1, Math.floor(spec.time * productionMultiplier));
                            const cyclesPerMin = TICKS_PER_MINUTE / effectiveTime;
                            const outputPerMinTotal = cyclesPerMin * spec.output.amount * count;
                            const outputPerMinActual = cyclesPerMin * spec.output.amount * (count - stalledCount);
                            
                            const outputResource = spec.output.resource;
                            totalProductionRates[outputResource] = (totalProductionRates[outputResource] || 0) + outputPerMinActual;
                            
                            statusHtml += `
                                <div class="prod-line">
                                    <div>${spec.displayName} (${count}åŸº) â†’ ${RESOURCE_NAMES[outputResource]}</div>
                                    <div class="prod-rate">${outputPerMinActual.toFixed(1)} / åˆ†</div>
                                    <div class="prod-stalled">${stalledCount > 0 ? `(${stalledCount} åœæ­¢)` : 'ç¨¼åƒä¸­'}</div>
                                </div>
                            `;
                        } else if (type !== 'Warehouse' && count > 0) {
                            // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ãƒ¬ãƒ¼ãƒˆè¡¨ç¤º
                            let utilRate = '';
                            if (type === 'AutoTransporter') utilRate = `${count * 3}è³‡æº/åˆ†`;
                            if (type === 'TradePost') utilRate = `${count * 6}è³‡æº/åˆ†`;
                            if (type === 'ContractOffice') utilRate = `${count * 3}è³‡æº/åˆ†`;
                             statusHtml += `
                                <div class="prod-line" style="background: rgba(255, 193, 7, 0.1);">
                                    <div>${spec.displayName} (${count}åŸº)</div>
                                    <div class="prod-rate">${utilRate}</div>
                                    <div class="prod-stalled">ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£</div>
                                </div>
                            `;
                        }
                    }

                    // å»ºè¨­ãƒœã‚¿ãƒ³ã®ç”Ÿæˆ (ã‚³ã‚¹ãƒˆãŒã‚ã‚‹å»ºç‰©ã®ã¿)
                    if (canBuy) {
                        let buyCount = stats.buildingCountMultiplier;
                        if (buyCount === 'max') {
                            buyCount = getMaxPurchases(cost);
                        }
                        const totalCost = cost * buyCount;
                        const displayCost = buyCount > 1 ? `(${totalCost.toFixed(0)}G)` : `${cost.toFixed(0)}G`;
                        
                        const cardDiv = document.createElement('div');
                        cardDiv.className = 'building-card';
                        
                        // å»ºè¨­ãƒœã‚¿ãƒ³ã®ä½œæˆ
                        const buyButton = document.createElement('button');
                        buyButton.className = 'build-button';
                        buyButton.textContent = `å»ºè¨­ ${buyCount > 1 ? 'x' + buyCount : ''} (${displayCost})`;
                        buyButton.onclick = () => buildBuilding(type);
                        buyButton.disabled = stats.gold < totalCost || buyCount === 0;

                        // å£²å´ãƒœã‚¿ãƒ³ã®ä½œæˆ (è¦æœ›: 9, 19)
                        const sellButton = document.createElement('button');
                        sellButton.className = 'sell-building-button';
                        sellButton.textContent = `å£²å´ (${count}åŸº)`;
                        sellButton.onclick = () => sellBuilding(type);
                        sellButton.disabled = count === 0;

                        // Mineã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
                        let upgradeButton = '';
                        if (type === 'Mine' && count > 0 && stats.buildings.AdvMine.length === 0) {
                            const upgradeCost = 500 * count;
                            upgradeButton = `
                                <button class="upgrade-button" 
                                        onclick="upgradeBuilding('Mine', 'AdvMine', ${upgradeCost})"
                                        ${stats.gold < upgradeCost ? 'disabled' : ''}>
                                    å…¨${count}åŸºUG (${upgradeCost}G)
                                </button>
                            `;
                        }

                        // ã‚«ãƒ¼ãƒ‰ã®ä¸­èº«
                        cardDiv.innerHTML = `
                            <span style="font-size: 1.1em; font-weight: bold; color: #FFC107;">${spec.displayName}</span>
                            ${isMineUpgrade ? `<span style="color: #2196F3; font-size: 0.8em; margin-left: 5px;">[UGæ¸ˆ]</span>` : ''}
                            <div class="building-info">æ‰€æœ‰æ•°: <strong>${count}</strong>åŸº</div>
                            ${spec.input ? `<div class="building-info">ææ–™: ${spec.input.map(i => `${RESOURCE_NAMES[i.resource]}${i.amount}`).join(', ')}</div>` : ''}
                            ${spec.output ? `<div class="building-info">ç”Ÿç”£: ${RESOURCE_NAMES[spec.output.resource]}${spec.output.amount} / ${spec.time/10}ç§’</div>` : ''}
                            <div class="building-actions">
                                <div>${buyButton.outerHTML}</div>
                                <div>${sellButton.outerHTML}</div>
                            </div>
                            ${upgradeButton}
                        `;
                        
                        buildButtonsDiv.appendChild(cardDiv);
                    }
                }
                
                prodRateDetailsDiv.innerHTML = statusHtml || 'ç¨¼åƒä¸­ã®ç”Ÿç”£è¨­å‚™ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';

            }
            
            // 5. ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‘ãƒãƒ«ã®æ›´æ–°
            const totalAssets = stats.gold + stats.investment + stats.loan;
            const prestigeBoostLevel = stats.upgrades.prestigeBoost;
            const prestigeBoost = 1.0 + prestigeBoostLevel * 0.1; // 10% per level
            
            let prestigeGain = Math.floor(Math.log10(totalAssets / 100000) * 10) * 10 * prestigeBoost; 
            prestigeGain = Math.floor(Math.max(0, prestigeGain));

            document.getElementById('prestige-gain-display').textContent = prestigeGain;

            const prestigeButton = document.getElementById('prestige-button');
            const canPrestige = totalAssets >= 100000;
            prestigeButton.disabled = !canPrestige;
            prestigeButton.textContent = canPrestige ? `ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸å®Ÿè¡Œ (${prestigeGain} â­ç²å¾—)` : 'è³‡é‡‘ç·é¡10ä¸‡Gé”æˆã§è§£æ”¾';
            
            // 6. å®Ÿç¸¾ãƒ‘ãƒãƒ«ã®æ›´æ–° (ã‚¿ãƒ–ãŒé–‹ã„ã¦ã„ãªã„é™ã‚Šå®Ÿè¡Œã—ãªã„)
            if (document.getElementById('tab-achievement').style.display !== 'none') {
                 generateAchievementList();
                 generateRankingList();
            }

        }
        
        // --- æç”»è£œåŠ©é–¢æ•° ---

        function generateInfoList() {
            const infoList = document.getElementById('building-info-list');
            infoList.innerHTML = '';
            
            for (const type in BUILDING_SPECS) {
                const spec = BUILDING_SPECS[type];
                
                const card = document.createElement('div');
                card.className = 'info-card';
                card.style.borderLeft = `4px solid ${spec.output ? '#4CAF50' : '#2196F3'}`;
                
                let recipeHtml = '';
                if (spec.input) {
                    const inputs = spec.input.map(i => `<strong>${RESOURCE_NAMES[i.resource]} ${i.amount}</strong>`).join(' + ');
                    recipeHtml = `<p><strong>ææ–™:</strong> ${inputs}</p>`;
                } else if (spec.output) {
                    recipeHtml = `<p><strong>ææ–™:</strong> ä¸è¦ (æ¡æ˜)</p>`;
                } else {
                    recipeHtml = `<p><strong>åŠ¹æœ:</strong> ${spec.description}</p>`;
                }
                
                const outputRate = spec.output ? `${RESOURCE_NAMES[spec.output.resource]} ${spec.output.amount} / ${spec.time/10}ç§’` : 'ãªã—';

                card.innerHTML = `
                    <h4 style="margin: 0; color: #4CAF50;">${spec.displayName} (${type})</h4>
                    <p style="margin: 5px 0;">${spec.description}</p>
                    ${recipeHtml}
                    <p><strong>ç”Ÿç”£ç‰©:</strong> ${outputRate}</p>
                    <p><strong>ã‚³ã‚¹ãƒˆ:</strong> ${spec.cost}G</p>
                `;
                infoList.appendChild(card);
            }
        }
        
        function generateAchievementList() {
            const container = document.getElementById('achievement-panel-container');
            container.innerHTML = '';
            
            let achievedCount = 0;
            const totalCount = Object.keys(ACHIEVEMENT_DEFINITIONS).length;

            for (const key in ACHIEVEMENT_DEFINITIONS) {
                const def = ACHIEVEMENT_DEFINITIONS[key];
                const achieved = stats.achievements[key];
                
                if (achieved) achievedCount++;

                const itemDiv = document.createElement('div');
                itemDiv.className = `achievement-item ${achieved ? 'achieved' : 'locked'}`;
                
                itemDiv.innerHTML = `
                    <div>
                        <span style="font-size: 1.1em;">${achieved ? 'âœ…' : 'ğŸ”’'} ${def.name}</span>
                        <p style="font-size: 0.85em; color: ${achieved ? 'black' : '#aaa'}; margin: 3px 0 0 0;">${def.description}</p>
                    </div>
                    <span class="ach-status" style="color: ${achieved ? 'black' : '#888'};">${achieved ? 'é”æˆæ¸ˆã¿' : 'æœªé”æˆ'}</span>
                `;
                container.appendChild(itemDiv);
            }
            
            document.getElementById('achieved-count').textContent = achievedCount;
            document.getElementById('total-achievements').textContent = totalCount;
        }

        function generateRankingList() {
            const rankingList = document.getElementById('ranking-list');
            rankingList.innerHTML = '';
            
            const ranking = loadRanking();
            if (ranking.length === 0) {
                rankingList.innerHTML = '<li>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸å®Ÿè¡Œã§ç™»éŒ²ã•ã‚Œã¾ã™ã€‚</li>';
                return;
            }
            
            ranking.forEach((entry, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                
                const listItem = document.createElement('li');
                listItem.className = rankClass;
                listItem.innerHTML = `
                    <span>#${rank}</span>
                    <span>${entry.score.toFixed(0)} â­</span>
                    <span style="font-size: 0.8em; font-weight: normal; color: #aaa;">${entry.date}</span>
                `;
                rankingList.appendChild(listItem);
            });
        }


        // ç ”ç©¶ã®å®Ÿè¡Œ
        function researchUpgrade(key) {
            const spec = GLOBAL_UPGRADES[key];
            const currentLevel = stats.upgrades[key];
            const cost = spec.getCost(currentLevel);
            
            const researchCostReduction = (stats.upgrades.researchSpeed || 0) * 0.05; 
            const finalCost = Math.ceil(cost * (1.0 - researchCostReduction));

            if (stats.gold >= finalCost && currentLevel < spec.maxLevel) {
                stats.gold -= finalCost;
                stats.upgrades[key]++;
                showMessage(`${spec.displayName}ã‚’Lv.${stats.upgrades[key]}ã«ç ”ç©¶ã—ã¾ã—ãŸï¼ (${spec.effect(stats.upgrades[key])})`, 'cyan');
            } else {
                showMessage('ç ”ç©¶è³‡é‡‘ãŒä¸è¶³ã—ã¦ã„ã‚‹ã‹ã€æœ€å¤§ãƒ¬ãƒ™ãƒ«ã§ã™ã€‚', 'red');
            }
            updateDisplay();
        }

        // å»ºç‰©ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®å®Ÿè¡Œ
        function upgradeBuilding(oldType, newType, cost) {
            if (stats.gold >= cost) {
                stats.gold -= cost;
                
                stats.buildings[newType].push(...stats.buildings[oldType]);
                stats.buildings[oldType] = [];

                stats.buildings[newType].forEach(b => {
                    b.type = newType;
                    b.spec = BUILDING_SPECS[newType];
                });

                showMessage(`${BUILDING_SPECS[oldType].displayName} å…¨${stats.buildings[newType].length}åŸºã‚’ ${BUILDING_SPECS[newType].displayName}ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ (${cost.toFixed(0)}Gæ¶ˆè²»)`, 'purple');
            } else {
                showMessage('ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰è³‡é‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ï¼', 'red');
            }
            updateDisplay();
        }

        // å»ºç‰©ã®è³¼å…¥
        function buildBuilding(type) {
            const spec = BUILDING_SPECS[type];
            const cost = spec.cost;
            let count = stats.buildingCountMultiplier;

            if (count === 'max') {
                count = getMaxPurchases(cost);
            }

            const totalCost = cost * count;

            if (count === 0) {
                showMessage('è³¼å…¥ã§ãã‚‹å»ºç‰©ã®æ•°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'red');
                return;
            }

            if (stats.gold >= totalCost) {
                stats.gold -= totalCost;
                for (let i = 0; i < count; i++) {
                    stats.buildings[type].push(new Building(type));
                }
                
                let message = `${spec.displayName}ã‚’${count}åŸºå»ºè¨­ã—ã¾ã—ãŸï¼ (${totalCost.toFixed(0)}Gæ¶ˆè²»)`;
                if (count > 1) {
                    message += ` (1åŸºã‚ãŸã‚Š${spec.cost.toFixed(0)}G)`;
                }
                showMessage(message, 'yellow');
            } else {
                showMessage('è³‡é‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ï¼', 'red');
            }
            updateDisplay();
        }

        function sellResource(resource) {
            const amount = stats.resources[resource];
            if (amount > 0) {
                const price = getResourcePrice(resource); 
                const revenue = amount * price;
                stats.gold += revenue;
                stats.resources[resource] = 0;
                
                // å¸‚å ´å®‰å®šåŒ–ç ”ç©¶ã«ã‚ˆã‚‹å£²å´ãƒšãƒŠãƒ«ãƒ†ã‚£ã®è»½æ¸›
                const stabilityLevel = stats.upgrades.marketStability;
                const reduction = 1.0 - (stabilityLevel * 0.1); 
                
                const marketImpact = Math.min(0.2, (amount / 1000) * 0.1) * reduction; 
                stats.market.priceAdjustment[resource] -= marketImpact;

                showMessage(`åœ¨åº«ã®${amount.toFixed(0)}${RESOURCE_UNITS[resource]}ã®${RESOURCE_NAMES[resource]}ã‚’å£²å´ã—ã€${revenue.toFixed(0)}Gã‚’ç²å¾—ã—ã¾ã—ãŸã€‚`, 'lime');
            } else {
                showMessage('å£²å´ã§ãã‚‹è³‡æºãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'yellow');
            }
            updateDisplay();
        }

        function sellAllResources() {
            let totalRevenue = 0;
            let soldCount = 0;
            
            const stabilityLevel = stats.upgrades.marketStability;
            const reduction = 1.0 - (stabilityLevel * 0.1); 

            for (const resourceKey in stats.resources) {
                const amount = stats.resources[resourceKey];
                if (amount > 0) {
                    const price = getResourcePrice(resourceKey);
                    const revenue = amount * price;
                    totalRevenue += revenue;
                    stats.resources[resourceKey] = 0; 
                    soldCount++;
                    
                    const marketImpact = Math.min(0.2, (amount / 1000) * 0.1) * reduction; 
                    stats.market.priceAdjustment[resourceKey] -= marketImpact;
                }
            }

            if (totalRevenue > 0) {
                stats.gold += totalRevenue;
                showMessage(`å…¨${soldCount}ç¨®é¡ã®è³‡æºã‚’å£²å´ã—ã€åˆè¨ˆ${totalRevenue.toFixed(0)}Gã‚’ç²å¾—ã—ã¾ã—ãŸã€‚`, 'lime');
            } else {
                showMessage('å£²å´ã§ãã‚‹è³‡æºãŒä¸€ã¤ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚', 'yellow');
            }
            updateDisplay();
        }
        
        // æŠ•è³‡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        function investMoney(amountStr) {
            const amount = parseInt(amountStr);
            if (isNaN(amount) || amount <= 0) {
                showMessage('æœ‰åŠ¹ãªæŠ•è³‡é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'red');
                return;
            }
            if (stats.gold >= amount) {
                stats.gold -= amount;
                stats.investment += amount;
                showMessage(`${amount.toFixed(0)}Gã‚’å¸‚å ´ã«æŠ•è³‡ã—ã¾ã—ãŸã€‚å¸‚å ´å¤‰å‹•ã«ã‚ˆã‚‹åˆ©ç›Š/æå¤±ãŒç™ºç”Ÿã—ã¾ã™ã€‚`, 'orange');
            } else {
                showMessage('æŠ•è³‡è³‡é‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚', 'red');
            }
            updateDisplay();
        }

        function withdrawInvestment() {
            if (stats.investment > 0) {
                stats.gold += stats.investment;
                const withdrawn = stats.investment.toFixed(0);
                stats.investment = 0;
                showMessage(`æŠ•è³‡é¡${withdrawn}Gã‚’å…¨é¡å›åã—ã¾ã—ãŸã€‚`, 'orange');
            } else {
                 showMessage('å›åã§ãã‚‹æŠ•è³‡é¡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚', 'red');
            }
            updateDisplay();
        }

        // ãƒ­ãƒ¼ãƒ³å€Ÿå…¥
        function takeLoan(amount) {
            if (stats.loan > 1000000) {
                 showMessage('å€Ÿå…¥é¡ãŒå¤§ãã™ãã¾ã™ã€‚ã¾ãšã¯è¿”æ¸ˆã—ã¦ãã ã•ã„ã€‚', 'red');
                 return;
            }
            stats.gold += amount;
            stats.loan += amount;
            showMessage(`ğŸ¦ éŠ€è¡Œã‹ã‚‰${amount.toFixed(0)}Gã‚’å€Ÿå…¥ã—ã¾ã—ãŸã€‚æ¯ãƒ†ã‚£ãƒƒã‚¯åˆ©å­ãŒç™ºç”Ÿã—ã¾ã™ï¼`, 'red', 'msg-loan');
            updateDisplay();
        }
        
        // ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆ
        function repayLoan() {
            if (stats.loan <= 0) {
                showMessage('å€Ÿå…¥é¡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚', 'yellow');
                return;
            }
            if (stats.gold >= stats.loan) {
                stats.gold -= stats.loan;
                stats.loan = 0;
                showMessage('ğŸ¦ ãƒ­ãƒ¼ãƒ³ã‚’å…¨é¡è¿”æ¸ˆã—ã¾ã—ãŸï¼ã“ã‚Œã§åˆ©å­ã«æ‚©ã¾ã•ã‚Œã¾ã›ã‚“ã€‚', 'lime');
            } else {
                showMessage('è³‡é‡‘ãŒè¶³ã‚Šãšã€å…¨é¡è¿”æ¸ˆã§ãã¾ã›ã‚“ã€‚', 'red');
            }
            updateDisplay();
        }
        
        // ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ãƒªã‚»ãƒƒãƒˆ
        function prestigeReset() {
            const totalAssets = stats.gold + stats.investment + stats.loan;
            const prestigeBoostLevel = stats.upgrades.prestigeBoost;
            const prestigeBoost = 1.0 + prestigeBoostLevel * 0.1; // 10% per level
            
            let prestigeGain = Math.floor(Math.log10(totalAssets / 100000) * 10) * 10 * prestigeBoost; 
            prestigeGain = Math.floor(Math.max(0, prestigeGain));

            if (prestigeGain <= 0 || totalAssets < 100000) {
                showMessage('ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’è¡Œã†ã«ã¯ã€è³‡é‡‘ç·é¡100,000Gä»¥ä¸ŠãŒå¿…è¦ã§ã™ã€‚', 'red');
                return;
            }
            
            if (confirm(`ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿå…¨ã¦ã®é€²æ—ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã€${prestigeGain} â­ã‚’ç²å¾—ã—ã¾ã™ã€‚`)) {
                
                // â˜… NEW: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ² (è¦æœ›: 10, 20)
                saveRanking(stats.prestige_currency + prestigeGain); 
                
                const initialStats = { // åˆæœŸçŠ¶æ…‹ã‚’å®šç¾©
                    gold: 1000, investment: 0, loan: 0, tick: 0, buildingCountMultiplier: 1, 
                    resources: { ore: 0, copper_ore: 0, coal_ore: 0, alum_ore: 0, silicon_ore: 0, titan_ore: 0, iron: 0, copper_wire: 0, steel_copper: 0, alum: 0, wafer: 0, alloy: 0, },
                    buildings: { Mine: [], CopperMine: [], CoalMine: [], AluminumMine: [], SiliconMine: [], TitaniumMine: [], Smelter: [], WireMill: [], SteelMill: [], AdvancedSmelter: [], AluminumSmelter: [], WaferFab: [], AlloyForge: [], AdvMine: [], AutoTransporter: [], Warehouse: [], TradePost: [], ContractOffice: [], },
                    upgrades: { productionEfficiency: 0, warehouseCapacity: 0, marketStability: 0, prestigeBoost: 0, autoSellEfficiency: 0, loanInterestMitigation: 0, researchSpeed: 0, advancedMaterials: 0, }, // å…¨ã¦ãƒªã‚»ãƒƒãƒˆ
                    market: { priceAdjustment: { ore: 0, copper_ore: 0, coal_ore: 0, alum_ore: 0, silicon_ore: 0, titan_ore: 0, iron: 0, copper_wire: 0, steel_copper: 0, alum: 0, wafer: 0, alloy: 0, }, marketFluctuation: 1.0, },
                    achievements: { first_build: false, max_1k_gold: false, max_10k_gold: false, max_100k_gold: false, iron_master: false, wafer_creator: false, all_mines: false, adv_mine_upgrade: false }
                };
                
                // ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸é€šè²¨ã®åŠ ç®—
                stats.prestige_currency += prestigeGain;
                
                // ãƒªã‚»ãƒƒãƒˆ
                // stats.prestige_currencyä»¥å¤–ã®éƒ¨åˆ†ã‚’ãƒªã‚»ãƒƒãƒˆ
                stats = {...stats, ...initialStats, prestige_currency: stats.prestige_currency}; 
                
                showMessage(`â­ ãƒ—ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚¸å®Œäº†ï¼${prestigeGain} â­ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚ã‚²ãƒ¼ãƒ ãŒæœ€åˆã‹ã‚‰å†é–‹ã•ã‚Œã¾ã™ã€‚`, 'cyan');
                switchTab('build');
                updateDisplay(BASE_STOCK_LIMIT);
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½
        function showMessage(text, color, className = '') {
            const messageArea = document.getElementById('message-area');
            messageArea.textContent = text;
            messageArea.style.color = color;
            messageArea.className = ''; 
            if (className) {
                messageArea.classList.add(className);
            } else {
                messageArea.style.backgroundColor = '#282828'; 
                messageArea.style.color = color;
            }
        }


        // --- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ---
        
        switchTab('build'); 

        function gameLoop() {
            updateGame();
            
            setTimeout(gameLoop, TICK_RATE_MS); 
        }

        // --- åˆæœŸåŒ– ---
        updateDisplay(BASE_STOCK_LIMIT);
        gameLoop(); 
    </script>
</body>
</html>
