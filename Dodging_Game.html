<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>純粋な弾幕回避ゲーム</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { 
            background: #2a2a2a; 
            color: white; 
            text-align: center; 
            font-family: sans-serif; 
            margin: 0; 
            padding-top: 20px; 
            padding-bottom: 50px; 
            overflow-y: auto;
        }
        h1 {
            color: #ff9800; 
            margin-bottom: 20px;
        }
        #NewGameArea {
            max-width: 600px; 
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #444;
            border-radius: 8px;
            background: #1e1e1e;
        }
        #NewGameCanvas {
            /* 画面サイズは500x650のまま */
            background: #00001a;
            border: 2px solid #ff9800;
            display: block;
            margin: 20px auto;
            cursor: pointer; 
            touch-action: none; 
        }
        /* 削除された .back-button のスタイルは不要 */
        .home-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #FF9800; /* オレンジ */
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
            display: none; /* 初期は非表示 */
        }
    </style>
</head>
<body>
    <div id="NewGameArea">
        <h1>純粋な弾幕回避ゲーム (精密回避)</h1>
        <canvas id="NewGameCanvas" width="500" height="650"></canvas>
        <div id="control-info">
            キー: **WASD** or **矢印**で移動 / **Shift**で精密移動 / **マウス/タッチ**でドラッグ移動
        </div>
        <button id="homeButton" class="home-button" onclick="location.href='Game_Portal.html'">
            ホームへ戻る
        </button>
    </div>
    
    <script>
        // --- 変数定義 ---
        const canvas = document.getElementById('NewGameCanvas');
        const ctx = canvas.getContext('2d');
        const homeButton = document.getElementById('homeButton'); // 追加

        const WIDTH = canvas.width;
        const HEIGHT = canvas.height;
        let gameLoopId;
        const FPS = 60;

        let isGameOver = false;
        let gameTime = 0; // 生存時間（フレーム数）
        let gameStartTime = 0; // ゲーム開始時のタイムスタンプ

        const keys = {};

        // --- プレイヤーオブジェクト ---
        const player = {
            x: WIDTH / 2 - 10,
            y: HEIGHT - 50,
            width: 20,
            height: 20,
            speed: 4,
            focusSpeed: 1.5,
            color: 'white',
            hitboxRadius: 3, // 精密な当たり判定
            invincible: false,
            invincibleTime: 0,
            getCenter: function() {
                return { x: this.x + this.width / 2, y: this.y + this.height / 2 };
            }
        };

        let enemyBullets = [];
        let score = 0; // 生存秒数をスコアとする

        // --- ゲーム初期化 ---
        function initGame() {
            isGameOver = false;
            enemyBullets = [];
            gameTime = 0;
            score = 0;
            gameStartTime = Date.now();
            
            // プレイヤー位置をリセット
            player.x = WIDTH / 2 - 10;
            player.y = HEIGHT - 50;
            
            // 初期状態に戻す
            homeButton.style.display = 'none';

            if(gameLoopId) cancelAnimationFrame(gameLoopId);
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        // --- クラス定義 (Bullet) ---
        class EnemyBullet {
            constructor(x, y, radius, speed, angle, color) {
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.speed = speed;
                this.angle = angle;
                this.color = color;
                this.isAlive = true;
                this.vx = speed * Math.cos(angle);
                this.vy = speed * Math.sin(angle);
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                
                // 画面外に出たら消滅
                if (this.x < -20 || this.x > WIDTH + 20 || this.y < -20 || this.y > HEIGHT + 20) {
                    this.isAlive = false;
                }
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
            }
        }

        // --- 弾生成パターン (Spawner) ---
        let spawnerLastTime = 0;
        const SPWAN_INTERVAL = 1000;
        
        function updateSpawner() {
            const currentTime = Date.now();
            if (currentTime - spawnerLastTime > SPWAN_INTERVAL) {
                // 難易度に応じて弾の速度を調整
                const baseSpeed = 2;
                const speedMultiplier = 1 + gameTime / 6000; 

                // 拡散弾 (扇形)
                if (Math.random() < 0.5) {
                    const startAngle = Math.PI / 4;
                    const endAngle = 3 * Math.PI / 4;
                    const numBullets = 15;
                    const center = WIDTH * Math.random();
                    
                    for(let i = 0; i < numBullets; i++) {
                        const angle = startAngle + (endAngle - startAngle) * (i / (numBullets - 1));
                        enemyBullets.push(new EnemyBullet(
                            center, 0, 5, baseSpeed * speedMultiplier, angle, 'cyan'
                        ));
                    }
                } 
                // 渦巻き弾
                else {
                    const center = { x: WIDTH / 2, y: HEIGHT / 2 };
                    const num = 10;
                    const offset = gameTime * 0.0001; 
                    for(let i = 0; i < num; i++) {
                        const angle = (2 * Math.PI / num) * i + offset;
                        enemyBullets.push(new EnemyBullet(
                            center.x, 0, 4, baseSpeed * 1.5 * speedMultiplier, angle, 'magenta'
                        ));
                    }
                }
                
                spawnerLastTime = currentTime;
            }
        }


        // --- 描画関数 ---

        function drawPlayer() {
            if (isGameOver) return;
            
            // プレイヤー本体 (回避ゲームなので小さく)
            ctx.fillStyle = player.color;
            ctx.fillRect(player.x, player.y, player.width, player.height);

            // ヒットボックスの表示 (常時表示)
            ctx.beginPath();
            ctx.arc(player.getCenter().x, player.getCenter().y, player.hitboxRadius, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255, 255, 0, 0.7)'; // 黄色の半透明
            ctx.fill();
        }
        
        function drawHUD() {
            // 生存時間をスコアとして表示
            score = Math.floor((Date.now() - gameStartTime) / 100) / 10; // 0.1秒単位
            
            ctx.fillStyle = '#ff9800';
            ctx.font = '24px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('TIME: ' + score.toFixed(1) + 's', 10, 30);
        }

        function drawGameOver() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, WIDTH, HEIGHT);
            ctx.fillStyle = 'red';
            ctx.font = '48px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('GAME OVER', WIDTH / 2, HEIGHT / 2 - 20);
            ctx.font = '24px Arial';
            ctx.fillStyle = 'white';
            ctx.fillText('Survival Time: ' + score.toFixed(1) + 's', WIDTH / 2, HEIGHT / 2 + 30);

            homeButton.style.display = 'block'; // ホームボタン表示
        }
        
        function draw() {
            ctx.fillStyle = '#00001a';
            ctx.fillRect(0, 0, WIDTH, HEIGHT);

            enemyBullets.forEach(b => b.draw());
            drawPlayer();
            drawHUD();

            if (isGameOver) {
                drawGameOver();
            }
        }

        // --- 更新関数 ---
        
        function updatePlayer() {
            if (isGameOver) return;
            
            // 精密移動 (Shiftキーが押されているか、タッチドラッグ中は自動でON)
            let currentSpeed = keys['Shift'] ? player.focusSpeed : player.speed;

            if (keys['ArrowLeft'] || keys['a']) player.x -= currentSpeed;
            if (keys['ArrowRight'] || keys['d']) player.x += currentSpeed;
            if (keys['ArrowUp'] || keys['w']) player.y -= currentSpeed;
            if (keys['ArrowDown'] || keys['s']) player.y += currentSpeed;

            // 境界チェック
            player.x = Math.max(0, Math.min(player.x, WIDTH - player.width));
            player.y = Math.max(0, Math.min(player.y, HEIGHT - player.height));
            
            gameTime++;
        }

        function updateCollisions() {
            // 敵弾 vs プレイヤー
            const playerHitbox = {
                x: player.getCenter().x - player.hitboxRadius,
                y: player.getCenter().y - player.hitboxRadius,
                width: player.hitboxRadius * 2,
                height: player.hitboxRadius * 2
            };
            
            for(let i = enemyBullets.length - 1; i >= 0; i--) {
                const eb = enemyBullets[i];
                const bulletHitbox = {
                    x: eb.x - eb.radius,
                    y: eb.y - eb.radius,
                    width: eb.radius * 2,
                    height: eb.radius * 2
                };
                
                // 簡易矩形判定（高速化のため）
                if (checkCollision(bulletHitbox, playerHitbox)) {
                    // 円形判定（より正確に）
                    const distSq = (eb.x - player.getCenter().x)**2 + (eb.y - player.getCenter().y)**2;
                    const minDist = eb.radius + player.hitboxRadius;
                    
                    if (distSq < minDist**2) {
                        isGameOver = true;
                        homeButton.style.display = 'block'; // ホームボタン表示
                        return; // ゲームオーバーなので終了
                    }
                }
            }
        }
        
        // 矩形衝突判定
        function checkCollision(r1, r2) {
            return r1.x < r2.x + r2.width &&
                   r1.x + r1.width > r2.x &&
                   r1.y < r2.y + r2.height &&
                   r1.y + r1.height > r2.y;
        }

        function updateGame() {
            if (isGameOver) return;

            updatePlayer();
            updateSpawner();
            
            // 弾の更新
            enemyBullets.forEach(b => b.update());

            // 衝突判定
            updateCollisions();

            // 弾の除去
            enemyBullets = enemyBullets.filter(b => b.isAlive);
        }
        
        // --- ゲームループ ---
        function gameLoop() {
            updateGame();
            draw();

            if (!isGameOver) {
                gameLoopId = requestAnimationFrame(gameLoop);
            }
        }
        
        // --- イベントリスナー ---
        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            keys[key] = true;
            if (['w', 'a', 's', 'd', 'arrowup', 'arrowdown', 'arrowleft', 'arrowright', 'shift'].includes(key)) {
                e.preventDefault();
            }
            if (key === 'r' && isGameOver) {
                initGame();
            }
        });
        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });


        // タッチ操作関連 (元のコードより)
        let isDragging = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        function getCanvasMousePosition(event) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            if (event.touches) {
                clientX = event.touches[0].clientX;
                clientY = event.touches[0].clientY;
            } else {
                clientX = event.clientX;
                clientY = event.clientY;
            }
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function handleDragStart(event) {
            if (isGameOver) return;
            const pos = getCanvasMousePosition(event);
            
            let dragOffsetX = pos.x - player.getCenter().x;
            let dragOffsetY = pos.y - player.getCenter().y;
            
            isDragging = true;
            // タッチ操作でもキー操作による低速移動を擬似的にオンに
            keys['Shift'] = true; 
            event.preventDefault(); 
        }

        function handleDragMove(event) {
            if (!isDragging || isGameOver) return;
            const pos = getCanvasMousePosition(event);
            
            let newX = pos.x - dragOffsetX - player.width / 2;
            let newY = pos.y - dragOffsetY - player.height / 2;

            newX = Math.max(0, Math.min(newX, WIDTH - player.width));
            newY = Math.max(0, Math.min(newY, HEIGHT - player.height));
            
            player.x = newX;
            player.y = newY;
            
            event.preventDefault(); 
        }

        function handleDragEnd() {
            isDragging = false;
            // タッチ操作による低速移動を擬似的にオフに
            keys['Shift'] = false; 
        }

        // PC向けマウスイベント
        canvas.addEventListener('mousedown', handleDragStart);
        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('mouseup', handleDragEnd);

        // スマホ/タブレット向けタッチイベント
        canvas.addEventListener('touchstart', handleDragStart);
        canvas.addEventListener('touchmove', handleDragMove, { passive: false });
        document.addEventListener('touchend', handleDragEnd);

        // --- 初期化 ---
        initGame();

    </script>
</body>
</html>
